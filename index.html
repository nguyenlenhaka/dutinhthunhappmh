<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Báo cáo Cá nhân – Vùng Hằng Lâm</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- DÙNG ĐÚNG FONT TỪ THƯ MỤC fonts -->
  <link rel="stylesheet" href="./fonts/fonts.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --sidebar-width: 260px;
      --header-h: 64px;
      --fixed-top: 64px;
      --toc-h: 0px;

      /* ==== ĐIỀU CHỈNH WEIGHT CHO KHỚP fonts.css ==== */
      --w-title: 700;   /* 700 nếu chỉ có Bold; nếu có ExtraBold/Black => 800/900 */
      --w-section: 700; /* weight cho tiêu đề section A/B/C/Thông tin/Tính thu nhập */
      --w-menu: 700;    /* weight cho menu & submenu */

      --ml-font: 'Manulife JH Sans', 'ManulifeJHSans',
                 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    *{ box-sizing: border-box; }
    body{ background:#f3f4f6; }
    html, body{ font-size:17px; }
    .sticky-header{ position: sticky; top: 0; z-index: 40; background:#e8fff3; overflow:hidden; }

    /* màu & nhấn */
    b,strong,.val,.hl{ color:#10b981; }
    .label{ font-weight:700; color:#0b3d2c; }
    .val{ font-weight:900; }
    .thin{ font-weight:700; color:#0b3d2c; }
    .hide{ display:none; }
    /* ép ẩn tuyệt đối khi xung đột specificity (vd: #loginForm) */
    .hidden{ display:none !important; }

    /* ===== HEADER ===== */
    .header-grid{
      display:grid;
      grid-template-columns: var(--sidebar-width) 1fr max-content; /* logo | title | login */
      grid-template-areas: "logo title login";
      align-items:center; gap:.75rem;
    }
    .logo-cell{ grid-area:logo; }
    .logo-d{ height:100px; margin-left:20px; }
    .logo-m{ display:none; }

    .title-cell{ grid-area:title; min-width:0; }
    .title-top, .title-main{
      font-family: var(--ml-font);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .title-top{
      font-weight: var(--w-title); letter-spacing:.5px; color:#059669;
      font-size:1.55rem; line-height:1.1; text-transform:uppercase;
    }
    .title-main{
      font-weight: var(--w-title); color:#059669;
      font-size:3.2rem; line-height:1; margin-top:.25rem;
    }

    /* Cụm đăng nhập – desktop */
    #loginForm{
      grid-area:login;
      justify-self:end;
      width:440px; max-width:100%;
      display:grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      grid-template-areas:
        "msdl msdl"
        "date btn";
      gap:.5rem; align-items:center;
    }
    #msdlInput{ grid-area:msdl; }
    #dateInput{ grid-area:date; }
    .login-btn{ grid-area:btn; height:44px; padding:0 18px; }

    /* ===== Nút ĐĂNG XUẤT thay form sau khi login ===== */
    #logoutBtn{
      grid-area:login;
      justify-self:end;
      height:44px; padding:0 18px;
      display:none; /* sẽ hiện bằng JS */
    }

    /* ===== SIDEBAR (desktop, chỉ hiện sau login) ===== */
    #sidebar{
      width:var(--sidebar-width);
      position:fixed; top:var(--fixed-top); left:0; bottom:0;
      overflow:auto; z-index:35; background:#fff;
      border-right:1px solid #e5e7eb; border-top-right-radius:12px;
      display:none; /* ẩn đến khi đăng nhập */
    }
    .sidebar-inner{ padding:12px; }
    .menu-item,.menu-head{
      display:block; font-weight: var(--w-menu); color:#0b3d2c; font-family:var(--ml-font);
    }
    .menu-item{ padding:.5rem .75rem; border-radius:.5rem; }
    .menu-item:hover{ background:#e5f7ee; }
    .menu-item.active{ background:#0ea35b; color:#fff; }
    .menu-head{ padding:.5rem .75rem; }
    .submenu{ margin:.25rem 0 .5rem .75rem; }
    .submenu a{ display:block; padding:.35rem .5rem; border-radius:.375rem; color:#0b3d2c; font-weight:var(--w-menu); }
    .submenu a:hover{ background:#edfdf6; }
    .submenu a.active{ background:#0ea35b; color:#fff; }

    /* CONTENT chừa sidebar */
    #contentWrap{ margin-left: var(--sidebar-width); }

    /* TOC mobile (ẩn đến khi login) */
    .toc-mobile{ position:sticky; top:calc(var(--header-h)); z-index:30; background:#fff; padding:8px 0; display:none; }

    /* SECTION */
    .section-title{
      font-family: var(--ml-font);
      font-weight: var(--w-section); color:#0b3d2c; background:#fff;
      padding:10px 16px; border-left:6px solid #0ea35b;
      border-radius:.5rem; margin:18px 0 12px; font-size:1.25rem;
    }
    .subsec{
      margin:12px 0 10px; font-weight: var(--w-section); color:#0b3d2c;
      padding-left:.75rem; border-left:6px solid #0ea35b; font-size:1.15rem;
    }
    .section{ scroll-margin-top: calc(var(--header-h) + 8px); }

    /* INFO GRID */
    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:.85rem; }
    .info-item{
      display:flex; flex-direction:column; gap:.3rem;
      background:#fff; border:1px solid #e5e7eb; border-left:4px solid #0ea35b;
      border-radius:.6rem; padding:.7rem .85rem;
    }
    .info-item .val{ font-size:1.15rem; line-height:1.25; word-break:break-word; }

    /* Cảnh báo Pro */
    .pro-alert{
      margin-top:.4rem; padding:.7rem .9rem;
      border:2px solid #dc2626; border-left-width:6px; border-radius:.6rem;
      background:#fff; color:#b91c1c; font-weight:900; font-size:1.15rem;
    }
    .info-alert{ grid-column:1 / -1; }

    /* list label|value */
    .list-dot li, .bullet-strong li{
      list-style:none; padding-left:0;
      display:grid; grid-template-columns:minmax(170px,max-content) 1fr;
      column-gap:1rem; align-items:start; margin:.3rem 0;
    }
    .bullet-strong li{ border-left:3px solid #0ea35b; padding-left:.75rem; }
    .hl{ grid-column:2; font-weight:900; font-size:1.05rem; line-height:1.3; }

    /* thụt dòng trực quan */
    .lvl-2{ margin-left:1.25rem; padding-left:.75rem; border-left:3px solid #a7f3d0; border-radius:.25rem; }
    .lvl-3{ margin-left:2.25rem; padding-left:.75rem; border-left:2px dashed #c7f9e9; border-radius:.25rem; }
    .lvl-4{ margin-left:3.25rem; padding-left:.75rem; border-left:2px dotted #def7ef; border-radius:.25rem; }

    /* ===== NÚT HỖ TRỢ ===== */
    .help-fab{
      position:fixed; right:16px; bottom:16px; z-index:60;
      padding:.6rem .9rem; border-radius:9999px; border:1px solid #065f46;
      background:#059669; color:#fff; font-weight:700; box-shadow:0 10px 15px rgba(0,0,0,.1);
      display:none; /* hiện bằng JS khi đăng nhập & ở desktop */
    }
    .help-fab:hover{ background:#047857; }

    /* ===== MOBILE ===== */
    @media (max-width:1023px){ #contentWrap{ margin-left:0; } }
    @media (max-width:640px){
      .header-grid{
        grid-template-columns: auto 1fr;
        grid-template-areas: "logo title" "login login";
        align-items:flex-start;
      }
      .logo-d{ display:none; }
      .logo-m{ display:block; height:56px; margin-left:8px; }
      .title-cell{ text-align:center; padding-top:.25rem; }
      .title-top{ font-size:1.25rem; }
      .title-main{ font-size:2.25rem; line-height:}

      /* form mobile: 2 input cùng hàng, nút xuống dòng riêng */
      #loginForm{
        justify-self:stretch; width:100%;
        grid-template-columns: minmax(0,1fr) minmax(0,1fr);
        grid-template-rows: auto auto;
        grid-template-areas:
          "msdl date"
          "btn  btn";
      }
      .login-btn{ height:46px; justify-self:stretch; }
      #logoutBtn{ height:46px; justify-self:stretch; }
      .section-title{ position:sticky; top:calc(var(--header-h) + var(--toc-h) + 6px); z-index:20; background:#fff; }
      .section{ scroll-margin-top: calc(var(--header-h) + var(--toc-h) + 10px); }
    }
    /* KHÔNG cắt theo trục dọc để giữ dấu tiếng Việt */
.title-top,
.title-main{
  overflow-x: hidden;   /* vẫn cho phép ellipsis ngang */
  overflow-y: visible;  /* không cắt theo dọc -> không mất dấu */
  white-space: nowrap;
  text-overflow: ellipsis;
    /* nới nhẹ cho an toàn (có thể 1.18–1.25) */
}

/* Nếu từng set chung overflow cho header, đừng để nó che dọc */
.sticky-header{ overflow: visible; }
/* KHÔNG cắt theo trục dọc, chỉ ẩn tràn ngang để có ellipsis */
.title-top,
.title-main{
  overflow-x: hidden;
  overflow-y: visible;
  white-space: nowrap;
  text-overflow: ellipsis;
}

/* Nới line-height riêng cho dòng "CỔNG THÔNG TIN..." */
.title-top, .title-main{
  line-height: 1.25 !important;  /* 1.30–1.40 tùy bạn, miễn không cắt dấu */
  padding-top: 2px;               /* nới nhẹ đầu trên */
  padding-bottom: 2px;            /* nới nhẹ đầu dưới */
}

/* Chắc chắn cha không chặn dọc */
.title-cell,
.sticky-header{
  overflow: visible !important;
}

  </style>
</head>
<body class="min-h-screen font-sans">
  <!-- ===== HEADER ===== -->
  <header id="pageHeader" class="sticky-header shadow">
    <div class="header-grid px-2 md:px-3 py-10">
      <!-- Logo -->
      <div class="logo-cell flex items-center">
        &#160;<img src="logo.webp" alt="logo" class="logo-d">
        <img src="logo.webp" alt="logo" class="logo-m">
      </div>

      <!-- Tiêu đề 2 dòng (auto-fit mobile, không xuống dòng) -->
      <div class="title-cell">
        <div id="tTop"  class="title-top">CỔNG THÔNG TIN VÙNG HẰNG LÂM</div>
        <div id="tMain" class="title-main">BÁO CÁO CÁ NHÂN</div>
      </div>

      <!-- Đăng nhập -->
      <form id="loginForm">
        <input id="msdlInput" class="border rounded px-3 py-2" placeholder="Nhập MSĐL" required />
        <input id="dateInput" class="border rounded px-3 py-2" placeholder="Ngày gia nhập (dd/mm/yyyy hoặc ddmmyyyy)" required />
        <button class="login-btn bg-emerald-700 text-white rounded font-semibold hover:bg-emerald-800 transition" type="submit">Đăng nhập</button>
      </form>
      <!-- Đăng xuất (hiện sau khi đăng nhập) -->
      <button id="logoutBtn" class="bg-emerald-700 text-white rounded font-semibold hover:bg-emerald-800 transition">Đăng xuất</button>
    </div>
  </header>

  <!-- ===== SIDEBAR (desktop, chỉ hiện sau login) ===== -->
  <aside id="sidebar">
    <div class="sidebar-inner"><nav id="nav"></nav></div>
  </aside>

  <!-- ===== CONTENT ===== -->
  <div id="contentWrap">
    <main class="max-w-6xl mx-auto px-3 md:px-4 py-5">
      <div id="errorMsg" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-2 mb-4 rounded"></div>

      <!-- TOC mobile (ẩn đến khi login) -->
      <div id="tocMobile" class="toc-mobile">
        <button id="helpBtnMobile" class="w-full mb-2 bg-emerald-700 text-white rounded font-semibold hover:bg-emerald-800 transition px-3 py-2">Hỗ trợ</button>
        <select id="tocSelect" class="w-full border rounded px-3 py-2">
          <option value="" selected disabled>Danh mục báo cáo</option>
          <option value="sectionInfo">Thông tin đại lý</option>
          <option value="sectionA">A. Tổng quan (MTD)</option>
          <option value="sectionB#b1">B.1 Bán hàng</option>
          <option value="sectionB#b2">B.2 Manulife Pro</option>
          <option value="sectionB#b3">B.3 MDRT+</option>
          <option value="sectionB#b4">B.4 M-Star / Japan</option>
          <option value="sectionB#b5">B.5 Thưởng năm</option>
          <option value="sectionC#c1">C.1 Tuyển dụng</option>
          <option value="sectionC#c2">C.2 Thăng cấp</option>
          <option value="sectionC#c3">C.3 Duy trì chức danh</option>
          <option value="sectionC#c4">C.4 MBA Pro</option>
          <option value="sectionC#c5">C.5 Thưởng nhóm ưu tú</option>
          <option value="sectionIncome">Tính thu nhập</option>
        </select>
      </div>

      <section id="report" class="bg-white shadow rounded-xl p-4 md:p-6 mt-0 hidden"></section>
      <div id="hint" class="mt-6 text-center text-gray-500 text-sm">Nhập thông tin để xem báo cáo đại lý</div>
    </main>
  </div>

  <!-- Nút hỗ trợ nổi (desktop) -->
  <button id="helpBtnDesktop" class="help-fab" aria-label="Hỗ trợ">Hỗ trợ</button>

  <script>
    /* ===== STATE ===== */
    let dataRows = [];
    let mapping = [];
    let dataReady;
    let loggedIn = false;

    /* ===== LOAD DATA ===== */
    async function loadData(){
      const mapUrl = encodeURI('tham chieu.json');
      const dataUrl = 'data.json';
      const [mapS, dataS] = await Promise.allSettled([
        fetch(mapUrl).then(r => r.ok ? r.json() : []),
        fetch(dataUrl).then(r => r.ok ? r.json() : [])
      ]);
      mapping = (mapS.status === 'fulfilled' && Array.isArray(mapS.value)) ? mapS.value : [];
      dataRows = (dataS.status === 'fulfilled' && Array.isArray(dataS.value)) ? dataS.value : [];
    }
    dataReady = loadData();

    /* ===== DOM ===== */
    const errorEl   = document.getElementById('errorMsg');
    const reportEl  = document.getElementById('report');
    const hintEl    = document.getElementById('hint');
    const tocMbEl   = document.getElementById('tocMobile');
    const sidebarEl = document.getElementById('sidebar');
    const navEl     = document.getElementById('nav');
    const headerEl  = document.getElementById('pageHeader');
    const tTopEl    = document.getElementById('tTop');
    const tMainEl   = document.getElementById('tMain');
    const logoutBtn = document.getElementById('logoutBtn');
    const helpDeskEl= document.getElementById('helpBtnDesktop');
    const helpMobEl = document.getElementById('helpBtnMobile');

    function isMobile(){ return window.matchMedia('(max-width: 640px)').matches; }

    /* ===== Title auto-fit (mobile không xuống dòng) ===== */
    function fitText(el, maxPx, minPx){
      if(!el) return;
      const container = el.parentElement;
      el.style.whiteSpace = 'nowrap';
      let size = maxPx;
      el.style.fontSize = size + 'px';
      const maxWidth = container.clientWidth - 4;
      while (size > minPx && el.scrollWidth > maxWidth){
        size -= 1;
        el.style.fontSize = size + 'px';
      }
    }
    function fitTitles(){
      if (isMobile()){
        fitText(tTopEl, 24, 12);
        fitText(tMainEl, 36, 18);
      } else {
        tTopEl.style.fontSize = '1.55rem';
        tMainEl.style.fontSize = '3.2rem';
      }
    }

    /* ===== UTIL ===== */
    function normalizeDate(s){
      if(!s) return '';
      s = String(s).trim();
      if (/^\d{8}$/.test(s)) { const d=s.slice(0,2), m=s.slice(2,4), y=s.slice(4,8); return `${d}/${m}/${y}`; }
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) { const [d,m,y]=s.split('/').map(x=>parseInt(x,10)); return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`; }
      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)) { const [y,m,d]=s.split('-').map(x=>parseInt(x,10)); return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`; }
      return s;
    }
    function normalizeMSDL(s){ return String(s||'').trim().replace(/\s+/g,'').toLowerCase(); }

    function parseLocaleNumber(v){
      if (v===null||v===undefined||v==='') return NaN;
      if (typeof v==='number') return v;
      let s = String(v).trim().replace(/[^0-9,.\-]/g,'');
      if (s===''||s==='-'||s==='.'||s===',') return NaN;
      const hasDot=s.includes('.'), hasComma=s.includes(',');
      if (hasDot&&hasComma){
        if (s.lastIndexOf(',')>s.lastIndexOf('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
        else { s=s.replace(/,/g,''); }
      } else if (hasComma&&!hasDot){ s=s.replace(',', '.'); }
      const n=parseFloat(s); return isNaN(n)?NaN:n;
    }
    function formatThousand(n,dec){
      if (n===null||n===undefined||isNaN(n)) return "";
      const fixed = Number(n).toFixed(dec);
      let [intPart, frac=""] = fixed.split('.');
      const sign = intPart.startsWith('-')?'-':'';
      intPart = intPart.replace('-','').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
      return sign + intPart + (dec>0?','+frac:"");
    }
    function formatF3(val){ const n=parseLocaleNumber(val); if(isNaN(n)) return val??""; return formatThousand(n,3); }
    function formatNumber(val){ return (val ?? ""); }

    /* === BỔ SUNG: ép định dạng 000.000,000 cho danh sách nhãn yêu cầu === */
    // Chuẩn hoá nhãn để so khớp ổn định (không dấu, lowercase, gọn khoảng trắng)
    function normalizeLabel(label=""){
      return String(label||"")
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ').trim();
    }

    // Danh sách NHÃN cần ép định dạng 000.000,000 (F3)
    const FORCE_F3_LABELS = new Set([
      'Doanh thu FYP thực cấp',
      'Tổng doanh thu FYP',
      'FYP phát sinh tính thưởng',
      'Mức thưởng tạm đạt',
      'Cần thêm để đạt mức thưởng tiếp theo',
      'Mức thưởng tiếp theo',
      'FYP cần thêm để thăng hạng',
      'FYP thực đạt (YTD)',
      'FYP cần thêm để đạt tiến độ quý hiện tại',
      'FYP cần thêm để đạt danh hiệu MDRT+',
      'FYP phát sinh trong thời gian thi đua',
      'Tổng FYP cần thêm để đạt thi đua',
      'Tổng FYP phát sinh (YTD)',
      'FYC Whole team L6M sau luật 50% cần thêm',
      'fYP Whole team L6M sau luật 50% cần thêm',
      'FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%',
      'FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%',
      'Tổng FYP phát sinh trong tháng của bản thân UM+ (A)',
      'FYP của bản thân UM+ (A) và nhóm trực tiếp sau luật 50%',
      'FYP của bản thân UM+ (B) báo cáo trực tiếp cho UM+ (A)',
      'Tổng FYP sau luật 50% dùng để tính thưởng (cấp UM)',
      'Tổng FYP WT trước luật 50% (cấp SUM+)',
      'Tổng FYP WT sau luật 50% để tính thưởng (cấp SUM+)',
      'Thưởng dự tính sau khi đã nhân hệ số TLDTHD'
    ].map(normalizeLabel));

    // Quyết định có ép F3 không: nếu thuộc danh sách trên, hoặc chứa "fyp"/"fyc" (hành vi cũ)
    function shouldF3Label(label=""){
      const norm = normalizeLabel(label);
      if (FORCE_F3_LABELS.has(norm)) return true;
      return (norm.includes('fyp') || norm.includes('fyc'));
    }

    function fmt(val,key="",label=""){ return shouldF3Label(label)?formatF3(val):(val??""); }
    function addPercent(val){ return (val ?? ""); }
    function exists(v){ return !(v===null||v===undefined||(typeof v==='string'&&v.trim()==='')); }
    function pick(row,keys){ for (const k of keys) if (exists(row[k])) return row[k]; return ''; }

    function showError(msg){ errorEl.textContent=msg; errorEl.classList.remove('hidden'); }
    function hideErrors(){ errorEl.classList.add('hidden'); }

    function getHeaderH(){ return headerEl?.offsetHeight || 64; }
    function getTocH(){ return (tocMbEl && getComputedStyle(tocMbEl).display!=='none') ? tocMbEl.offsetHeight : 0; }
    function updateLayoutVars(){ const r=document.documentElement; r.style.setProperty('--header-h', getHeaderH()+'px'); r.style.setProperty('--fixed-top', getHeaderH()+'px'); r.style.setProperty('--toc-h', getTocH()+'px'); }

    function toggleNavByViewport(){
      if (!loggedIn){ 
        tocMbEl.style.display='none'; sidebarEl.style.display='none';
        if (helpDeskEl) helpDeskEl.style.display='none';
        if (helpMobEl) helpMobEl.style.display='none';
        return; 
      }
      if (window.matchMedia('(min-width: 1024px)').matches){
        sidebarEl.style.display='block'; tocMbEl.style.display='none';
        if (helpDeskEl) helpDeskEl.style.display='inline-flex';
        if (helpMobEl) helpMobEl.style.display='none';
      } else {
        sidebarEl.style.display='none'; tocMbEl.style.display='block';
        if (helpDeskEl) helpDeskEl.style.display='none';
        if (helpMobEl) helpMobEl.style.display='block';
      }
      updateLayoutVars();
    }

    function scrollToSectionStart(sectionId){
      const section=document.getElementById(sectionId); if(!section) return;
      const y = section.getBoundingClientRect().top + window.scrollY - (isMobile()? (getHeaderH()+getTocH()+10):(getHeaderH()+8));
      window.scrollTo({ top:y, behavior:'smooth' });
    }

    /* ===== LOGIN ===== */
    const loginForm = document.getElementById('loginForm');
    const msdlInput = document.getElementById('msdlInput');
    const dateInput = document.getElementById('dateInput');
    const loginBtn  = loginForm.querySelector('button');

    // chặn nhấn trước khi tải xong dữ liệu
    loginBtn.disabled = true; loginBtn.textContent = 'Đang tải dữ liệu...';
    dataReady.finally(()=>{ loginBtn.disabled=false; loginBtn.textContent='Đăng nhập'; });

    let lastMsdl="", lastJoin="";

    loginForm.onsubmit = async (e)=>{
      e.preventDefault();
      hideErrors();
      await dataReady;

      if (!Array.isArray(dataRows) || dataRows.length===0){
        showError("Không tải được dữ liệu. Hãy kiểm tra data.json.");
        return;
      }

      const msdlNorm = normalizeMSDL(msdlInput.value);
      const dateNorm = normalizeDate(dateInput.value);

      const msdlCols = ["MSDL","AGEN CODE","AGENT CODE","Agent Code","Mã Số Đại Lý","MÃ SỐ ĐẠI LÝ"];
      const joinCols = ["JOIN DATE","Join Date","NGÀY GIA NHẬP","Ngày gia nhập"];

      const row = dataRows.find(r => normalizeMSDL(pick(r,msdlCols))===msdlNorm &&
                                     normalizeDate(pick(r,joinCols))===dateNorm);

      if (!row){
        const rowByMsdl = dataRows.find(r=>normalizeMSDL(pick(r,msdlCols))===msdlNorm);
        if(rowByMsdl){
          const expected=normalizeDate(pick(rowByMsdl,joinCols)) || (pick(rowByMsdl,joinCols)||'').trim();
          showError(`Không tìm thấy đại lý phù hợp với thông tin bạn nhập!`);
        } else showError("Không tìm thấy đại lý phù hợp với thông tin bạn nhập!");
        return;
      }

      lastMsdl = pick(row, msdlCols);
      lastJoin = pick(row, joinCols);

      renderReport(row);
      buildSidebarNav();
      loggedIn = true;

      // Sau đăng nhập: chỉ hiển thị "Thông tin đại lý"
      activateSection('sectionInfo');

      // Ẩn form đăng nhập, hiện nút Đăng xuất
      loginForm.classList.add('hidden');
      // đề phòng xung đột CSS (#loginForm {display:grid})
      loginForm.style.display = 'none';
      logoutBtn.style.display = 'inline-flex';

      // Show sidebar/toc theo viewport + nút hỗ trợ phù hợp
      toggleNavByViewport();
      window.addEventListener('resize', toggleNavByViewport);

      // hiện nội dung, update bản quyền
      reportEl.classList.remove('hidden');
      hintEl.textContent = "Bản quyền trang web thuộc về Vùng Hằng Lâm®";
      hintEl.classList.remove('hidden');

      // clear form
      msdlInput.value=""; dateInput.value=""; msdlInput.blur(); dateInput.blur();
    };

    // Đăng xuất: refresh trang
    logoutBtn.addEventListener('click', ()=>{ window.location.reload(); });

    // ===== INFO SECTION =====
    function infoItem(label, value){
      if(!exists(value)) return '';
      return `<div class="info-item"><div class="label">${label}:</div><div class="val">${value}</div></div>`;
    }
    function renderInfoSection(row){
      const p13cn = addPercent(row["TLDTHD cá nhân"]);
      const p13nh = addPercent(row["TLDTHD toàn nhánh"]);
      const p13c1 = addPercent(row["TLDTHD cấp 1"]);

      const proMoc3 = row["PRO.MOC 3 THANG"];
      const hasAlert = exists(proMoc3) && String(proMoc3).trim() !== "-";
      const alertHtml = hasAlert
        ? `<div class="pro-alert ${isMobile() ? 'info-alert' : ''}">Cảnh báo: <span class="pro-name" style="font-weight:900;">Danh hiệu Manulife Pro</span> – ${proMoc3}</div>`
        : "";

      const firstBlock = infoItem("Báo cáo dành cho", (row["TEN DAI LY"] || row["AGEN NAME"]));
      const restBlocks = `
        ${infoItem("KV | MS", row["KV|MS"])}
        ${infoItem("Ngày gia nhập", row["JOIN DATE"])}
        ${infoItem("Tháng làm việc", row["WORK MNTHS"])}
        ${infoItem("Chức danh", row["Chức danh"])}
        ${infoItem("Ngày hiệu lực Chức danh", row["Ngày hiệu lực Chức danh"])}
        ${infoItem("Nhóm đại lý", row["Nhóm Đại lý"])}
        ${infoItem("Manulife Pro (chính thức)", row["PRO.DH CHINH THUC"])}
        ${infoItem("Chính thức từ", row["PRO.BAT DAU"])}
        ${infoItem("P13 Cá nhân", p13cn)}
        ${infoItem("P13 Toàn nhánh", p13nh)}
        ${infoItem("P13 cấp 1", p13c1)}
        ${infoItem("Số liệu cập nhật đến ngày", row["NGAY CHOT DATA"])}
        ${infoItem("ĐVT", "Nghìn VND")}
      `;
      const gridInner = isMobile() ? `${alertHtml}${firstBlock}${restBlocks}` : `${firstBlock}${restBlocks}`;
      const alertAfter = (!isMobile() && hasAlert) ? alertHtml : "";

      return `
        <div id="sectionInfo" class="section">
          <div class="section-title">Thông tin đại lý</div>
          <div class="info-grid">${gridInner}</div>
          ${alertAfter}
        </div>
      `;
    }

    /* ===== RENDER REPORT ===== */
    function renderReport(row){
      const Info = renderInfoSection(row);

      const A = `
        <div id="sectionA" class="section hide">
          <div class="section-title">A. BÁO CÁO TỔNG QUAN – (Month to date)</div>
          <ul class="mb-4 list-dot bullet-strong lvl-2">
            <li>Số hợp đồng thực cấp: <span class="hl">${formatNumber(row["MTD.CC CAP"])}</span></li>
            <li>Doanh thu FYP thực cấp: <span class="hl">${fmt(row["MTD.FYP CAP"], "MTD.FYP CAP", "Doanh thu FYP thực cấp")}</span></li>
            <li>Số lượng Đại lý mới tuyển dụng: <span class="hl">${formatNumber(row["RECRUIT T"])}</span></li>
          </ul>
        </div>
      `;

      const B = `
        <div id="sectionB" class="section hide">
          <div class="section-title">B. BÁO CÁO CHI TIẾT HOẠT ĐỘNG CÁ NHÂN</div>

          <div id="b1" class="sub-block">
            <div class="subsec lvl-1">1. Hoạt động bán hàng</div>
            <div class="thin lvl-2">Nộp mới trong tháng</div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
              <li>Tổng số hợp đồng: <span class="hl">${formatNumber(row["MTD.CC NOP"])}</span></li>
              <li>Tổng doanh thu FYP: <span class="hl">${fmt(row["MTD.FYP NOP"], "MTD.FYP NOP", "Tổng doanh thu FYP")}</span></li>
            </ul>
            <div class="thin lvl-2">Thực cấp trong tháng</div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
              <li>Tổng số hợp đồng: <span class="hl">${formatNumber(row["MTD.CC CAP"])}</span></li>
              <li>Tổng doanh thu FYP: <span class="hl">${fmt(row["MTD.FYP CAP"], "MTD.FYP CAP", "Tổng doanh thu FYP")}</span></li>
            </ul>
          </div>

          <div id="b2" class="sub-block hide">
            <div class="subsec lvl-1">2. Danh hiệu Manulife Pro</div>
            <div class="lvl-2">Danh hiệu chính thức hiện tại: <span class="hl">${formatNumber(row["PRO.DH CHINH THUC"])}</span></div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
              <li>Tháng bắt đầu: <span class="hl">${formatNumber(row["PRO.BAT DAU"])}</span></li>
              <li>Tháng kết thúc: <span class="hl">${formatNumber(row["PRO.KET THUC"])}</span></li>
            </ul>
            <div class="thin mb-1 lvl-2">Thưởng năng suất xuất sắc tháng hiện tại:</div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Danh hiệu dùng để xét thưởng: <span class="hl">${formatNumber(row["PRO.DH XET THUONG"])}</span></li>
              <li>FYP phát sinh tính thưởng: <span class="hl">${fmt(row["PRO.FYP HIEN TAI"], "PRO.FYP HIEN TAI", "FYP phát sinh tính thưởng")}</span></li>
              <li>Mức thưởng tạm đạt: <span class="hl">${fmt(row["PRO.THUONG TAM DAT"], "PRO.THUONG TAM DAT", "Mức thưởng tạm đạt")}</span></li>
              <li>Cần thêm để đạt mức thưởng tiếp theo: <span class="hl">${fmt(row["PRO.FYP CAN TANG THUONG"], "PRO.FYP CAN TANG THUONG", "Cần thêm để đạt mức thưởng tiếp theo")}</span></li>
              <li>Mức thưởng tiếp theo: <span class="hl">${fmt(row["PRO.THUONG TIEP THEO"], "PRO.THUONG TIEP THEO", "Mức thưởng tiếp theo")}</span></li>
            </ul>
            <div class="thin mb-1 lvl-2">Theo dõi thăng hạng danh hiệu</div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Tiến độ thăng hạng danh hiệu: <span class="hl">${addPercent(row["PRO % THANG HANG"])}</span></li>
              <li>Kết quả tại tháng T-2: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-2"])}</span></li>
              <li>Kết quả tại tháng T-1: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-1"])}</span></li>
              <li>FYP cần thêm để thăng hạng: <span class="hl">${fmt(row["PRO.UP FYP CAN THEM"], "PRO.UP FYP CAN THEM", "FYP cần thêm để thăng hạng")}</span></li>
              <li>CC cần thêm để để thăng hạng: <span class="hl">${formatNumber(row["PRO.UP CC CAN THEM"])}</span></li>
              <li>Số tháng có hoạt động cần thêm: <span class="hl">${formatNumber(row["PRO.UP THANG CAN THEM"])}</span></li>
              <li>Tỷ lệ P13 cần thêm để đạt danh hiệu: <span class="hl">${addPercent(row["PRO.UP P13 CAN THEM"])}</span></li>
            </ul>
            <div class="thin mb-1 lvl-2">Theo dõi duy trì danh hiệu</div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Kết quả xét duy trì danh hiệu: <span class="hl">${formatNumber(row["PRO.KQ DUY TRI"])}</span></li>
              <li>Tạm tính theo kết quả tại tháng T-2: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-2"])}</span></li>
              <li>Tạm tính theo kết quả tại tháng T-1: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-1"])}</span></li>
              <li>Danh hiệu tạm tính cao nhất: <span class="hl">${formatNumber(row["PRO.DH TAM TINH CAO NHAT"])}</span></li>
              <li>Tiến độ duy trì danh hiệu: <span class="hl">${addPercent(row["PRO % MOC"])}</span></li>
              <li>Giai đoạn đánh giá: <span class="hl">${formatNumber(row["PRO.GD MOC"])}</span></li>
              <li>FYP đã đạt so với yêu cầu: <span class="hl">${row["PRO.MOC FYP"]}</span></li>
              <li>Số tháng có hoạt động so với yêu cầu: <span class="hl">${formatNumber(row["PRO.MOC THANG HĐ"])}</span></li>
              <li>Cảnh báo 3 tháng cuối kỳ xét: <span class="hl">${formatNumber(row["PRO.MOC 3 THANG"])}</span></li>
            </ul>
          </div>

          <div id="b3" class="sub-block hide">
            <div class="subsec lvl-1">3. Danh hiệu MDRT+</div>
            <div class="lvl-2">Yêu cầu FYP tiến độ quý hiện tại: <span class="hl">${fmt(row["MDRT.FYP Y/C QUY HT"], "MDRT.FYP Y/C QUY HT", "FYP tiến độ quý hiện tại")}</span></div>
            <div class="lvl-2">Tiến độ quý hiện tại đã đạt: <span class="hl">${addPercent(row["MDRT.TIEN DO QUY"])}</span></div>
            <ul class="mb-2 list-dot lvl-3">
              <li>FYP thực đạt (YTD): <span class="hl">${fmt(row["MDRT.FYP CAP"], "MDRT.FYP CAP", "FYP thực đạt (YTD)")}</span></li>
              <li>FYP cần thêm để đạt tiến độ quý hiện tại: <span class="hl">${fmt(row["MDRT.FYP CAN DAT TD QUY"], "MDRT.FYP CAN DAT TD QUY", "FYP cần thêm để đạt tiến độ quý hiện tại")}</span></li>
              <li>FYP cần thêm để đạt danh hiệu MDRT+: <span class="hl">${fmt(row["MDRT.FYP CAN DAT DH"], "MDRT.FYP CAN DAT DH", "FYP cần thêm để đạt danh hiệu MDRT+")}</span></li>
              <li>Danh hiệu đang trong tiến độ: <span class="hl">${formatNumber(row["MDRT.DH TIEP THEO"])}</span></li>
            </ul>
          </div>

          <div id="b4" class="sub-block hide">
            <div class="subsec lvl-1">4. Hành trình M-Star, Xứ sở hoa anh đào</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>FYP phát sinh trong thời gian thi đua: <span class="hl">${fmt(row["JPAN.FYP THI DUA"], "JPAN.FYP THI DUA", "FYP phát sinh trong thời gian thi đua")}</span></li>
              <li>Tổng FYP cần thêm để đạt thi đua: <span class="hl">${fmt(row["JPAN.FYP CAN DAT"], "JPAN.FYP CAN DAT", "Tổng FYP cần thêm để đạt thi đua")}</span></li>
              <li>Tỷ lệ P13 hiện tại: <span class="hl">${addPercent(row["JPAN.P13"])}</span></li>
              <li>Số lượng vé đạt tạm tính: <span class="hl">${formatNumber(row["JPAN.Đạt vé (tạm tính)"])}</span></li>
            </ul>
          </div>

          <div id="b5" class="sub-block hide">
            <div class="subsec lvl-1">5. Khoản thưởng kinh doanh xuất sắc hàng năm</div>
            <ul class="mb-4 list-dot lvl-2">
              <li>Tổng số CC thực cấp (YTD): <span class="hl">${formatNumber(row["FC.FC CC YTD"])}</span></li>
              <li>Tổng FYP phát sinh (YTD): <span class="hl">${fmt(row["FC.FC FYP YTD"], "FC.FC FYP YTD", "Tổng FYP phát sinh (YTD)")}</span></li>
            </ul>
          </div>
        </div>
      `;

      const C = `
        <div id="sectionC" class="section hide">
          <div class="section-title">C. BÁO CÁO CHI TIẾT HOẠT ĐỘNG TUYỂN DỤNG VÀ HỆ THỐNG</div>

          <div id="c1" class="sub-block">
            <div class="subsec lvl-1">1. Hoạt động tuyển dụng</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Số lượng tuyển dụng trực tiếp tháng hiện tại: <span class="hl">${formatNumber(row["RECRUIT T"])}</span></li>
              <li>Số lượng tuyển dụng trực tiếp active M0: <span class="hl">${formatNumber(row["RECRUIT ACT T"])}</span></li>
            </ul>
          </div>

          <div id="c2" class="sub-block hide">
            <div class="subsec lvl-1">2. Theo dõi thăng cấp</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Tiến độ thăng lên UM (đối với FA): <span class="hl">${addPercent(row["UP % FA TO UM"])}</span></li>
              <li>Vị trí thăng cấp: <span class="hl">${formatNumber(row["UP.TC LEN"])}</span></li>
              <li>Kết quả đánh giá: <span class="hl">${formatNumber(row["UP.KQ DG"])}</span></li>
              <li>Tiềm năng thăng cấp: <span class="hl">${formatNumber(row["UP.TIEM NANG TC UM"])}</span></li>
              <li>Theo dõi các khóa đào tạo bắt buộc (Y/N):<br>
                SBW: <span class="hl">${formatNumber(row["UP.SBW"])}</span> &nbsp; 
                MS: <span class="hl">${formatNumber(row["UP.MS"])}</span> &nbsp;
                LS: <span class="hl">${formatNumber(row["UP.LS"])}</span> &nbsp;
                COACHING: <span class="hl">${formatNumber(row["UP.COACHING"])}</span>
              </li>
              <li>Số lượng NRA với 1CC & 4tr FYC cần thêm: <span class="hl">${fmt(row["UP.CAN TD ACT 4TR FYC L3M"], "UP.CAN TD ACT 4TR FYC L3M", "FYC Whole team L6M sau luật 50% cần thêm")}</span></li>
              <li>2A Số lượng đại lý còn làm việc Whole team cần thêm: <span class="hl">${formatNumber(row["UP.CAN CA WT"])}</span></li>
              <li>2B Số lượng đại lý còn làm việc và có ≥ 15tr FYC L3M cần thêm: <span class="hl">${formatNumber(row["UP.CAN CA 15TR L3M"])}</span></li>
              <li>Số lượng UM+ báo cáo trực tiếp cần thêm: <span class="hl">${formatNumber(row["UP.CAN UM+TT"])}</span></li>
              <li>Nguồn sản xuất cần thêm: <span class="hl">${formatNumber(row["UP.CAN NGUON SX"])}</span></li>
              <li>FYC Whole team L6M sau luật 50% cần thêm: <span class="hl">${fmt(row["UP.CAN FYC WT L6M"], "UP.CAN FYC WT L6M", "FYC Whole team L6M sau luật 50% cần thêm")}</span></li>
            </ul>
          </div>

          <div id="c3" class="sub-block hide">
            <div class="subsec lvl-1">3. Theo dõi duy trì chức danh</div>
            <div class="thin lvl-2">Đánh giá từ <span class="hl">${formatNumber(row["MOC.FROM"])}</span> đến <span class="hl">${formatNumber(row["MOC.TO"])}</span> của kỳ đánh giá ngày <span class="hl">${formatNumber(row["MOC.IN"])}</span></div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Chức danh hiện tại: <span class="hl">${formatNumber(row["MOC.RANK"])}</span></li>
              <li>Tháng tại chức: <span class="hl">${formatNumber(row["MOC.TAI VI"])}</span></li>
              <li>Kết quả đánh giá tạm tính (Y/N): <span class="hl">${formatNumber(row["MOC.KQ TAM TINH"])}</span></li>
              <li>Theo dõi các khóa đào tạo bắt buộc (Y/N):<br>
                MS: <span class="hl">${formatNumber(row["UP.MS"])}</span> &nbsp;
                LS: <span class="hl">${formatNumber(row["UP.LS"])}</span> &nbsp;
                COACHING: <span class="hl">${formatNumber(row["UP.COACHING"])}</span>
              </li>
              <li>Số lượng NRA với 1CC & 4tr FYC cần thêm: <span class="hl">${fmt(row["MOC.CAN TD ACT 4TR L6M"], "MOC.CAN TD ACT 4TR L6M", "FYC Whole team L6M sau luật 50% cần thêm")}</span></li>
              <li>Số lượng UM+ báo cáo trực tiếp cần thêm: <span class="hl">${formatNumber(row["MOC.CAN UM+ TT"])}</span></li>
              <li>FYP Whole team L6M sau luật 50% cần thêm: <span class="hl">${fmt(row["MOC.CAN FYC WT L6M"], "MOC.CAN FYC WT L6M", "FYP Whole team L6M sau luật 50% cần thêm")}</span></li>
              <li>Tỷ lệ duy trì P13 cần thêm: <span class="hl">${addPercent(row["MOC.CAN P13 WT"])}</span></li>
            </ul>
          </div>

          <div id="c4" class="sub-block hide">
            <div class="subsec lvl-1">4. Danh hiệu MBA Pro</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Danh hiệu chính thức hiện tại: <span class="hl">${formatNumber(row["MBA.DH CT HIEN TAI"])}</span></li>
              <li><span class="thin">Theo dõi thăng hạng:</span></li>
            </ul>
            <ul class="mb-2 list-dot lvl-3">
              <li>Tiềm năng thăng hạng (FYC ≥ 80% yêu cầu hạn tiếp theo): <span class="hl">${fmt(row["MBA.TIEM NANG 80%FYC"], "MBA.TIEM NANG 80%FYC", "FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%")}</span></li>
              <li>Số lượng đại lý đạt chuẩn trong quý: <span class="hl">${formatNumber(row["MBA.TH DL DAT CHUAN TRONG QUY"])}</span></li>
              <li>Số lượng đại lý đạt chuẩn trong 2 quý: <span class="hl">${formatNumber(row["MBA.TH DL DAT CHUAN 2 QUY"])}</span></li>
              <li>FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%: <span class="hl">${fmt(row["MBA.TH FYC TO TT SAU 50"], "MBA.TH FYC TO TT SAU 50", "FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%")}</span></li>
              <li>Số UM+ mới thăng cấp L12M: <span class="hl">${formatNumber(row["MBA.TH UM+ MOI L12M"])}</span></li>
              <li>P13 cấp báo cáo trực tiếp: <span class="hl">${addPercent(row["MBA.TH P13 BCTT"])}</span></li>
              <li>Danh hiệu MBA Pro tạm tính theo kết quả xét thăng hạng: <span class="hl">${formatNumber(row["MBA.TH DH TAM TINH QUY SAU"])}</span></li>
            </ul>
            <ul class="mb-2 list-dot lvl-2"><li><span class="thin">Theo dõi duy trì hạng:</span></li></ul>
            <ul class="mb-2 list-dot lvl-3">
              <li>Kết quả xét duy trì tạm tính: <span class="hl">${formatNumber(row["MBA.KQ DT DH HTAI"])}</span></li>
              <li>Số quý liên tục giữ danh hiệu MBA Pro hiện tại: <span class="hl">${formatNumber(row["MBA.DT SO QUY LIEN TUC"])}</span></li>
              <li>Số lượng Manulife Pro có sản xuất trong quý: <span class="hl">${formatNumber(row["MBA.SO MANPRO ACT TRONG QUY"])}</span></li>
              <li>FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%: <span class="hl">${fmt(row["MBA.TH FYC TO TT SAU 50"], "MBA.TH FYC TO TT SAU 50", "FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%")}</span></li>
              <li>Số UM+ mới thăng cấp L12M: <span class="hl">${formatNumber(row["MBA.TH UM+ MOI L12M"])}</span></li>
            </ul>
            <ul class="mb-2 list-dot lvl-2"><li>Danh hiệu tạm tính quý sau (sau thăng hạng & duy trì): <span class="hl">${formatNumber(row["MBA.DH TAM TINH QUY SAU"])}</span></li></ul>
          </div>

          <div id="c5" class="sub-block hide">
            <div class="subsec lvl-1">5. Thưởng năng suất nhóm ưu tú hàng tháng</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Tổng CC phát sinh trong tháng của bản thân UM+ (A): <span class="hl">${formatNumber(row["OTEAM.CC UM+"])}</span></li>
              <li>Tổng FYP phát sinh trong tháng của bản thân UM+ (A): <span class="hl">${fmt(row["OTEAM.FYP UM+"], "OTEAM.FYP UM+", "Tổng FYP phát sinh trong tháng của bản thân UM+ (A)")}</span></li>
              <li>Số NRA có ≥1CC và 15tr FYP L3M của bản thân UM+(A): <span class="hl">${formatNumber(row["OTEAM.TDTT ACT"])}</span></li>
              <li>FYP của bản thân UM+ (A) và nhóm trực tiếp sau luật 50%: <span class="hl">${fmt(row["OTEAM.TONG FYP TT"], "OTEAM.TONG FYP TT", "FYP của bản thân UM+ (A) và nhóm trực tiếp sau luật 50%")}</span></li>
              <li>FYP của bản thân UM+ (B) báo cáo trực tiếp cho UM+ (A): <span class="hl">${fmt(row["OTEAM.FYP UM+ MOI"], "OTEAM.FYP UM+ MOI", "FYP của bản thân UM+ (B) báo cáo trực tiếp cho UM+ (A)")}</span></li>
              <li>Tổng FYP sau luật 50% dùng để tính thưởng (cấp UM): <span class="hl">${fmt(row["OTEAM.TONG FYP SAU LUAT XET THUONG"], "OTEAM.TONG FYP SAU LUAT XET THUONG", "Tổng FYP sau luật 50% dùng để tính thưởng (cấp UM)")}</span></li>
              <li>Tổng FYP WT trước luật 50% (cấp SUM+): <span class="hl">${fmt(row["OTEAM.FYP WT TRUOC LUAT"], "OTEAM.FYP WT TRUOC LUAT", "Tổng FYP WT trước luật 50% (cấp SUM+)")}</span></li>
              <li>Tổng FYP WT sau luật 50% để tính thưởng (cấp SUM+):(2): <span class="hl">${fmt(row["OTEAM.FYP WT SAU LUAT"], "OTEAM.FYP WT SAU LUAT", "Tổng FYP WT sau luật 50% để tính thưởng (cấp SUM+)")}</span></li>
              <li>Y/c về tổng FYP: <span class="hl">${fmt(row["OTEAM.Y/C TONG FYP"], "OTEAM.Y/C TONG FYP", "Y/c về tổng FYP")}</span></li>
              <li>Y/c về bán cá nhân: <span class="hl">${formatNumber(row["OTEAM.Y/C SX CA NHAN"])}</span></li>
              <li>Y/c về tuyển có active: <span class="hl">${formatNumber(row["OTEAM.Y/C TDTT ACT"])}</span></li>
              <li>Kết quả đạt thưởng thi đua (Y/N): <span class="hl">${formatNumber(row["OTEAM.DAT THUONG"])}</span></li>
              <li>Tỷ lệ P13: <span class="hl">${addPercent(row["OTEAM.P13"])}</span></li>
              <li>Hệ số nhân TLDTHD: <span class="hl">${formatNumber(row["OTEAM.HE SO THUONG"])}</span></li>
              <li>Thưởng dự tính sau khi đã nhân hệ số TLDTHD: <span class="hl">${fmt(row["OTEAM.TIEN THUONG"], "OTEAM.TIEN THUONG", "Thưởng dự tính sau khi đã nhân hệ số TLDTHD")}</span></li>
            </ul>
          </div>
        </div>
      `;

      // Tính thu nhập
      const ms = encodeURIComponent(lastMsdl || '');
      const jd = encodeURIComponent(normalizeDate(lastJoin || ''));
      const incomeURL = `https://tracuubaocao.vunghanglam.com/income`;
      const Income = `
        <div id=\"sectionIncome\" class=\"section hide\">
          <div class=\"section-title\">CÔNG CỤ DỰ TÍNH THU NHẬP</div>
          <div>
            <iframe id=\"incomeFrame\" src=\"${incomeURL}\" class=\"w-full h-[78vh] border rounded-lg\"></iframe>
          </div>
        </div>
      `;

      // ghép & chỉ hiển thị Info ban đầu
      reportEl.innerHTML = Info + A + B + C + Income;

      // TOC mobile: chuyển section khi chọn
      const sel = document.getElementById('tocSelect');
      sel.onchange = (e)=>{
        const v=e.target.value; if(!v) return;
        if(v.includes('#')){ const [parent,anchor]=v.split('#'); activateSection(parent,'#'+anchor); }
        else { activateSection(v); }
      };
    }

    /* ===== NAV ===== */
    function buildSidebarNav(){
      navEl.innerHTML = `
        <div class="font-extrabold text-emerald-800 mb-2">Danh mục</div>

        <a href="#" data-type="section" data-target="sectionInfo" class="menu-item active">Thông tin đại lý</a>
        <a href="#" data-type="section" data-target="sectionA" class="menu-item">A. Tổng quan (MTD)</a>

        <div class="menu-item-group">
          <div class="menu-head">B. Hoạt động cá nhân</div>
          <div class="submenu">
            <a href="#" data-type="sub" data-parent="sectionB" data-anchor="#b1">B.1 Bán hàng</a>
            <a href="#" data-type="sub" data-parent="sectionB" data-anchor="#b2">B.2 Manulife Pro</a>
            <a href="#" data-type="sub" data-parent="sectionB" data-anchor="#b3">B.3 MDRT+</a>
            <a href="#" data-type="sub" data-parent="sectionB" data-anchor="#b4">B.4 M-Star / Japan</a>
            <a href="#" data-type="sub" data-parent="sectionB" data-anchor="#b5">B.5 Thưởng năm</a>
          </div>
        </div>

        <div class="menu-item-group">
          <div class="menu-head">C. Tuyển dụng & Hệ thống</div>
          <div class="submenu">
            <a href="#" data-type="sub" data-parent="sectionC" data-anchor="#c1">C.1 Tuyển dụng</a>
            <a href="#" data-type="sub" data-parent="sectionC" data-anchor="#c2">C.2 Thăng cấp</a>
            <a href="#" data-type="sub" data-parent="sectionC" data-anchor="#c3">C.3 Duy trì chức danh</a>
            <a href="#" data-type="sub" data-parent="sectionC" data-anchor="#c4">C.4 MBA Pro</a>
            <a href="#" data-type="sub" data-parent="sectionC" data-anchor="#c5">C.5 Thưởng nhóm ưu tú</a>
          </div>
        </div>

        <a href="#" data-type="section" data-target="sectionIncome" class="menu-item">Tính thu nhập</a>
      `;
      navEl.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click',(e)=>{
          e.preventDefault();
          const type=a.getAttribute('data-type');
          const target=a.getAttribute('data-target');
          const parent=a.getAttribute('data-parent');
          const anchor=a.getAttribute('data-anchor');
          if(type==='section') activateSection(target);
          else if(type==='sub') activateSection(parent,anchor);
        });
      });
    }

    /* ===== ACTIVATE SECTION ===== */
    function activateSection(sectionId, anchor){
      // Ẩn mọi section
      document.querySelectorAll('#report .section').forEach(sec=>sec.classList.add('hide'));
      const section = document.getElementById(sectionId); if(!section) return;
      section.classList.remove('hide');

      // Nếu chọn mục con, chỉ hiển thị block đó
      section.querySelectorAll('.sub-block').forEach(sb=>sb.classList.remove('hide'));
      if(anchor){
        section.querySelectorAll('.sub-block').forEach(sb=>sb.classList.add('hide'));
        const sub = section.querySelector(anchor); if(sub) sub.classList.remove('hide');
      }

      // Active menu
      document.querySelectorAll('#nav .menu-item, #nav .submenu a').forEach(el=>el.classList.remove('active'));
      if(!anchor){
        const top=document.querySelector(`#nav .menu-item[data-target="${sectionId}"]`);
        if(top) top.classList.add('active');
      } else {
        const sublink=document.querySelector(`#nav .submenu a[data-parent="${sectionId}"][data-anchor="${anchor}"]`);
        if(sublink) sublink.classList.add('active');
      }

      // Đồng bộ dropdown mobile
      const select=document.getElementById('tocSelect');
      if (select && getComputedStyle(tocMbEl).display!=='none'){
        const value=anchor?`${sectionId}${anchor}`:sectionId;
        const opt=Array.from(select.options).find(o=>o.value===value);
        if(opt) select.value=value;
      }

      // cuộn tới đầu section
      scrollToSectionStart(sectionId);
    }

    // ===== HỖ TRỢ =====
    function openSupport(){
      alert('Hỗ trợ: vui lòng liên hệ quản trị viên Vùng Hằng Lâm.');
    }
    helpDeskEl.addEventListener('click', openSupport);
    helpMobEl.addEventListener('click', openSupport);

    /* ===== INIT ===== */
    function init(){
      fitTitles();
      updateLayoutVars();

      // Trước đăng nhập: ẩn sidebar & dropdown, ẩn report và các nút hỗ trợ
      sidebarEl.style.display='none';
      tocMbEl.style.display='none';
      reportEl.classList.add('hidden');
      helpDeskEl.style.display='none';
      helpMobEl.style.display='none';
    }
    window.addEventListener('load', init);
    window.addEventListener('resize', ()=>{ fitTitles(); updateLayoutVars(); toggleNavByViewport(); });
  </script>
</body>
</html>
