<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra c·ª©u b√°o c√°o V√πng H·∫±ng L√¢m</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f1f1f1;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      color: #007A33;
      font-size: 22px;
      text-align: center;
    }
    input, button {
      padding: 14px;
      margin: 12px 0;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #007A33;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #005c26;
    }
    #result {
      margin-top: 20px;
      text-align: center;
    }
    iframe {
      border: 1px solid #eee;
    }
    @media (max-width: 480px) {
      h1 { font-size: 20px; }
    }
  </style>
</head>
<body>
  <h1>TRA C·ª®U B√ÅO C√ÅO C√Å NH√ÇN</h1>
  <p style="text-align: center; font-style: italic; color: #007A33;">
    Ch√†o m·ª´ng anh/ch·ªã ƒë·∫øn v·ªõi h·ªá th·ªëng tra c·ª©u b√°o c√°o c√° nh√¢n V√πng H·∫±ng L√¢m<br> 
    Vui l√≤ng nh·∫≠p M√£ s·ªë v√† Ng√†y gia nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.<br>
    <span style="font-size: 14px; color: #444;">Ng√†y gia nh·∫≠p ƒë∆∞·ª£c ghi nh·∫≠n tr√™n ·ª©ng d·ª•ng M-PA ho·∫∑c AWS.</span>
  </p>

  <form id="reportForm">
    <input type="text" id="code" placeholder="M√£ s·ªë ƒë·∫°i l√Ω / qu·∫£n l√Ω (VD: A1234)" required />
    <input type="text" id="joinDate" placeholder="Ng√†y gia nh·∫≠p (VD: 01/01/2020 ho·∫∑c 01012020)" required />
    <button type="submit">Xem b√°o c√°o</button>
  </form>
  <div id="result"></div>

  <script>
    const logURL = "https://script.google.com/macros/s/AKfycbziTV42B_E7vtYMigc8e7mgUu9ppdpOpxPEjJxy9Yn8bur02h57VVNTOhozZ6emQWEhhw/exec";

    function formatDate(str) {
      let cleaned = str.replace(/\D/g, "");
      if (cleaned.length === 8) {
        return cleaned.slice(0, 2) + '/' + cleaned.slice(2, 4) + '/' + cleaned.slice(4);
      }
      return str;
    }

    function normalizeDate(input) {
      if (!input) return '';
      if (typeof input === 'number') {
        return new Date(input).toLocaleDateString('vi-VN');
      }
      if (typeof input === 'string') {
        if (input.includes('-')) {
          const d = new Date(input);
          return d.toLocaleDateString('vi-VN');
        }
        return input.replace(/\-/g, '/').trim();
      }
      return '';
    }

    document.getElementById("reportForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const code = document.getElementById("code").value.trim().toUpperCase();
      const rawDate = document.getElementById("joinDate").value.trim();
      const joinDate = formatDate(rawDate);
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "‚è≥ ƒêang ki·ªÉm tra d·ªØ li·ªáu...";

      try {
        const res = await fetch('data.json');
        const rows = await res.json();

        let matchedRows = rows.filter(row =>
          row["MGR. CODE"]?.toUpperCase() === code &&
          normalizeDate(row["JOIN DATE"]) === joinDate
        );

        if (matchedRows.length === 0) {
          matchedRows = rows.filter(row =>
            row["AGEN CODE"]?.toUpperCase() === code &&
            normalizeDate(row["JOIN DATE"]) === joinDate
          );
        }

        if (matchedRows.length === 0) {
          resultDiv.innerHTML = "‚õî Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√π h·ª£p. Vui l√≤ng ki·ªÉm tra l·∫°i!";
          return;
        }

        let filesHTML = matchedRows.map((row) => {
          const file = row["FILE NAME"];
          const fileURL = `report/${file}`;
          const fullFileURL = window.location.origin + '/' + fileURL;
          const googleViewerURL = `https://drive.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(fullFileURL)}`;

          return `
            <div style="margin-top: 24px; border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #fff;">
              <p><strong>üìÑ ${file}</strong></p>
              <iframe src="${googleViewerURL}" width="100%" height="600px" style="border: none;"></iframe>
              <a href="${fileURL}" download style="
                display: inline-block;
                margin-top: 10px;
                padding: 10px 14px;
                background-color: #007A33;
                color: #fff;
                text-decoration: none;
                border-radius: 4px;
              ">‚¨áÔ∏è T·∫£i v·ªÅ</a>
            </div>
          `;
        });

        let downloadAllButton = "";
        if (matchedRows.length >= 2) {
          const allFiles = matchedRows.map(row => `'report/${row["FILE NAME"]}'`).join(",");
          downloadAllButton = `
            <button onclick="downloadAll([${allFiles}])" style="
              background-color: #005c26;
              color: white;
              padding: 12px 16px;
              margin: 20px auto;
              display: block;
              border: none;
              border-radius: 6px;
              font-size: 16px;
              cursor: pointer;
            ">‚¨áÔ∏è T·∫£i t·∫•t c·∫£ b√°o c√°o (${matchedRows.length})</button>
          `;
        }

        const displayName = matchedRows[0]["AGEN NAME"] || code;
        resultDiv.innerHTML = `<h3>‚úÖ Xin ch√†o ${displayName}!<br>D∆∞·ªõi ƒë√¢y l√† c√°c b√°o c√°o b·∫°n ƒë∆∞·ª£c ph√¢n quy·ªÅn xem:</h3>${downloadAllButton}${filesHTML.join("")}`;

        // G·ª≠i log b·∫±ng <img> ƒë·ªÉ tr√°nh b·ªã CORS
        const logImg = new Image();
        logImg.src = `${logURL}?code=${encodeURIComponent(code)}&ts=${Date.now()}`;

      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "‚ùå C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu.";
      }
    });

    function downloadAll(fileUrls) {
      fileUrls.forEach((url, i) => {
        setTimeout(() => {
          const a = document.createElement('a');
          a.href = url;
          a.download = url.split('/').pop();
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }, i * 800);
      });
    }
  </script>
</body>
</html>
