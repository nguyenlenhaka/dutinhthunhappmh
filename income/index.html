<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>D·ª∞ T√çNH THU NH·∫¨P ‚Äì H∆Ø∆†NG L√ä PMH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit-cover" />
  
  <!-- Logo v√† Favicon -->
  <link rel="icon" type="image/webp" href="../logo.webp" />
  <link rel="apple-touch-icon" href="../logo.webp" />
  <meta name="msapplication-TileImage" content="../logo.webp" />
  <meta property="og:image" content="../logo.webp" />
  <meta name="twitter:image" content="../logo.webp" />

  <!-- Font c·ªßa d·ª± √°n -->
  <link rel="stylesheet" href="../fonts.css" />
  <!-- Tailwind (ch·ªâ d√πng utility nh·ªè) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --sidebar-width: 360px;
      --header-h: 64px;
      --footer-h: 66px;
      --toc-h: 0px;          /* chi·ªÅu cao dropdown mobile (t·ª± t√≠nh b·∫±ng JS) */
      --brand:#059669; 
      --accent:#00a758;
      
      /* T√πy bi·∫øn responsive cho t·∫•t c·∫£ thi·∫øt b·ªã */
      --mobile-breakpoint: 1023px;
      --tablet-breakpoint: 768px;
      --small-mobile: 480px;
      --large-desktop: 1440px;
      
      /* T√πy bi·∫øn spacing */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
      
      /* T√πy bi·∫øn z-index */
      --z-header: 1000;
      --z-banner: 999;
      --z-toc: 996;
      --z-content: 1;
      --z-footer: 950;
      --z-support: 940;
      --z-loading: 10000;
    }
    /* ƒë·∫£m b·∫£o kh√¥ng tr√†n ngang tr√™n m·ªçi thi·∫øt b·ªã */
    html,body{height:100%;margin:0;background:#f3f4f6;overflow-x:hidden}
    *{box-sizing:border-box;min-width:0}

    /* ===== HEADER (FIXED) ===== */
    .app-header{
      position:fixed; top:0; left:0; right:0; z-index:var(--z-header);
      background:#e8fff3; border-bottom:1px solid #d9f7e6;
      padding-top:var(--safe-area-top);
    }
    /* header chia 2 khu: brand (logo+t√™n) v√† login */
    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:center; gap:12px; padding:10px 12px;
    }
    .brand-row{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo-d{ height:70px; width:auto; display:block; flex:0 0 auto; }

    /* Ti√™u ƒë·ªÅ: cho ph√©p xu·ªëng d√≤ng, kh√¥ng c·∫Øt d·∫•u */
    .title-wrap{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title-top,.title-main{
      font-family:'Manulife JH Sans','ManulifeJHSans',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--brand); font-weight:800;
      white-space:normal; overflow:visible; text-overflow:clip;
      word-break:keep-all; line-height:1.25; padding-block:2px;
    }
    .title-top{  font-size:clamp(14px, 1vw + 10px, 22px); text-transform:uppercase; }
    .title-main{ font-size:clamp(18px, 1.8vw + 12px, 34px); }

    /* ===== LOGIN / LOGOUT ===== */
    .login-cluster{ 
      display: flex; 
      gap: 16px; 
      align-items: flex-end;
      justify-self: end;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .password-input-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .login-cluster input{ 
      height: 44px; 
      padding: 0 12px; 
      font-size: 16px; 
      border: 1.3px solid #b7e7ce; 
      border-radius: 10px; 
      background: #effaf3; 
      font-weight: 600; 
      color: #0d7233; 
      outline: none; 
      width: 180px;
    }
    
    .login-btn{ 
      height: 44px; 
      padding: 0 18px; 
      background: #008a53; 
      color: #fff; 
      border: none; 
      border-radius: 10px; 
      font-weight: 800; 
      cursor: pointer; 
      touch-action: manipulation;
      min-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-btn:hover{ background: #066a42; }
    
    .toggle-password {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 16px;
      color: #666;
      transition: background-color 0.2s;
    }
    
    .toggle-password:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    .password-input-wrapper input[type="password"] {
      padding-right: 40px;
    }
    
    /* ·∫®n n√∫t toggle khi ƒë√£ ƒëƒÉng nh·∫≠p */
    body.logged-in .toggle-password {
      display: none !important;
    }
    
    /* ·∫®n n√∫t toggle khi ƒë√£ ƒëƒÉng nh·∫≠p */
    body.logged-in .password-input-wrapper input {
      padding-right: 12px;
    }
    
    .logout-only{ display:none !important; }
    body.logged-in .login-only{ display:none !important; }
    body.logged-in .logout-only{ display:block !important; }

    /* ===== SIDEBAR (DESKTOP) ===== */
    #sidebar{
      position:fixed; left:0; top:var(--header-h); bottom:var(--footer-h);
      width:var(--sidebar-width); background:#fff; border-right:1px solid #e5e7eb; z-index:900;
      overflow-y:auto; overflow-x:hidden; display:none;
    }
    .sidebar-inner{ padding:12px; }
    .menu-title{ font-weight:900; color:#065f46; margin:6px 8px 8px; white-space:normal; line-height:1.25; }
    .menu-group{ margin:12px 0 6px 8px; font-weight:900; color:#0b3d2c; white-space:normal; line-height:1.25; }
    .menu-item{
      display:block; padding:.55rem .75rem; border-radius:.55rem; font-weight:800; color:#0b3d2c;
      white-space:normal; overflow-wrap:anywhere; word-break:break-word; line-height:1.25; font-size:0.96rem;
    }
    .menu-item:hover{ background:#e5f7ee; }
    .menu-item.active{ background:#0ea35b; color:#fff; }
    .submenu{ margin:.25rem 0 .5rem .75rem; }
    .submenu .menu-item{ padding:.45rem .6rem; }

    /* ===== SIDEBAR UPDATE INFO ===== */
    .sidebar-update-info {
      background: #f0f9ff;
      color: #0b3d2c;
      padding: 8px 12px;
      margin: 0 0 12px 0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      border-left: 4px solid #0ea35b;
      line-height: 1.3;
    }

    /* ===== DESKTOP UPDATE DATE ===== */
    .desktop-update-date {
      background: #fef3c7;
      color: #92400e;
      padding: 6px 12px;
      margin: 0 0 12px 0;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      border-left: 4px solid #f59e0b;
      line-height: 1.3;
      text-align: center;
    }

    /* ===== WELCOME BANNER ===== */
    .welcome-banner {
      position: fixed;
      top: var(--header-h);
      left: var(--sidebar-width);
      right: 0;
      z-index: var(--z-banner);
      background: linear-gradient(135deg, #059669 0%, #00a758 100%);
      color: white;
      padding: 8px 20px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      display: none;
      line-height: 1.2;
      pointer-events: none; /* Kh√¥ng ch·∫∑n click events */
    }

    /* ===== NORMAL LOGIN CONTAINER ===== */
    .normal-login-container {
      position: fixed;
      top: calc(var(--header-h) + 40px);
      left: 0;
      width: var(--sidebar-width);
      z-index: var(--z-toc);
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: none;
    }

    .normal-login-content {
      padding: 12px 20px;
    }
    
    /* ·∫®n normalLoginContainer tr√™n t·∫•t c·∫£ thi·∫øt b·ªã */
    .normal-login-container {
      display: none !important;
    }

    .normal-login-update-date {
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      color: #0b3d2c;
      margin-bottom: 12px;
    }

    .normal-login-button {
      width: 100%;
      height: 40px;
      background: #f59e0b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .normal-login-button:hover {
      background: #d97706;
    }

    /* ===== MOBILE CONTAINER ===== */
    .mobile-container {
      position: fixed;
      top: calc(var(--header-h) + 40px);
      left: 0;
      right: 0;
      z-index: var(--z-toc);
      background: #fff;
      border-bottom: none;
      box-shadow: none;
      display: none;
      /* Chi·ªÅu cao v·ª´a kh√≠t v·ªõi n·ªôi dung */
      height: auto;
      min-height: auto;
      margin: 0;
      padding: 0;
    }

    .mobile-container-content {
      padding: 10px 16px;
      /* Lo·∫°i b·ªè margin v√† padding th·ª´a */
      margin: 0;
    }

    .mobile-update-date {
      color: #0b3d2c;
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      margin: 0;
      padding: 0;
    }


    /* ===== MOBILE AGENT INFO ===== */
    .mobile-agent-info {
      position: fixed;
      top: calc(var(--header-h) + 40px + 40px + 40px);
      left: 0;
      right: 0;
      z-index: var(--z-toc);
      background: #fff;
      color: #0b3d2c;
      padding: 8px 16px;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: none;
      margin: 0;
    }
    
    /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ mobile agent info khi c√≥ agent search container */
    body.showing-agent-search .mobile-agent-info {
      top: calc(var(--header-h) + 40px + 80px + 200px);
    }
    
    /* D·ªùi mobile agent info xu·ªëng th√™m 50px sau khi nh·∫•n calculateOtherAgentBtn */
    body.after-calculate-other .mobile-agent-info {
      top: calc(var(--header-h) + 40px + 80px + 50px);
    }

    .mobile-agent-info-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 0;
      padding: 0;
    }

    .mobile-agent-info-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.2;
      margin: 0;
      padding: 0;
    }

    .mobile-agent-info-text strong {
      color: #0b3d2c;
      font-weight: 700;
    }

    .mobile-agent-info-text small {
      color: #6b7280;
      font-size: 12px;
      margin: 0;
      padding: 0;
    }

    .mobile-agent-info-button {
      height: 36px;
      padding: 0 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 120px;
      margin: 0;
    }

    .mobile-agent-info-button.normal-login {
      background: #059669;
      color: #fff;
    }

    .mobile-agent-info-button.special-login {
      background: #f59e0b;
      color: #fff;
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: var(--z-loading); /* Cao h∆°n header v√† banner */
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .loading-content {
      text-align: center;
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== MOBILE TOC (DANH M·ª§C DROPDOWN) =====
       Lu√¥n treo d∆∞·ªõi header -> fixed + top = --header-h */
    #tocMobile{
      position:fixed; top:calc(var(--header-h) + 40px + 40px); left:0; right:0; z-index:var(--z-toc);
      background:#fff; padding:6px 10px 4px;
      border-bottom:none; display:none;
      will-change:top;
      margin: 0;
    }
    #tocMobile .row{ 
      display:grid; 
      grid-template-columns: 2fr 2fr 1fr; 
      gap:6px; 
    }
    
    /* N√∫t danh m·ª•c mobile */
    .mobile-menu-btn {
      height: 36px;
      border: 1px solid #c7d5e6;
      border-radius: 8px;
      padding: 0;
      font-weight: 800;
      color: #00519c;
      background: #eff5ff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .mobile-menu-btn:hover {
      background: #e0f2fe;
      border-color: #0ea5e9;
    }
    
    /* N√∫t t√≠nh to√°n cho ƒë·∫°i l√Ω kh√°c mobile */
    .mobile-calculate-other-btn {
      height: 36px;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 0;
      font-weight: 800;
      color: #fff;
      background: #f59e0b;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
      line-height: 1.1;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-calculate-other-btn:hover {
      background: #d97706;
      border-color: #d97706;
    }
    
    /* N√∫t "T√≠nh cho t√¥i" m√†u xanh l√° trong TOC */
    .mobile-calculate-other-btn.normal-login {
      background: #059669 !important;
      border-color: #059669 !important;
    }
    
    .mobile-calculate-other-btn.normal-login:hover {
      background: #047857 !important;
      border-color: #047857 !important;
    }
    
    /* N√∫t ƒëƒÉng xu·∫•t mobile */
    .mobile-logout-btn {
      height: 36px;
      border: 1px solid #dc2626;
      border-radius: 8px;
      padding: 0;
      font-weight: 800;
      color: #fff;
      background: #dc2626;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      width: 100%;
    }
    
    .mobile-logout-btn:hover {
      background: #b91c1c;
      border-color: #b91c1c;
    }
    
    /* Mobile menu dropdown */
    .mobile-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      margin-top: 12px;
    }
    
    .mobile-menu-content {
      padding: 8px 0;
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
    }
    
    .mobile-menu-item {
      display: block;
      padding: 12px 16px;
      color: #0b3d2c;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }
    
    .mobile-menu-item:last-child {
      border-bottom: none;
    }
    
    .mobile-menu-item:hover {
      background-color: #f9fafb;
    }

    /* ===== CONTENT ===== */
    /* ch·ª´a ch·ªó d∆∞·ªõi header + dropdown mobile (n·∫øu c√≥) */
    body{ padding-top: calc(var(--header-h) + var(--toc-h) + 8px); }
    
    /* Ch·ª´a ch·ªó cho banner khi ƒë√£ ƒëƒÉng nh·∫≠p */
    body.logged-in{ padding-top: calc(var(--header-h) + 40px + var(--toc-h) - 40px); }
    
      /* Ch·ª´a ch·ªó cho normal login container */
      body.logged-in.has-normal-login-container{ padding-top: calc(var(--header-h) + 40px + 60px + var(--toc-h) - 40px); }
      
      /* Ch·ª´a ch·ªó cho update date tr√™n mobile */
      body.logged-in.mobile{ padding-top: calc(var(--header-h) + 40px + 40px + var(--toc-h) - 40px); }
      
      /* Ch·ª´a ch·ªó cho TOC mobile khi ƒë√£ ƒëƒÉng nh·∫≠p */
      body.logged-in{ padding-top: calc(var(--header-h) + 40px + 40px + var(--toc-h) - 40px); }
      
      /* Ch·ª´a ch·ªó cho mobile agent info */
      body.logged-in.mobile.has-agent-info{ padding-top: calc(var(--header-h) + 40px + 40px + 40px + var(--toc-h) - 40px); }
    /* ch·ª´a ch·ªó cho footer */
    body{ padding-bottom: calc(2.25 * var(--footer-h) + var(--safe-area-bottom)); }

    #contentWrap{ margin-left:0; }
    body.sidebar-open #contentWrap{ margin-left:var(--sidebar-width); }
    main{ max-width:1200px; margin:0 auto; padding:-46px 14px 14px 14px; }

    /* ·∫®n to√†n b·ªô ph·∫ßn ngo√†i header khi ch∆∞a login */
    body.logged-out #sidebar,
    body.logged-out #tocMobile,
    body.logged-out #contentWrap,
    body.logged-out #supportDesk { display:none !important; }
    
    /* ·∫®n TOC khi ch∆∞a ƒëƒÉng nh·∫≠p tr√™n c·∫£ desktop v√† mobile */
    body.logged-out #tocMobile { display:none !important; }
    
    /* Hi·ªÉn th·ªã n√∫t h·ªó tr·ª£ mobile khi ch∆∞a ƒëƒÉng nh·∫≠p - n·∫±m tr√™n footer */
    body.logged-out #tocMobile::after {
      content: "H·ªó tr·ª£";
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      padding: 0 12px;
      background: #00a758;
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 900;
      white-space: nowrap;
      position: fixed;
      right: 10px;
      bottom: calc(var(--footer-h) + 14px);
      z-index: var(--z-support);
    }
    
    /* ·∫®n n√∫t h·ªó tr·ª£ c≈© khi ƒë√£ ƒëƒÉng nh·∫≠p */
    body.logged-in #tocMobile::after {
      display: none !important;
    }

    .section-title{
      background:#fff; padding:12px 16px; border-left:6px solid #0ea35b; border-radius:8px;
      font-weight:900; color:#0b3d2c; margin:6px 0 14px;
    }

    :root{ --pad:18px; }
    .top-fields,.top-fields-2{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;align-items:end;margin:40px var(--pad) 10px var(--pad)}
    .top-fields-2{margin-bottom:8px}
    .field{grid-column:span 4;display:flex;flex-direction:column;min-width:0}
    .field label{font-size:1.05rem;font-weight:800;color:#0b3d2c;margin:0 0 6px 2px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .field input,.field select{
      height:46px;padding:0 12px;font-size:16px;border:1.3px solid #b7e7ce;border-radius:8px;background-color:#effaf3;
      font-weight:800;color:#0d7233;text-align:center
    }
    .field input[readonly]{background:#f8f9fa;color:#0ea35b;border-color:#dee2e6}
    
    /* Grid layout cho th√¥ng tin ƒë·∫°i l√Ω */
    .agent-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 40px var(--pad) 16px var(--pad);
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    /* Grid layout cho 4 c·ªôt ƒë·∫ßu ti√™n */
    .agent-info-grid:first-of-type {
      grid-template-columns: 2fr 1fr 1fr 2fr;
    }
    
    /* Grid layout cho 6 c·ªôt th·ª© hai - chia th√†nh 2 h√†ng tr√™n desktop */
    .agent-info-grid:nth-of-type(2) {
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }
    
    /* Grid layout cho c√°c section kh√°c */
    .agent-info-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    /* Grid layout cho section A.2 (8 tr∆∞·ªùng) */
    #sec-khoanthu .agent-info-grid {
      grid-template-columns: repeat(4, 1fr);
    }
    
    /* Grid layout cho section D (4 tr∆∞·ªùng) */
    #sec-tong .agent-info-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    /* Grid layout cho section B, C (1 tr∆∞·ªùng) */
    #sec-tuyendung .agent-info-grid,
    #sec-quan-ly .agent-info-grid {
      grid-template-columns: 1fr;
    }
    
    .agent-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .agent-field label {
      font-size: 12px;
      color: #374151;
      font-weight: 600;
    }
    
    .agent-field input {
      height: 32px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 0 8px;
      font-size: 14px;
      background: #fff;
      font-weight: 700;
      color: #10b981;
      text-align: center;
    }
    
    .agent-field input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    
    .agent-field input[readonly] {
      background: #f0fdf4;
      color: #10b981;
      font-weight: 700;
      border-color: #bbf7d0;
    }
    .gd-stage>b{display:block;margin:6px var(--pad);font-weight:900;color:#0b3d2c;}
    .summary-row{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;align-items:end;margin:66px var(--pad) 8px}
    .summary-block{grid-column:span 6;text-align:center;min-width:0}
    .summary-block label{color:#0b3d2c;font-weight:900;letter-spacing:.02em;display:block;margin-bottom:6px;text-transform:uppercase;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .summary-block input{background:#f5fffb;color:#00a758;border:2px solid #00a758;border-radius:10px;font-size:16px;font-weight:900;height:56px;text-align:center;width:100%}
    .calc-wrap{display:flex;align-items:center;gap:10px}
    #calc-btn{background:#059669;color:#fff;border:none;border-radius:12px;padding:14px 24px;font-size:18px;font-weight:800;box-shadow:0 6px 18px rgba(0,81,193,.25);white-space:nowrap;cursor:pointer;touch-action:manipulation}
#calc-btn:hover{background:#00a758}

    /* ===== SMALL MOBILE ===== */
    @media (max-width: 480px){
      .header-grid{ padding: 8px 8px; }
      .logo-d{ height: 40px; }
      .title-top{ font-size: 12px; }
      .title-main{ font-size: 16px; }
      .login-cluster input{ width: 100%; }
      .login-btn{ min-width: 120px; font-size: 14px; }
      .top-fields,.top-fields-2{grid-template-columns:1fr;gap:8px}
      .field{grid-column:1/-1}
      .summary-row{grid-template-columns:1fr}
      .summary-block{grid-column:1/-1}
      
      /* Grid layout cho th√¥ng tin ƒë·∫°i l√Ω tr√™n mobile */
      .agent-info-grid {
        grid-template-columns: 1fr !important;
        gap: 8px;
        margin: 50px 12px 16px 12px;
        padding: 12px;
      }
      
      /* TOC Mobile tr√™n small mobile: chia 3 c·ªôt theo t·ª∑ l·ªá 2-2-1 */
      #tocMobile .row{ 
        display:grid; 
        grid-template-columns: 2fr 2fr 1fr; 
        gap:6px; 
      }
      
      .mobile-menu-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0;
      }
      
      /* ƒê·∫£m b·∫£o n√∫t t√≠nh thu nh·∫≠p hi·ªÉn th·ªã t·ªët tr√™n mobile */
      #calc-btn{
        width: 100%;
        margin-top: 12px;
        font-size: 16px;
        padding: 12px 20px;
      }
      .calc-wrap{
        width: 100%;
        justify-content: center;
      }
      
      /* Banner tr√™n small mobile - chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
      body.logged-in .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* ·∫®n TOC khi ch∆∞a ƒëƒÉng nh·∫≠p tr√™n small mobile */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* Sau khi ƒëƒÉng nh·∫≠p tr√™n small mobile */
      body.logged-in .header-grid {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      
      /* Logo v√† ti√™u ƒë·ªÅ cƒÉn gi·ªØa header theo chi·ªÅu ngang v√† d·ªçc */
      body.logged-in .brand-row {
        justify-content: center;
        align-items: center;
        margin-top: 8px;
      }
      
      /* ·∫®n c·ªôt form ƒëƒÉng nh·∫≠p sau khi ƒëƒÉng nh·∫≠p */
      body.logged-in .login-cluster {
        display: none !important;
      }
      
      /* Footer tr√™n small mobile */
      #pageFooter {
        padding: 5px 12px 6px;
      }
      
      .footer-left {
        gap: 4px;
      }
    }

     /* ===== AGENT SEARCH CONTAINER ===== */
     #agentSearchContainer {
       position: fixed;
       top: calc(var(--header-h) + 25px);
       left: var(--sidebar-width);
       right: 0;
       z-index: var(--z-content);
       background: #fff;
       padding: 0;
       margin: 0;
       border-bottom: 1px solid #e5e7eb;
       box-shadow: 0 2px 4px rgba(0,0,0,0.1);
     }

     /* Agent search results - r·ªông ƒë·∫øn footer tr√™n desktop */
     #agentSearchResults {
       position: fixed;
       top: calc(var(--header-h) + 25px + 80px); /* D∆∞·ªõi search container */
       left: var(--sidebar-width);
       right: 0;
       bottom: 0;
       z-index: var(--z-content);
       background: #fff;
       overflow-y: auto;
       overflow-x: hidden;
       padding: 20px 0 60px 0; /* Th√™m padding bottom ƒë·ªÉ tr√°nh che n√∫t h·ªó tr·ª£ */
       margin: 0;
       height: calc(100vh - var(--header-h) - 25px - 80px); /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·∫øn cu·ªëi viewport */
       /* C·∫£i thi·ªán scrollbar */
       scrollbar-width: thin;
       scrollbar-color: #0ea5e9 #f1f5f9;
     }
     
     /* Webkit scrollbar cho Chrome/Safari */
     #agentSearchResults::-webkit-scrollbar {
       width: 8px;
     }
     
     #agentSearchResults::-webkit-scrollbar-track {
       background: #f1f5f9;
       border-radius: 4px;
     }
     
     #agentSearchResults::-webkit-scrollbar-thumb {
       background: #0ea5e9;
       border-radius: 4px;
     }
     
     #agentSearchResults::-webkit-scrollbar-thumb:hover {
       background: #0284c7;
     }

    /* ===== MOBILE: M·ªñI D√íNG 1 TR∆Ø·ªúNG ===== */
     @media (max-width: 1023px){
      /* BRAND & LOGIN: brand (logo + t√™n) c√πng 1 d√≤ng; login m·ªói th√†nh ph·∫ßn 1 d√≤ng */
      .header-grid{ grid-template-columns:1fr; }
      
      /* TOC Mobile: 3 c·ªôt cho n√∫t theo t·ª∑ l·ªá 2-2-1 */
      #tocMobile .row{ 
        display:grid; 
        grid-template-columns: 2fr 2fr 1fr; 
        gap:6px; 
      }
      
      .mobile-menu-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0;
      }
       
       /* Agent search container tr√™n mobile */
       #agentSearchContainer {
         left: 0;
         right: 0;
         top: calc(var(--header-h) + 40px + 40px + 40px + 5px);
         padding: 0;
         margin: 0;
       }

      /* Agent search results tr√™n mobile - reset v·ªÅ normal flow */
      #agentSearchResults {
        position: static;
        top: auto;
        left: auto;
        right: auto;
        bottom: auto;
        background: #fff;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0;
        margin: 0 0 500px 0; /* Th√™m margin bottom ƒë·ªÉ tr√°nh footer che n·ªôi dung */
        max-height: calc(100vh - 200px - 150px); /* Gi·ªõi h·∫°n chi·ªÅu cao ƒë·∫øn tr∆∞·ªõc footer (tr·ª´ th√™m 150px cho footer) */
        /* C·∫£i thi·ªán scrollbar cho mobile */
        scrollbar-width: thin;
        scrollbar-color: #0ea5e9 #f1f5f9;
      }
      
      /* Webkit scrollbar cho mobile */
      #agentSearchResults::-webkit-scrollbar {
        width: 6px;
      }
      
      #agentSearchResults::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }
      
      #agentSearchResults::-webkit-scrollbar-thumb {
        background: #0ea5e9;
        border-radius: 3px;
      }
      
      #agentSearchResults::-webkit-scrollbar-thumb:hover {
        background: #0284c7;
      }
      .brand-row{ justify-content:flex-start; }
      .login-cluster{ 
        width:100%; 
        justify-self:stretch; 
        flex-direction: column;
        align-items: stretch;
      }
      
      /* ƒê·∫£m b·∫£o n√∫t t√≠nh thu nh·∫≠p hi·ªÉn th·ªã t·ªët tr√™n mobile */
      #calc-btn{
        width: 100%;
        margin-top: 12px;
        font-size: 16px;
        padding: 12px 20px;
      }
      .calc-wrap{
        width: 100%;
        justify-content: center;
      }
      
      /* Mobile container chi·ªÅu cao v·ª´a kh√≠t khi ƒëƒÉng nh·∫≠p code ƒë·∫∑c bi·ªát */
      .mobile-container {
        height: auto;
        min-height: auto;
      }
      
      .mobile-container-content {
        padding: 10px 16px;
        margin: 0;
      }
      
      .input-group {
        width: 100%;
      }
      .login-cluster input {
        width: 100%;
      }
      .logo-d{ height:44px; }
      .title-top{ font-size:clamp(13px, 1.6vw + 10px, 18px); }
      .title-main{ font-size:clamp(16px, 3vw + 10px, 24px); }

      .top-fields,.top-fields-2{grid-template-columns:1fr;gap:10px}
      .field{grid-column:1/-1}

      /* T·∫§T C·∫¢ C√ÅC KH·ªêI T√ìM T·∫ÆT c≈©ng 1 c·ªôt */
      .summary-row{grid-template-columns:1fr}
      .summary-block{grid-column:1/-1}

      body.sidebar-open #contentWrap{ margin-left:0 } /* mobile kh√¥ng ch·ª´a ch·ªó sidebar */
      body.logged-in #tocMobile{ display:block; }     /* dropdown lu√¥n hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p */
      
      /* Hi·ªÉn th·ªã banner v√† update date tr√™n mobile */
      body.logged-in #welcomeBanner{ display:block; }
      body.logged-in #mobileContainer{ display:block; }
      
      /* ·∫®n desktop update date tr√™n mobile */
      .desktop-update-date {
        display: none !important;
      }
      
      .sidebar-update-info {
        display: none !important;
      }
      
      /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ mobile container */
      body.logged-in #mobileContainer {
        top: calc(var(--header-h) + 40px);
      }
      
      /* Banner tr√™n mobile - chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
      body.logged-in .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* D·ªùi TOC mobile xu·ªëng d∆∞·ªõi update date */
      body.logged-in #tocMobile {
        top: calc(var(--header-h) + 40px + 40px);
      }
      
      /* ·∫®n TOC khi ch∆∞a ƒëƒÉng nh·∫≠p tr√™n mobile */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* ·∫®n n√∫t h·ªó tr·ª£ c≈© khi ƒë√£ ƒëƒÉng nh·∫≠p */
      body.logged-in #tocMobile::after {
        display: none !important;
      }
      
      /* Sau khi ƒëƒÉng nh·∫≠p tr√™n mobile */
      body.logged-in .header-grid {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      
      /* Logo v√† ti√™u ƒë·ªÅ cƒÉn gi·ªØa header theo chi·ªÅu ngang v√† d·ªçc */
      body.logged-in .brand-row {
        justify-content: center;
        align-items: center;
        margin-top: 10px;
      }
      
      /* ·∫®n c·ªôt form ƒëƒÉng nh·∫≠p sau khi ƒëƒÉng nh·∫≠p */
      body.logged-in .login-cluster {
        display: none !important;
      }
      
      /* ·∫®n n√∫t ƒëƒÉng xu·∫•t m√†u xanh l√° tr√™n mobile */
      body.logged-in .logout-only {
        display: none !important;
      }
      
      /* ·∫®n n√∫t h·ªó tr·ª£ desktop tr√™n mobile sau khi ƒëƒÉng nh·∫≠p */
      body.logged-in #supportDesk {
        display: none !important;
      }
      
      /* Footer tr√™n mobile */
      #pageFooter {
        flex-direction: column;
        gap: 6px;
        padding: 6px 15px 8px;
      }
      
      .footer-left {
        align-items: center;
        text-align: center;
        gap: 6px;
      }
      
      .footer-right {
        justify-content: center;
      }
    }
    /* ===== TABLET ===== */
    @media (min-width: 768px) and (max-width: 1023px){
      .header-grid{ padding: 12px 16px; }
      .logo-d{ height: 50px; }
      .title-top{ font-size: 16px; }
      .title-main{ font-size: 20px; }
      .top-fields,.top-fields-2{grid-template-columns:repeat(6,1fr);gap:14px}
      .field{grid-column:span 3}
      .summary-row{grid-template-columns:repeat(2,1fr);gap:16px}
      .summary-block{grid-column:span 1}
      
      /* Grid layout cho th√¥ng tin ƒë·∫°i l√Ω tr√™n tablet */
      .agent-info-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 12px;
        margin: 30px 16px 16px 16px;
        padding: 14px;
      }
      
      /* Grid layout cho 6 c·ªôt tr√™n tablet - chia th√†nh 2 h√†ng */
      .agent-info-grid:nth-of-type(2) {
        grid-template-columns: 1fr 1fr !important;
        grid-template-rows: 1fr 1fr 1fr !important;
      }
      
      /* Grid layout cho c√°c section kh√°c tr√™n tablet */
      #sec-khoanthu .agent-info-grid {
        grid-template-columns: 1fr 1fr !important;
      }
      
      #sec-tong .agent-info-grid {
        grid-template-columns: 1fr 1fr !important;
      }
      
      /* ƒê·∫£m b·∫£o n√∫t t√≠nh thu nh·∫≠p hi·ªÉn th·ªã t·ªët tr√™n tablet */
      #calc-btn{
        width: 100%;
        margin-top: 12px;
        font-size: 16px;
        padding: 12px 20px;
      }
      .calc-wrap{
        width: 100%;
        justify-content: center;
      }
      
      /* Banner tr√™n tablet - chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
      body.logged-in .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* ·∫®n TOC khi ch∆∞a ƒëƒÉng nh·∫≠p tr√™n tablet */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* Sau khi ƒëƒÉng nh·∫≠p tr√™n tablet */
      body.logged-in .header-grid {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      
      /* Logo v√† ti√™u ƒë·ªÅ cƒÉn gi·ªØa header theo chi·ªÅu ngang v√† d·ªçc */
      body.logged-in .brand-row {
        justify-content: center;
        align-items: center;
        margin-top: 12px;
      }
      
      /* ·∫®n c·ªôt form ƒëƒÉng nh·∫≠p sau khi ƒëƒÉng nh·∫≠p */
      body.logged-in .login-cluster {
        display: none !important;
      }
      
      /* Footer tr√™n tablet */
      #pageFooter {
        padding: 6px 18px 8px;
      }
      
      #supportFooter {
        padding: 8px 16px;
        font-size: 14px;
      }
      
      /* Footer tr√™n tablet */
      .footer-left {
        gap: 5px;
      }
      
      /* ·∫®n n√∫t h·ªó tr·ª£ desktop tr√™n tablet sau khi ƒëƒÉng nh·∫≠p */
      body.logged-in #supportDesk {
        display: none !important;
      }
    }

    @media (min-width: 1024px){
      body.logged-in #sidebar{ display:block; }
      body.logged-in.sidebar-open #supportDesk{ display:inline-flex; }
      
      /* Hi·ªÉn th·ªã banner tr√™n desktop */
      body.logged-in #welcomeBanner{ display:block; }
      
      /* Banner tr√™n desktop - cƒÉn theo sidebar */
      body.logged-in .welcome-banner {
        left: var(--sidebar-width);
        right: 0;
      }
      
      /* Banner khi sidebar ƒë√≥ng */
      body.logged-in:not(.sidebar-open) .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* ·∫®n t·∫•t c·∫£ mobile elements tr√™n desktop */
      #mobileContainer,
      #mobileAgentInfo,
      #mobileTOC,
      #mobileMenuBtn,
      #mobileLogoutBtn,
      #mobileMenuDropdown,
      #mobileAgentInfoButton,
      #mobileAgentInfoText,
      .mobile-update-date,
      .mobile-menu-btn,
      .mobile-calculate-other-btn,
      .mobile-logout-btn,
      .mobile-menu-dropdown,
      .mobile-agent-info,
      .mobile-container,
      .mobile-agent-info-content,
      .mobile-agent-info-text,
      .mobile-agent-info-button,
      .mobile-menu-content,
      .mobile-menu-item {
        display: none !important;
      }
      
      /* ·∫®n TOC khi ch∆∞a ƒëƒÉng nh·∫≠p tr√™n desktop */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* Hi·ªÉn th·ªã n√∫t ƒëƒÉng xu·∫•t tr√™n desktop */
      body.logged-in .logout-only {
        display: block !important;
      }
      
      /* ·∫®n n√∫t h·ªó tr·ª£ desktop sau khi ƒëƒÉng nh·∫≠p */
      body.logged-in #supportDesk {
        display: none !important;
      }
      
      /* Footer tr√™n desktop */
      #pageFooter {
        padding: 6px 20px 8px;
      }
      
      #supportFooter {
        padding: 8px 16px;
        font-size: 14px;
      }
    }

    /* ===== LARGE DESKTOP ===== */
    @media (min-width: 1440px){
      .header-grid{ padding: 16px 24px; }
      .logo-d{ height: 80px; }
      .title-top{ font-size: 22px; }
      .title-main{ font-size: 30px; }
      .top-fields,.top-fields-2{grid-template-columns:repeat(12,1fr);gap:20px}
      .field{grid-column:span 4}
      .summary-row{grid-template-columns:repeat(2,1fr);gap:20px}
      .summary-block{grid-column:span 1}
      main{ max-width: 1400px; }
    }

    /* ===== FOOTER ===== */
    #pageFooter{
      position:fixed; left:0; right:0; bottom:0;
      min-height:var(--footer-h);
      display:flex; flex-direction:row; align-items:center; justify-content:space-between;
      background:#f4f6f8; color:#0b3a2a; border-top:1px solid #e3e7eb; z-index:var(--z-footer);
      padding:6px 20px 8px; font-weight:800;
    }
    
    .footer-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-align: center;
    }
    
    .footer-right {
      display: flex;
      align-items: center;
    }
    
    #supportFooter {
      background: #00a758;
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    #supportFooter:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 167, 88, 0.3);
    }
    #pageFooter img{ height:22px; width:auto; display:block; }
    #contentWrap::after{ content:""; display:block; height: calc(0.75 * var(--footer-h) + 24px); }

    /* H·ªó tr·ª£ desktop - lu√¥n n·∫±m g√≥c d∆∞·ªõi ph√≠a tr√™n footer */
    #supportDesk{
      position:fixed; right:18px; bottom:calc(var(--footer-h) + 14px);
      background:#00a758;color:#fff;padding:12px 16px;border-radius:28px;font-weight:900;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,.18); z-index:var(--z-support); display:inline-flex !important;
    }
  </style>
</head>
<body class="logged-out">
  <!-- ===== HEADER ===== -->
  <header id="pageHeader" class="app-header">
    <div class="header-grid">
      <div class="brand-row">
         &#160;&#160;<img src="../logo.webp" alt="logo" class="logo-d" />
        <div class="title-wrap">
          <div class="title-top">H∆Ø∆†NG L√ä PMH</div>
          <div class="title-main">D·ª∞ T√çNH THU NH·∫¨P</div>
        </div>
      </div>

      <!-- C·ª•m ƒëƒÉng nh·∫≠p / ƒëƒÉng xu·∫•t -->
      <form id="loginForm" class="login-cluster">
        <div class="input-group">
          <input class="login-only" type="text" id="agent-id" placeholder="Nh·∫≠p MSDL" required />
          <div class="password-input-wrapper">
            <input class="login-only" type="password" id="ngay-gia-nhap" placeholder="Ng√†y gia nh·∫≠p" required />
            <button type="button" class="toggle-password" onclick="togglePassword()">
              <span class="eye-icon">üëÅÔ∏è</span>
            </button>
          </div>
        </div>
        <button id="loginBtn" class="login-btn login-only" type="submit">ƒêƒÉng nh·∫≠p</button>
        <button id="logoutBtn" class="login-btn logout-only" type="button" onclick="location.reload()">ƒêƒÉng xu·∫•t</button>
      </form>
      </div>
    <div id="errorTop"></div>
  </header>

  <!-- ===== WELCOME BANNER ===== -->
  <div id="welcomeBanner" class="welcome-banner">
    Xin ch√†o <span id="welcomeName"></span>
  </div>

  <!-- ===== NORMAL LOGIN CONTAINER ===== -->
  <div id="normalLoginContainer" class="normal-login-container" style="display: none;">
    <div class="normal-login-content">
      <div class="normal-login-update-date">
        D·ªØ li·ªáu c·∫≠p nh·∫≠t ƒë·∫øn ng√†y: <span id="normalLoginUpdateDateText"></span>
      </div>
        <button id="normalLoginManualButton" class="normal-login-button" onclick="enableManualInputMode(); return false;">
          T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ Code
        </button>
    </div>
  </div>

  <!-- ===== MOBILE CONTAINER ===== -->
  <div id="mobileContainer" class="mobile-container" style="display: none;">
    <div class="mobile-container-content">
      <div class="mobile-update-date">
        D·ªØ li·ªáu c·∫≠p nh·∫≠t ƒë·∫øn ng√†y: <span id="mobileUpdateDateText"></span>
      </div>
    </div>
  </div>

  <!-- ===== MOBILE AGENT INFO ===== -->
  <div id="mobileAgentInfo" class="mobile-agent-info" style="display: none;">
    <div class="mobile-agent-info-content">
      <div class="mobile-agent-info-text" id="mobileAgentInfoText">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript -->
      </div>
      <button id="mobileAgentInfoButton" class="mobile-agent-info-button">
        <!-- Text s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript -->
      </button>
    </div>
  </div>

  <!-- ===== LOADING SCREEN ===== -->
  <div id="loadingScreen" class="loading-screen" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>
  </div>

  <!-- ===== MOBILE TOC (treo d∆∞·ªõi header) ===== -->
  <div id="tocMobile">
    <div class="row">
      <button id="mobileMenuBtn" class="mobile-menu-btn">Danh m·ª•c</button>
      <button id="mobileCalculateOtherBtn" class="mobile-calculate-other-btn">T√≠nh cho ƒë·∫°i l√Ω kh√°c</button>
      <button id="mobileLogoutBtn" class="mobile-logout-btn">ƒêƒÉng xu·∫•t</button>
    </div>
    <!-- Mobile menu dropdown -->
    <div id="mobileMenuDropdown" class="mobile-menu-dropdown" style="display: none;">
      <div class="mobile-menu-content">
        <a href="#" class="mobile-menu-item" data-target="sec-daily">Th√¥ng tin ƒë·∫°i l√Ω</a>
        <a href="#" class="mobile-menu-item" data-target="sec-muctieu">A.1 M·ª•c ti√™u th√°ng</a>
        <a href="#" class="mobile-menu-item" data-target="sec-khoanthu">A.2 C√°c kho·∫£n thu nh·∫≠p</a>
        <a href="#" class="mobile-menu-item" data-target="sec-ban-hang">A.3 Thu nh·∫≠p b√°n h√†ng</a>
        <a href="#" class="mobile-menu-item" data-target="sec-tuyendung">B. Thu nh·∫≠p tuy·ªÉn d·ª•ng</a>
        <a href="#" class="mobile-menu-item" data-target="sec-quan-ly">C. Thu nh·∫≠p qu·∫£n l√Ω</a>
        <a href="#" class="mobile-menu-item" data-target="sec-tong">D. T·ªïng thu nh·∫≠p</a>
      </div>
    </div>
  </div>

  <!-- ===== SIDEBAR (desktop) ===== -->
  <aside id="sidebar">
    <div class="sidebar-inner">
      <!-- Th√¥ng tin ƒëang xem -->
      <div id="currentViewInfo" class="sidebar-update-info" style="display: none;">
        <div id="currentViewText">ƒêang xem th√¥ng tin ƒë·∫°i l√Ω</div>
      </div>
      
      <div class="menu-title">Danh m·ª•c</div>

      <a href="#" class="menu-item active" data-target="sec-daily">TH√îNG TIN ƒê·∫†I L√ù</a>

      <div class="menu-group">A. THU NH·∫¨P B√ÅN H√ÄNG</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sec-muctieu">1. M·ª•c ti√™u th√°ng</a>
        <a href="#" class="menu-item" data-target="sec-khoanthu">2. C√°c kho·∫£n thu nh·∫≠p</a>
        <a href="#" class="menu-item" data-target="sec-ban-hang">3. Thu nh·∫≠p</a>
      </div>

      <div class="menu-group">B. THU NH·∫¨P TUY·ªÇN D·ª§NG</div>
      <a href="#" class="menu-item" data-target="sec-tuyendung">Coming Soon</a>

      <div class="menu-group">C. THU NH·∫¨P QU·∫¢N L√ù</div>
      <a href="#" class="menu-item" data-target="sec-quan-ly">Coming Soon</a>

      <a href="#" class="menu-item" data-target="sec-tong">D. T·ªîNG THU NH·∫¨P</a>
    </div>
  </aside>

  <!-- ===== CONTENT ===== -->
  <a id="supportDesk" href="http://zalo.me/0376763390" target="_blank" rel="noopener">H·ªó tr·ª£</a>

  <div id="contentWrap">
    <main>
      <!-- 1) TH√îNG TIN ƒê·∫†I L√ù -->
      <section id="sec-daily" class="app-section">
        <div class="agent-info-grid">
          <div class="agent-field">
            <label for="ho-ten"><b>H·ªç v√† t√™n</b></label>
            <input type="text" id="ho-ten" readonly />
          </div>
          <div class="agent-field">
            <label for="khu-vuc"><b>Khu v·ª±c</b></label>
            <input type="text" id="khu-vuc" readonly />
          </div>
          <div class="agent-field">
            <label for="thang-lam-viec"><b>Th√¢m ni√™n (th√°ng)</b></label>
            <input type="text" id="thang-lam-viec" readonly />
          </div>
          <div class="agent-field">
            <label for="nhom-dai-ly"><b>Ph√¢n nh√≥m ƒë·∫°i l√Ω</b></label>
            <input type="text" id="nhom-dai-ly" readonly />
          </div>
        </div>
        <div class="agent-info-grid">
          <div class="agent-field">
            <label for="p13-ca-nhan"><b>P13 c√° nh√¢n</b></label>
            <input type="text" id="p13-ca-nhan" readonly />
          </div>
          <div class="agent-field">
            <label for="he-so-thuong"><b>H·ªá s·ªë t√≠nh th∆∞·ªüng</b></label>
            <input type="text" id="he-so-thuong" readonly />
          </div>
          <div class="agent-field">
            <label for="mdrt-fyp"><b>‚àë FYP DH MDRT</b></label>
            <input type="text" id="mdrt-fyp" readonly />
          </div>
          <div class="agent-field">
            <label for="tong-fyc"><b>‚àë FYC T-1 v√† T-2</b></label>
            <input type="text" id="tong-fyc" readonly />
          </div>
          <div class="agent-field">
            <label for="tong-fyc-quy"><b>‚àë FYC Qu√Ω hi·ªán t·∫°i</b></label>
            <input type="text" id="tong-fyc-quy" readonly />
          </div>
          <div class="agent-field">
            <label for="active-months"><b>S·ªë th√°ng c√≥ ho·∫°t ƒë·ªông trong Qu√Ω</b></label>
            <input type="text" id="active-months" readonly />
          </div>
        </div>
      </section>

      <!-- 2) A.1 M·ª§C TI√äU TH√ÅNG -->
      <section id="sec-muctieu" class="app-section" style="display:none">
        <div class="agent-info-grid">
          <div class="agent-field">
            <label for="month-select"><b>Th√°ng d·ª± t√≠nh</b></label>
            <select id="month-select"></select>
          </div>
        </div>


        <div id="memo-giai-doan">
          <div class="gd-stage">
            <b>Giai ƒëo·∫°n 1 (1-11/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd1"><b>FYP SP ch√≠nh</b></label><input type="text" id="fypchinh-gd1"/></div>
              <div class="field"><label for="fypkem-gd1"><b>FYP SP g·∫Øn k√®m</b></label><input type="text" id="fypkem-gd1"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd1"><b>S·ªë Hƒê</b></label><input type="text" id="sohd-gd1"/></div>
              <div class="field"><label for="fyp-gd1"><b>‚àë FYP</b></label><input type="text" id="fyp-gd1" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd1"><b>Th∆∞·ªüng Memo Giai ƒëo·∫°n 1</b></label><input type="text" id="thuongmemo-gd1" readonly/></div>
            </div>

            <!-- ‚úÖ C·∫£nh b√°o Gƒê1 -->
            <div class="top-fields-2">
              <div class="field"><span id="alert-gd1" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%""></span></div>
            </div>

            <!-- ‚úÖ C·ªù Hƒê 16tr FYP n·ªôp 1‚Äì8/9/2025 -->
            <div className="mt-6" style="margin-top: 8px; margin-bottom: 40px; margin-left: var(--pad); margin-right: var(--pad); padding: 20px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1);">
              <label className="font-medium block mb-3" style="font-weight: 700; display: block; margin-bottom: 16px; color: #0b3d2c; font-size: 18px; text-align: left; line-height: 1.3;">
                C√≥ h·ª£p ƒë·ªìng 16tr FYP n·ªôp t·ª´ 1‚Äì8/9/2025?
              </label>
              <div className="flex gap-6" style="display: flex; gap: 24px; margin-bottom: 16px; justify-content: flex-start;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 16px; font-weight: 600; padding: 8px 16px; background: #fff; border: 1px solid #0ea5e9; border-radius: 8px; transition: all 0.3s;">
                  <input
                    type="radio"
                    name="p1_has_16fyp_1to8Sep"
                    id="p1_has_16fyp_1to8Sep_yes"
                    style="margin-right: 12px; transform: scale(1.2);"
                  />
                  <span className="ml-2">C√≥</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 16px; font-weight: 600; padding: 8px 16px; background: #fff; border: 1px solid #0ea5e9; border-radius: 8px; transition: all 0.3s;">
                  <input
                    type="radio"
                    name="p1_has_16fyp_1to8Sep"
                    id="p1_has_16fyp_1to8Sep_no"
                    checked
                    style="margin-right: 12px; transform: scale(1.2);"
                  />
                  <span className="ml-2">Kh√¥ng</span>
                </label>
              </div>

              <div id="expectedCCContainer" style="margin-top: 16px; display: none; text-align: left;">
                <label className="block mb-2" style="display: block; margin-bottom: 8px; font-weight: 700; color: #0b3d2c; font-size: 16px;">S·ªë l∆∞·ª£ng CC d·ª± ki·∫øn</label>
                <input
                  type="number"
                  id="expectedCCCount"
                  min="1"
                  style="border: 2px solid #0ea5e9; border-radius: 8px; padding: 12px 16px; width: 180px; background-color: #fff; font-weight: 700; color: #0d7233; font-size: 16px; text-align: left;"
                  placeholder="‚â•1"
                />
                <div id="expectedCCWarning" style="display: none; margin-top: 8px; padding: 8px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626; font-weight: 600; font-size: 14px;"></div>
              </div>
            </div>
          </div>

          <div class="gd-stage">
            <b>Giai ƒëo·∫°n 2 (12-25/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd2"><b>FYP SP ch√≠nh</b></label><input type="text" id="fypchinh-gd2"/></div>
              <div class="field"><label for="fypkem-gd2"><b>FYP SP g·∫Øn k√®m</b></label><input type="text" id="fypkem-gd2"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd2"><b>S·ªë Hƒê</b></label><input type="text" id="sohd-gd2"/></div>
              <div class="field"><label for="fyp-gd2"><b>‚àë FYP</b></label><input type="text" id="fyp-gd2" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd2"><b>Th∆∞·ªüng Memo Giai ƒëo·∫°n 2</b></label><input type="text" id="thuongmemo-gd2" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><span id="alert-gd2" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%""></span></div>
            </div>
          </div>

          <div class="gd-stage">
            <b>Giai ƒëo·∫°n 3 (26-31/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd3"><b>FYP SP ch√≠nh</b></label><input type="text" id="fypchinh-gd3"/></div>
              <div class="field"><label for="fypkem-gd3"><b>FYP SP g·∫Øn k√®m</b></label><input type="text" id="fypkem-gd3"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd3"><b>S·ªë Hƒê</b></label><input type="text" id="sohd-gd3"/></div>
              <div class="field"><label for="fyp-gd3"><b>‚àë FYP</b></label><input type="text" id="fyp-gd3" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd3"><b>Th∆∞·ªüng Memo Giai ƒëo·∫°n 3</b></label><input type="text" id="thuongmemo-gd3" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><span id="alert-gd3" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%""></span></div>
            </div>
          </div>

          <br/>
          <div>
            <b style="margin-left:var(--pad)">T·ªîNG H·ª¢P</b>
            <div class="top-fields">
              <div class="field"><label for="tong-cc"><b>‚àë S·ªë l∆∞·ª£ng H·ª£p ƒë·ªìng</b></label><input type="text" id="tong-cc" readonly/></div>
              <div class="field"><label for="fyp-chinh"><b>‚àë FYP SP ch√≠nh</b></label><input type="text" id="fyp-chinh" readonly/></div>
              <div class="field"><label for="fyp-kem"><b>‚àë FYP SP g·∫Øn k√®m</b></label><input type="text" id="fyp-kem" readonly/></div>
            </div>
                    <div class="top-fields" style="align-items:center">
          <div class="field" style="flex:3"><label for="tong-fyp"><b>‚àë FYP T·ª´ c√°c Hƒê</b></label><input type="text" id="tong-fyp" readonly/></div>
          <div class="field" style="flex:3;display:flex;align-items:flex-end">
            <div class="calc-wrap">
              <button id="calc-btn" onclick="calculateIncome(); showSection('sec-khoanthu')">T√≠nh thu nh·∫≠p</button>

            </div>
          </div>
        </div>
          </div>
        </div>
      </section>

      <!-- 3) A.2 C√ÅC KHO·∫¢N THU NH·∫¨P -->
      <section id="sec-khoanthu" class="app-section" style="display:none">
        <div class="agent-info-grid">
          <div class="agent-field">
            <label><b>FYC SP ch√≠nh (30%)</b></label>
            <input type="text" id="fyc-chinh" readonly/>
          </div>
          <div class="agent-field">
            <label><b>FYC SP g·∫Øn k√®m (20%)</b></label>
            <input type="text" id="fyc-kem" readonly/>
          </div>
          <div class="agent-field">
            <label><b>Th∆∞·ªüng th√™m SP g·∫Øn k√®m (20%)</b></label>
            <input type="text" id="thuong-kem" readonly/>
          </div>
          <div class="agent-field">
            <label><b>FYC T√≠nh ch√≠nh s√°ch</b></label>
            <input type="text" id="fyc-thuong" readonly/>
          </div>
          <div class="agent-field">
            <label><b>Th∆∞·ªüng NSXS Manulife Pro</b></label>
            <input type="text" id="thuong-nspro" readonly/>
          </div>
          <div class="agent-field">
            <label><b>Th∆∞·ªüng NƒÉng su·∫•t h√†ng th√°ng</b></label>
            <input type="text" id="thuong-nst" readonly/>
          </div>
          <div class="agent-field">
            <label><b>Th∆∞·ªüng NƒÉng su·∫•t h√†ng Qu√Ω</b></label>
            <input type="text" id="thuong-nsq" readonly/>
          </div>
          <div class="agent-field">
            <label><b>Th∆∞·ªüng Ti·∫øn ƒë·ªô MDRT</b></label>
            <input type="text" id="thuong-mdrt" readonly/>
            <span id="alert-mdrt" style="color:#d62929;display:none"></span>
          </div>
        </div>
        <div class="top-fields">
          <div class="field"><label for="thuong-memo" class="income-note"><b>0001M08/2025/ASBD</b></label><input type="text" id="thuong-memo" readonly/></div>
        </div>

        <!-- ‚úÖ Th∆∞·ªüng th√™m kh√°c trong A.2 -->
        <div id="extraRewardsSectionA2" style="margin-top: 24px; margin-left: var(--pad); margin-right: var(--pad); display: none;">
          <h3 style="font-weight: 700; color: #0b3d2c; margin-bottom: 16px; font-size: 18px; padding: 12px 16px; background: #f0f9ff; border-left: 6px solid #0ea5e9; border-radius: 8px;">üéÅ TH∆Ø·ªûNG TH√äM KH√ÅC</h3>
          <ul id="extraRewardsListA2" style="margin: 0; padding: 0; list-style: none;">
            <!-- Danh s√°ch th∆∞·ªüng s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
          </ul>
        </div>

        <div class="top-fields">
          <div class="field"><span id="alert-gd1-summary" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%"></span></div>
        </div>
        <div class="top-fields">
          <div class="field"><span id="alert-gd2-summary" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%"></span></div>
        </div>
        <div class="top-fields">
          <div class="field"><span id="alert-gd3-summary" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%"></span></div>
        </div>
      </section>

      <!-- 4) A.3 THU NH·∫¨P B√ÅN H√ÄNG -->
      <section id="sec-ban-hang" class="app-section" style="display:none">
        <div class="summary-row">
          <div class="summary-block"><label for="tong-thu-nhap">T·ªïng thu nh·∫≠p b√°n h√†ng (A)</label><input type="text" id="tong-thu-nhap" readonly/></div>
          <div class="summary-block"><label for="ty-le-thu-nhap">T·ª∑ l·ªá thu nh·∫≠p/doanh thu</label><input type="text" id="ty-le-thu-nhap" readonly/></div>
        </div>

        <!-- ‚úÖ Th∆∞·ªüng th√™m kh√°c trong A.3 -->
        <div id="extraRewardsSectionA3" style="margin-top: 24px; margin-left: var(--pad); margin-right: var(--pad); display: none;">
          <h3 style="font-weight: 700; color: #0b3d2c; margin-bottom: 16px; font-size: 18px; padding: 12px 16px; background: #f0f9ff; border-left: 6px solid #0ea5e9; border-radius: 8px;">üéÅ TH∆Ø·ªûNG TH√äM KH√ÅC</h3>
          <ul id="extraRewardsListA3" style="margin: 0; padding: 0; list-style: none;">
            <!-- Danh s√°ch th∆∞·ªüng s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
          </ul>
        </div>

        <hr><div style="text-align:center;font-weight:900;color:#0d72b5;font-size:18px;padding:20px 0;border-left:6px solid #0d72b5;background:#f0f9ff;margin:20px 0;border-radius:8px">CH√öC B·∫†N S·ªû H·ªÆU T·ªêI ƒêA THU NH·∫¨P</div>
      </section>

      <!-- 5) B. TUY·ªÇN D·ª§NG -->
      <section id="sec-tuyendung" class="app-section" style="display:none">
        <div class="agent-info-grid">
          <div class="agent-field">
            <label><b>Thu nh·∫≠p tuy·ªÉn d·ª•ng (B)</b></label>
            <input type="text" id="thu-nhap-tuyen-dung" value="0" readonly />
          </div>
        </div>
        <div class="agent-info-grid">
          <div class="agent-field">
            <div style="color:#0ea35b;font-weight:900;text-align:center;padding:20px">Coming soon</div>
          </div>
        </div>
      </section>

      <!-- 6) C. QU·∫¢N L√ù -->
      <section id="sec-quan-ly" class="app-section" style="display:none">
        <div class="agent-info-grid">
          <div class="agent-field">
            <label><b>Thu nh·∫≠p qu·∫£n l√Ω (C)</b></label>
            <input type="text" id="thu-nhap-quan-ly" value="0" readonly />
          </div>
        </div>
        <div class="agent-info-grid">
          <div class="agent-field">
            <div style="color:#0ea35b;font-weight:900;text-align:center;padding:20px">Coming soon</div>
          </div>
        </div>
      </section>

      <!-- 7) D. T·ªîNG THU NH·∫¨P -->
      <section id="sec-tong" class="app-section" style="display:none">
        <div class="agent-info-grid">
          <div class="agent-field">
            <label for="tong-A"><b>A ‚Äî Thu nh·∫≠p b√°n h√†ng</b></label>
            <input type="text" id="tong-A" readonly/>
          </div>
          <div class="agent-field">
            <label for="tong-B"><b>B ‚Äî Thu nh·∫≠p tuy·ªÉn d·ª•ng</b></label>
            <input type="text" id="tong-B" readonly/>
          </div>
          <div class="agent-field">
            <label for="tong-C"><b>C ‚Äî Thu nh·∫≠p qu·∫£n l√Ω</b></label>
            <input type="text" id="tong-C" readonly/>
          </div>
          <div class="agent-field">
            <label for="tong-ABC"><b>D ‚Äî T·ªîNG THU NH·∫¨P (A + B + C)</b></label>
            <input type="text" id="tong-ABC" readonly/>
          </div>
        </div>

        <!-- ‚úÖ Th∆∞·ªüng th√™m kh√°c -->
        <div id="extraRewardsSection" style="margin-top: 24px; margin-left: var(--pad); margin-right: var(--pad); display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="font-weight: 600; color: #0b3d2c; margin: 0; font-size: 16px;">Th∆∞·ªüng th√™m kh√°c</h3>
            <button onclick="testExtraRewards()" style="background: #059669; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
              üß™ Test
            </button>
          </div>
          <ul id="extraRewardsList" style="margin: 0; padding: 0; list-style: none;">
            <!-- Danh s√°ch th∆∞·ªüng s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
          </ul>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer id="pageFooter">
    <div class="footer-left">
    <div>B·∫£n quy·ªÅn trang web thu·ªôc v·ªÅ</div>
    <p>H∆Ø∆†NG L√ä PMH‚Ñ¢</p>
    </div>
    <div class="footer-right">
      <a id="supportFooter" href="http://zalo.me/0376763390" target="_blank" rel="noopener">H·ªó tr·ª£</a>
    </div>
  </footer>

  <!-- ===== LOGIC (GI·ªÆ NGUY√äN, CH·ªà CH·ªàNH H√ÄNH VI CU·ªòN TR√äN MOBILE) ===== -->
  <script>
/* ===== GLOBAL VARS ===== */
let data=[],nspro=[],nst6=[],nst7=[],nsq6=[],nsq7=[],hsdt=[],trackingMDRT=[],smData=[];
let isDataReady=false, isLoggedIn=false;
let currentSpecialUser=null, currentCalculatingAgent=null, originalAgentData=null;

/* ===== DATA MODELS & CONSTANTS ===== */
// ‚úÖ Th√™m l·ª±a ch·ªçn ƒë·ªëi t∆∞·ª£ng t√≠nh thu nh·∫≠p
const IncomeTarget = {
  SELF: 'self',
  CANDIDATE_NOCODE: 'candidate_nocode'
};

// ‚úÖ M·∫∑c ƒë·ªãnh h·ªì s∆° "·ª®ng vi√™n/ƒêLM ch∆∞a loadcode"
const DEFAULT_CANDIDATE_NOCODE = {
  displayName: '·ª®ng vi√™n/ƒêLM ch∆∞a loadcode',
  region: undefined,          // gi·ªØ nguy√™n theo l·ª±a ch·ªçn UI hi·ªán c√≥
  seniorityMonths: 0,         // Th√¢m ni√™n: 0
  groupLevel: 'M0',           // Ph√¢n nh√≥m: M0
  p13: 100,                   // P13: 100
  bonusFactor: 1,             // H·ªá s·ªë th∆∞·ªüng: 1
  // C√°c tr∆∞·ªùng ti·ªÅn/ƒëi·ªÉm c√≤n l·∫°i: 0
  kpi1: 0, kpi2: 0, allowance: 0, otherPoints: 0, otherMoney: 0,
};

// ‚úÖ Ph√¢n quy·ªÅn cho m√£ ƒë·∫∑c bi·ªát
const SPECIAL_PERMISSIONS = {
  '28349': { // PSSM. L√™ H√† Thi√™n H∆∞∆°ng - Xem to√†n b·ªô
    name: 'PSSM. L√™ H√† Thi√™n H∆∞∆°ng',
    regions: 'ALL'
};

/* ===== PASSWORD TOGGLE ===== */
function togglePassword() {
  const dateInput = document.getElementById('ngay-gia-nhap');
  const eyeIcon = document.querySelector('.eye-icon');
  
  if (dateInput.type === 'password') {
    dateInput.type = 'text';
    eyeIcon.textContent = 'üôà';
  } else {
    dateInput.type = 'password';
    eyeIcon.textContent = 'üëÅÔ∏è';
  }
}

/* ===== MONEY HELPERS ===== */
const NF3=new Intl.NumberFormat('vi-VN',{minimumFractionDigits:3,maximumFractionDigits:3});
const formatMoney3=v=>Number.isFinite(+v)?NF3.format(+v):'';
function parseMoney3(s){ if(typeof s==='number')return s; if(!s)return 0; const n=parseFloat(String(s).replace(/\./g,'').replace(',','.')); return Number.isFinite(n)?n:0; }

/* ===== NUMERIC VALUE PARSER ===== */
// H√†m chung ƒë·ªÉ chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu t·ª´ text sang s·ªë
// X·ª≠ l√Ω ƒë·ªãnh d·∫°ng s·ªë v·ªõi d·∫•u . cho th·∫≠p ph√¢n (v√≠ d·ª•: 1.5, 2.75)
// √Åp d·ª•ng cho T·∫§T C·∫¢ c√°c tr∆∞·ªùng s·ªë: Active, FYC, FYP, MDRT-FYP, S·ªë th√°ng l√†m vi·ªác, v.v.
function parseActiveValue(value) {
  if (value === null || value === undefined || value === "") return 0;
  if (typeof value === "number") return value;
  if (typeof value === "string") {
    const trimmed = value.trim();
    if (trimmed === "" || trimmed === "0" || trimmed === "0.0" || trimmed === "0.00" || trimmed === "null" || trimmed === "undefined") return 0;
    
    // X·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát
    if (trimmed === "0.0" || trimmed === "0.00") return 0;
    
    // Chuy·ªÉn ƒë·ªïi sang s·ªë, d·∫•u . l√† d·∫•u th·∫≠p ph√¢n
    const num = parseFloat(trimmed);
    return isNaN(num) ? 0 : num;
  }
  return 0;
}

/* ===== ID LISTS ===== */
const MONEY_INPUT_IDS_EDITABLE=['fypchinh-gd1','fypkem-gd1','fypchinh-gd2','fypkem-gd2','fypchinh-gd3','fypkem-gd3'];
const COUNT_INPUT_IDS_EDITABLE=['sohd-gd1','sohd-gd2','sohd-gd3'];
const MONEY_OUTPUT_IDS=['fyp-gd1','fyp-gd2','fyp-gd3','fyp-chinh','fyp-kem','tong-fyp','fyc-chinh','fyc-kem','thuong-kem','fyc-thuong','thuong-nspro','thuong-nst','thuong-nsq','thuong-mdrt','thuongmemo-gd1','thuongmemo-gd2','thuongmemo-gd3','thuong-memo','mdrt-fyp','tong-fyc','tong-fyc-quy','tong-thu-nhap'];
const ALL_MONEY_IDS=[...new Set([...MONEY_INPUT_IDS_EDITABLE,...MONEY_OUTPUT_IDS])];

/* ===== DATE/LOOKUP HELPERS ===== */
const rmAccent=s=>s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
function normKeyMap(o){const m={};for(const k of Object.keys(o))m[rmAccent(k).replace(/\s+/g,'').toUpperCase()]=k;return m;}
function getByKeyLoose(row,target){const map=normKeyMap(row);const w=rmAccent(target).replace(/\s+/g,'').toUpperCase();return map[w]?row[map[w]]:undefined;}
function eqAgent(a,b){const n=x=>(x??'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();return n(a)===n(b);}
function standardizeDate(input){let s=input.trim().replace(/[^0-9]/g,'');if(s.length!==8)return input;return [s.slice(0,2),s.slice(2,4),s.slice(4,8)].join('/');}
function normalizeDateForCompare(v){if(!v)return'';const s=String(v).trim();const d=s.replace(/[^0-9]/g,'');if(d.length===8){const dd=d.slice(0,2),mm=d.slice(2,4),yy=d.slice(4,8);return yy+mm+dd;}const p=s.split(/[^0-9]+/).filter(Boolean);if(p.length===3){let[dd,mm,yy]=p.map(String);if(yy.length===2)yy=(+yy>=70?'19':'20')+yy;if(dd.length===1)dd='0'+dd;if(mm.length===1)mm='0'+mm;return yy+mm+dd;}return'';}
const datesEqual=(a,b)=>normalizeDateForCompare(a)===normalizeDateForCompare(b);

/* ===== LOAD DATA ===== */
async function fetchFirstJson(list){for(const url of list){try{const r=await fetch(url,{cache:'no-store'});if(r.ok)return await r.json();}catch{}}return null;}
async function loadData(){
  const btn=document.querySelector('button[onclick="searchAgent()"]'); if(btn){btn.disabled=true;btn.textContent="ƒêang t·∫£i d·ªØ li·ªáu...";}
  
  try{
    const r=await fetch('../income.json',{cache:'no-store'}); 
    if(!r.ok)throw new Error('HTTP '+r.status); 
    data=await r.json();
  }catch(e){
    console.error('Error loading income.json:', e);
    alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c income.json."); 
    data=[];
  }
  
  isDataReady=Array.isArray(data)&&data.length>0;
  console.log('loadData - income.json loaded:', isDataReady, 'records:', data.length);
  
  // Load c√°c file JSON kh√°c - s·ª≠a ƒë∆∞·ªùng d·∫´n ƒë·ªÉ tr·ªè v·ªÅ th∆∞ m·ª•c g·ªëc
  try {
    nspro=await fetchFirstJson(['../nspro.json','../NSPRO.json','../Nspro.json'])||[];
    nst6 =await fetchFirstJson(['../6nst.json','../6NST.json'])||[];
    nst7 =await fetchFirstJson(['../7nst.json','../7NST.json'])||[];
    nsq6 =await fetchFirstJson(['../6NSQ.json','../6nsq.json'])||[];
    nsq7 =await fetchFirstJson(['../7NSQ.json','../7nsq.json'])||[];
    hsdt =await fetchFirstJson(['../hsdt.json','../HSDT.json'])||[];
    trackingMDRT=await fetchFirstJson(['../trackingmdrt.json','../TRACKING MDRT.json','../TRACKING%20MDRT.json'])||[];
    smData=await fetchFirstJson(['../sm.json','../SM.json'])||[];
    
    console.log('loadData - nspro loaded:', nspro.length, 'records');
    console.log('loadData - nst6 loaded:', nst6.length, 'records');
    console.log('loadData - nst7 loaded:', nst7.length, 'records');
    console.log('loadData - nsq6 loaded:', nsq6.length, 'records');
    console.log('loadData - nsq7 loaded:', nsq7.length, 'records');
    console.log('loadData - hsdt loaded:', hsdt.length, 'records');
    console.log('loadData - trackingMDRT loaded:', trackingMDRT.length, 'records');
    
    // Ki·ªÉm tra d·ªØ li·ªáu c√≥ ƒë√∫ng ƒë·ªãnh d·∫°ng kh√¥ng
    if(nst6.length > 0) {
      console.log('loadData - nst6 sample data:', nst6[0]);
    }
    if(nsq6.length > 0) {
      console.log('loadData - nsq6 sample data:', nsq6[0]);
    }
    if(trackingMDRT.length > 0) {
      console.log('loadData - trackingMDRT sample data:', trackingMDRT[0]);
    }
    
  } catch(e) {
    console.error('Error loading other JSON files:', e);
  }
  
  if(btn){btn.disabled=false;btn.textContent="ƒêƒÉng nh·∫≠p";}
}

/* ===== MONTH SELECT ===== */
function getCurrentMonth(){return new Date().getMonth()+1;}
function populateMonthSelect(){const sel=document.getElementById('month-select'); if(!sel)return; sel.innerHTML=''; const cur=getCurrentMonth(); for(let m=cur;m<=12;m++){const op=document.createElement('option');op.value=m;op.textContent=`Th√°ng ${m}`;sel.appendChild(op);}}

/* ===== TH∆Ø·ªûNG/MEMO/T·ªîNG H·ª¢P ===== */
function getHeSoThuong(p13){const n=Number(p13);if(!isFinite(n))return 1;let best=1;for(const row of hsdt){const moc=row["P13 CA NHAN"];const tl=row["TY LE"];if(moc===null){best=tl||best;continue}if(n>=Number(moc))best=Number(tl)||best}return best}

// ‚úÖ H√†m filterContractsForRewards ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng logic ƒë∆°n gi·∫£n h∆°n
// S·ªë phi·∫øu thƒÉm iPhone 17 = t·ªïng s·ªë Hƒê ƒë√£ nh·∫≠p trong 3 giai ƒëo·∫°n
function optimizeMemo(fyp,ccLimit,m1,t1,m2,t2){const F=Math.max(0,+fyp||0);const limit=(ccLimit==null||ccLimit<=0)?Infinity:Math.max(0,Math.floor(ccLimit));let best=0,used=0;const max25=Math.floor(F/m1);const maxLoop=Math.min(max25,limit);for(let i=0;i<=maxLoop;i++){const rem=F-i*m1;const cap=(limit===Infinity)?Infinity:(limit-i);const j=Math.min(Math.floor(rem/m2),cap);const u=i+j;const r=i*t1+j*t2;if(r>best || (r===best && u<used)){best=r;used=u}}return{reward:best,used}}
function calcMemoStage(gd,sohd,tongFYP){let m1,t1,m2,t2;if(gd==='gd1'){m1=25000;t1=2500;m2=16000;t2=1500}else if(gd==='gd2'){m1=25000;t1=2000;m2=16000;t2=1000}else{m1=25000;t1=1500;m2=16000;t2=750}
  const optU=optimizeMemo(+tongFYP||0,Infinity,m1,t1,m2,t2);let res=optU,txt='';const cc=Math.max(0,+sohd||0);
  if(cc>0){if(cc<optU.used){res=optimizeMemo(+tongFYP||0,cc,m1,t1,m2,t2);txt=`Th∆∞·ªüng t·ªëi ∆∞u t·ª´ ${optU.used} Hƒê; b·∫°n nh·∫≠p ${cc} n√™n ch·ªâ t√≠nh t·ªëi ƒëa ${cc} Hƒê.`}else if(cc>optU.used){txt=`Ch·ªâ th∆∞·ªüng t·ªëi ƒëa ${optU.used} h·ª£p ƒë·ªìng!`}}
  document.getElementById('thuongmemo-'+gd).value=formatMoney3(res.reward);
  
  // Hi·ªÉn th·ªã c·∫£nh b√°o v·ªõi t√™n giai ƒëo·∫°n v√† d·∫•u c·∫£nh b√°o
  const gdNames = {gd1: 'Giai ƒëo·∫°n 1', gd2: 'Giai ƒëo·∫°n 2', gd3: 'Giai ƒëo·∫°n 3'};
  const alertText = txt ? `‚ÑπÔ∏è ${gdNames[gd]}: ${txt}` : '';
  
  // C·∫≠p nh·∫≠t c·∫£nh b√°o trong t·ª´ng giai ƒëo·∫°n
  const el = document.getElementById('alert-'+gd); 
  if(el){
    el.textContent = alertText; 
    el.style.display = txt ? 'block' : 'none';
  }
  
  // C·∫≠p nh·∫≠t c·∫£nh b√°o trong ph·∫ßn t·ªïng h·ª£p
  const elSummary = document.getElementById('alert-'+gd+'-summary');
  if(elSummary){
    elSummary.textContent = alertText;
    elSummary.style.display = txt ? 'block' : 'none';
  }
}
function updateTongHop(){
  const geti=id=>parseInt((document.getElementById(id).value||'').replace(/[^\d]/g,''),10)||0;
  const getn=id=>parseMoney3(document.getElementById(id).value);
  const cc1=geti('sohd-gd1'),cc2=geti('sohd-gd2'),cc3=geti('sohd-gd3');
  document.getElementById('tong-cc').value=cc1+cc2+cc3;
  const f1=getn('fypchinh-gd1'),f2=getn('fypchinh-gd2'),f3=getn('fypchinh-gd3');
  const k1=getn('fypkem-gd1'),k2=getn('fypkem-gd2'),k3=getn('fypkem-gd3');
  const sumC=f1+f2+f3, sumK=k1+k2+k3;
  document.getElementById('fyp-chinh').value=formatMoney3(sumC);
  document.getElementById('fyp-kem').value=formatMoney3(sumK);
  document.getElementById('fyp-gd1').value=formatMoney3(f1+k1);
  document.getElementById('fyp-gd2').value=formatMoney3(f2+k2);
  document.getElementById('fyp-gd3').value=formatMoney3(f3+k3);
  document.getElementById('tong-fyp').value=formatMoney3(sumC+sumK);
  calcMemoStage('gd1',cc1,f1+k1); calcMemoStage('gd2',cc2,f2+k2); calcMemoStage('gd3',cc3,f3+k3);
  const m1=parseMoney3(document.getElementById('thuongmemo-gd1').value);
  const m2=parseMoney3(document.getElementById('thuongmemo-gd2').value);
  const m3=parseMoney3(document.getElementById('thuongmemo-gd3').value);
  document.getElementById('thuong-memo').value=formatMoney3(m1+m2+m3);
  
  // ‚úÖ C·∫≠p nh·∫≠t th∆∞·ªüng th√™m kh√°c khi c√≥ thay ƒë·ªïi s·ªë Hƒê
  computeExtraRewards();
}

/* ===== NS PRO / NST / NSQ / MDRT ===== */
function isProGroup(txt){return /manulife\s*pro/i.test(txt)||/\bpro\b/i.test(txt)}
function calculateNSPro(){
  // 1. CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU V·ªÄ S·ªê TR∆Ø·ªöC KHI T√çNH
  const cc = parseInt(document.getElementById("tong-cc").value, 10) || 0;
  const tongFYP = parseMoney3(document.getElementById("tong-fyp").value) || 0;
  const nhom = getAgentGroupValue().trim();
  const heSo = parseFloat(document.getElementById("he-so-thuong").value) || 1;
  
  console.log('calculateNSPro - INPUT VALUES:', {
    tongCC: cc,
    tongFYP: tongFYP,
    nhomDaiLy: nhom,
    heSo: heSo
  });
  
  // 2. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN
  const nA = rmAccent(nhom);
  if(!cc || !nspro.length || !tongFYP || !isProGroup(nA)){
    console.log('calculateNSPro - conditions not met:', {
      hasCC: !!cc,
      hasNSProData: !!nspro.length,
      hasFYP: !!tongFYP,
      isProGroup: isProGroup(nA)
    });
    document.getElementById("thuong-nspro").value = formatMoney3(0);
    return;
  }
  
  // 3. TH·ª∞C HI·ªÜN LOGIC T√çNH TO√ÅN V·ªöI S·ªê
  let base = 0;
  for(const row of nspro){
    const need = parseMoney3(getByKeyLoose(row, "FYP CUA THANG XET THUONG")) || 0;
    
    console.log('calculateNSPro - checking row:', {
      need: need,
      currentFYP: tongFYP,
      condition: tongFYP >= need
    });
    
    if(tongFYP < need) continue;
    
    const keys = normKeyMap(row);
    let col = keys['MANULIFEPROBAC'] || keys['MANULIFEPROVANG'] || keys['MANULIFEPROBACHKIM'];
    
    if(/bach\s*kim/i.test(nA)) col = keys['MANULIFEPROBACHKIM'];
    else if(/vang/i.test(nA)) col = keys['MANULIFEPROVANG'];
    
    const rowValue = parseMoney3(col ? row[col] : 0) || 0;
    base = Math.max(base, rowValue);
    
    console.log('calculateNSPro - row calculation:', {
      availableKeys: Object.keys(keys),
      selectedCol: col,
      rowValue: rowValue,
      currentBest: base
    });
  }
  
  // 4. T√çNH K·∫æT QU·∫¢ CU·ªêI C√ôNG
  const result = base * heSo;
  
  console.log('calculateNSPro - FINAL CALCULATION:', {
    base: base,
    heSo: heSo,
    result: result
  });
  
  // 5. HI·ªÇN TH·ªä THEO ƒê·ªäNH D·∫†NG Y√äU C·∫¶U
  document.getElementById("thuong-nspro").value = formatMoney3(result);
}
function calculateNST(){
  // 1. CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU V·ªÄ S·ªê TR∆Ø·ªöC KHI T√çNH
  const th = parseInt(document.getElementById("thang-lam-viec").value, 10) || 0;
  const tongFYC = parseMoney3(document.getElementById("tong-fyc").value) || 0;
  const fycT = parseMoney3(document.getElementById("fyc-thuong").value) || 0;
  const heSo = parseFloat(document.getElementById("he-so-thuong").value) || 1;
  
  // 2. TH·ª∞C HI·ªÜN LOGIC T√çNH TO√ÅN V·ªöI S·ªê
  const sum = tongFYC + fycT;
  const table = th <= 6 ? nst6 : nst7;
  
  console.log('calculateNST - INPUT VALUES:', {
    thangLamViec: th,
    tongFYC: tongFYC,
    fycThuong: fycT,
    heSo: heSo,
    sum: sum,
    table: th <= 6 ? 'nst6' : 'nst7',
    tableData: table
  });
  
  let rate = 0;
  for(const row of table){
    const need = parseMoney3(getByKeyLoose(row, "FYC TRONG 3 THANG GAN NHAT")) || 0;
    const rowRate = parseFloat(getByKeyLoose(row, "% TY LE THUONG NANG SUAT THANG")) || 0;
    
    console.log('calculateNST - checking row:', {
      need: need,
      rowRate: rowRate,
      currentBest: rate,
      sum: sum,
      condition: sum >= need
    });
    
    if(sum >= need && rowRate >= rate) {
      rate = rowRate;
    }
  }
  
  // 3. T√çNH K·∫æT QU·∫¢ CU·ªêI C√ôNG
  const result = fycT * rate * heSo;
  
  console.log('calculateNST - CALCULATION:', {
    fycT: fycT,
    rate: rate,
    heSo: heSo,
    result: result
  });
  
  // 4. HI·ªÇN TH·ªä THEO ƒê·ªäNH D·∫†NG Y√äU C·∫¶U
  document.getElementById("thuong-nst").value = formatMoney3(result);
}
function calculateNSQ(){
  // 1. CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU V·ªÄ S·ªê TR∆Ø·ªöC KHI T√çNH
  const m = parseInt(document.getElementById("month-select").value, 10) || 0;
  const th = parseInt(document.getElementById("thang-lam-viec").value, 10) || 0;
  const cur = parseMoney3(document.getElementById("tong-fyc-quy").value) || 0;
  const fycT = parseMoney3(document.getElementById("fyc-thuong").value) || 0;
  const heSo = parseFloat(document.getElementById("he-so-thuong").value) || 1;
  const nh = getAgentGroupValue().trim();
  
  console.log('calculateNSQ - INPUT VALUES:', {
    month: m,
    thangLamViec: th,
    tongFYCQuy: cur,
    fycThuong: fycT,
    heSo: heSo,
    nhomDaiLy: nh
  });
  
  // 2. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN TH√ÅNG QU√ù
  if(![3,6,9,12].includes(m)){
    console.log('calculateNSQ - not a quarter month, setting to 0');
    document.getElementById("thuong-nsq").value = formatMoney3(0);
    return;
  }
  
  // 3. TH·ª∞C HI·ªÜN LOGIC T√çNH TO√ÅN V·ªöI S·ªê
  const sum = fycT + cur;
  const table = th <= 6 ? nsq6 : nsq7;
  const nA = rmAccent(nh);
  
  console.log('calculateNSQ - CALCULATION SETUP:', {
    sum: sum,
    table: th <= 6 ? 'nsq6' : 'nsq7',
    tableData: table,
    nhomNormalized: nA
  });
  
  let tl = 0;
  for(const row of table){
    const need = parseMoney3(getByKeyLoose(row, "FYC CUA QUY XET THUONG")) || 0;
    
    console.log('calculateNSQ - checking row:', {
      need: need,
      currentSum: sum,
      currentBest: tl,
      condition: sum >= need
    });
    
    if(sum >= need){
      const keys = normKeyMap(row);
      let val = (/manulife\s*pro/i.test(nA) || /manulife$/i.test(nA)) ? 
                 row[keys['MANULIFE']] : 
                 (row[keys['DLTHUONG']] || row[keys['DAILY']]);
      
      if(typeof val === 'string') val = val.replace('%', '');
      const r = (parseFloat(val) || 0) / 100;
      
      console.log('calculateNSQ - found rate:', {
        originalValue: val,
        rate: r,
        availableKeys: Object.keys(keys)
      });
      
      if(r >= tl) tl = r;
    }
  }
  
  // 4. T√çNH K·∫æT QU·∫¢ CU·ªêI C√ôNG
  const result = sum * tl * heSo;
  
  console.log('calculateNSQ - FINAL CALCULATION:', {
    sum: sum,
    tyLe: tl,
    heSo: heSo,
    result: result
  });
  
  // 5. HI·ªÇN TH·ªä THEO ƒê·ªäNH D·∫†NG Y√äU C·∫¶U
  document.getElementById("thuong-nsq").value = formatMoney3(result);
}
function calculateThuongMDRT(){
  const alertEl = document.getElementById('alert-mdrt');
  const setAlert = msg => { 
    if(alertEl){ 
      alertEl.textContent = msg || ''; 
      alertEl.style.display = msg ? 'block' : 'none'; 
    } 
  };

  // 1. CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU V·ªÄ S·ªê TR∆Ø·ªöC KHI T√çNH
  const m = parseInt(document.getElementById("month-select").value, 10) || 0; // Th√°ng ng∆∞·ªùi d√πng ch·ªçn
  const currentMonth = new Date().getMonth() + 1; // Th√°ng th·ª±c t·∫ø hi·ªán t·∫°i
  const activeMonths = parseInt((document.getElementById("active-months").value || '').replace(/[^\d]/g, ''), 10) || 0;
  const currentCC = parseInt((document.getElementById("tong-cc").value || '').replace(/[^\d]/g, ''), 10) || 0;
  const toDate = parseMoney3(document.getElementById("mdrt-fyp").value) || 0;
  const thisM = parseMoney3(document.getElementById("tong-fyp").value) || 0;
  
  console.log('calculateThuongMDRT - INPUT VALUES:', {
    selectedMonth: m,
    currentMonth: currentMonth,
    activeMonths: activeMonths,
    currentCC: currentCC,
    toDateFYP: toDate,
    thisMonthFYP: thisM
  });
  
  // 2. KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN TH√ÅNG QU√ù
  if(![3,6,9,12].includes(m)){ 
    console.log('calculateThuongMDRT - not a quarter month, setting to 0');
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    setAlert(''); 
    return; 
  }

  // 3. LOGIC C·∫¢NH B√ÅO TH√îNG MINH D·ª∞A TR√äN TH√ÅNG TH·ª∞C T·∫æ
  let alertMessage = '';
  
  // X√°c ƒë·ªãnh qu√Ω v√† v·ªã tr√≠ th√°ng trong qu√Ω
  let quarter, monthPosition;
  if (currentMonth >= 1 && currentMonth <= 3) {
    quarter = 1; monthPosition = currentMonth;
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    quarter = 2; monthPosition = currentMonth - 3;
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    quarter = 3; monthPosition = currentMonth - 6;
  } else {
    quarter = 4; monthPosition = currentMonth - 9;
  }
  
  console.log('calculateThuongMDRT - QUARTER ANALYSIS:', {
    quarter: quarter,
    monthPosition: monthPosition,
    isQuarterEnd: monthPosition === 3,
    isQuarterStart: monthPosition === 1,
    isQuarterMiddle: monthPosition === 2
  });
  
  // Tr∆∞·ªùng h·ª£p 1: Th√°ng th·ª±c t·∫ø l√† th√°ng cu·ªëi qu√Ω, tr√πng v·ªõi th√°ng ch·ªçn
  if (monthPosition === 3 && m === currentMonth) {
    if (activeMonths >= 2) {
      // T√≠nh th∆∞·ªüng b√¨nh th∆∞·ªùng
      alertMessage = '';
    } else {
      alertMessage = 'Kh√¥ng ƒë·ªß ti√™u chu·∫©n nh·∫≠n th∆∞·ªüng ti·∫øn ƒë·ªô';
    }
  }
  // Tr∆∞·ªùng h·ª£p 2: Th√°ng th·ª±c t·∫ø l√† th√°ng ƒë·∫ßu qu√Ω, kh√¥ng tr√πng v·ªõi th√°ng ch·ªçn
  else if (monthPosition === 1 && m !== currentMonth) {
    const monthsNeeded = 3 - activeMonths;
    alertMessage = `B·∫°n c·∫ßn th√™m ${monthsNeeded} th√°ng c√≥ ho·∫°t ƒë·ªông ƒë·ªÉ nh·∫≠n th∆∞·ªüng (bao g·ªìm th√°ng hi·ªán t·∫°i)`;
  }
  // Tr∆∞·ªùng h·ª£p 3: Th√°ng th·ª±c t·∫ø l√† th√°ng th·ª© 2 c·ªßa qu√Ω
  else if (monthPosition === 2) {
    // C·∫ßn ki·ªÉm tra th√°ng th·ª© 1 c√≥ ho·∫°t ƒë·ªông kh√¥ng
    // L·∫•y d·ªØ li·ªáu t·ª´ income.json ƒë·ªÉ ki·ªÉm tra
    const found = data.find(r => eqAgent(getByKeyLoose(r,"MA DAI LY"), document.getElementById("agent-id").value));
    if (found) {
      const currentMonthReal = new Date().getMonth() + 1;
      let month1, month2, month3;
      
      if (currentMonthReal >= 1 && currentMonthReal <= 3) {
        month1 = 1; month2 = 2; month3 = 3;
      } else if (currentMonthReal >= 4 && currentMonthReal <= 6) {
        month1 = 4; month2 = 5; month3 = 6;
      } else if (currentMonthReal >= 7 && currentMonthReal <= 9) {
        month1 = 7; month2 = 8; month3 = 9;
      } else {
        month1 = 10; month2 = 11; month3 = 12;
      }
      
      const activeMonth1 = parseActiveValue(getByKeyLoose(found, "HOAT DONG THANG T-1"));
      
      if (activeMonth1 > 0) {
        const monthsNeeded = 3 - activeMonths;
        alertMessage = `B·∫°n c·∫ßn th√™m ${monthsNeeded} th√°ng c√≥ ho·∫°t ƒë·ªông ƒë·ªÉ nh·∫≠n th∆∞·ªüng`;
      } else {
        alertMessage = 'Kh√¥ng ƒë·∫°t chu·∫©n';
      }
    }
  }
  
    // 4. LOGIC T√çNH TH∆Ø·ªûNG D·ª∞A TR√äN ƒêI·ªÄU KI·ªÜN TH√îNG MINH
  let canCalculateReward = false;
  let finalAlertMessage = '';
  
  // Tr∆∞·ªùng h·ª£p 1: Th√°ng th·ª±c t·∫ø l√† th√°ng cu·ªëi qu√Ω, tr√πng v·ªõi th√°ng ch·ªçn
  if (monthPosition === 3 && m === currentMonth) {
    if (activeMonths >= 2) {
      canCalculateReward = true;
      finalAlertMessage = '';
    } else {
      canCalculateReward = false;
      finalAlertMessage = 'Kh√¥ng ƒë·ªß ti√™u chu·∫©n nh·∫≠n th∆∞·ªüng ti·∫øn ƒë·ªô';
    }
  }
  // Tr∆∞·ªùng h·ª£p 2: Th√°ng th·ª±c t·∫ø l√† th√°ng ƒë·∫ßu qu√Ω, kh√¥ng tr√πng v·ªõi th√°ng ch·ªçn
  else if (monthPosition === 1 && m !== currentMonth) {
    canCalculateReward = false;
    const monthsNeeded = 3 - activeMonths;
    finalAlertMessage = `B·∫°n c·∫ßn th√™m ${monthsNeeded} th√°ng c√≥ ho·∫°t ƒë·ªông ƒë·ªÉ nh·∫≠n th∆∞·ªüng (bao g·ªìm th√°ng hi·ªán t·∫°i)`;
  }
  // Tr∆∞·ªùng h·ª£p 3: Th√°ng th·ª±c t·∫ø l√† th√°ng th·ª© 2 c·ªßa qu√Ω
  else if (monthPosition === 2) {
    // C·∫ßn ki·ªÉm tra th√°ng th·ª© 1 c√≥ ho·∫°t ƒë·ªông kh√¥ng
    const found = data.find(r => eqAgent(getByKeyLoose(r,"MA DAI LY"), document.getElementById("agent-id").value));
    if (found) {
      const currentMonthReal = new Date().getMonth() + 1;
      let month1, month2, month3;
      
      if (currentMonthReal >= 1 && currentMonthReal <= 3) {
        month1 = 1; month2 = 2; month3 = 3;
      } else if (currentMonthReal >= 4 && currentMonthReal <= 6) {
        month1 = 4; month2 = 5; month3 = 6;
      } else if (currentMonthReal >= 7 && currentMonthReal <= 9) {
        month1 = 7; month2 = 8; month3 = 9;
      } else {
        month1 = 10; month2 = 11; month3 = 12;
      }
      
      const activeMonth1 = parseActiveValue(getByKeyLoose(found, "HOAT DONG THANG T-1"));
      
      if (activeMonth1 > 0) {
        canCalculateReward = false;
        const monthsNeeded = 3 - activeMonths;
        finalAlertMessage = `B·∫°n c·∫ßn th√™m ${monthsNeeded} th√°ng c√≥ ho·∫°t ƒë·ªông ƒë·ªÉ nh·∫≠n th∆∞·ªüng`;
      } else {
        canCalculateReward = false;
        finalAlertMessage = 'Kh√¥ng ƒë·∫°t chu·∫©n';
      }
    }
  }
  
  // Ki·ªÉm tra ƒëi·ªÅu ki·ªán c∆° b·∫£n
  if(currentCC < 1){ 
    console.log('calculateThuongMDRT - no contracts this month');
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    setAlert('Ch∆∞a c√≥ h·ª£p ƒë·ªìng trong th√°ng x√©t'); 
    return; 
  }
  
  // N·∫øu kh√¥ng th·ªÉ t√≠nh th∆∞·ªüng theo logic th√¥ng minh
  if (!canCalculateReward) {
    console.log('calculateThuongMDRT - cannot calculate reward based on smart logic');
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    setAlert(finalAlertMessage); 
    return; 
  }
  
  // N·∫øu c√≥ th·ªÉ t√≠nh th∆∞·ªüng, ti·∫øp t·ª•c logic c≈©
  setAlert(finalAlertMessage || '');
  
  // 5. TH·ª∞C HI·ªÜN LOGIC T√çNH TO√ÅN V·ªöI S·ªê
  const progress = toDate + thisM;
  
  console.log('calculateThuongMDRT - CALCULATION SETUP:', {
    toDate: toDate,
    thisMonth: thisM,
    totalProgress: progress
  });
  
  const row = trackingMDRT.find(r => parseInt(getByKeyLoose(r, 'THANG XET'), 10) === m);
  console.log('calculateThuongMDRT - found tracking row:', row);
  
  if(!row){ 
    console.log('calculateThuongMDRT - no tracking data for month', m);
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    return; 
  }
  
  const need = parseMoney3(getByKeyLoose(row, 'FYP YEU CAU')) || 0;
  const muc1 = parseMoney3(getByKeyLoose(row, 'MUC 1 THAP')) || 
                parseMoney3(getByKeyLoose(row, 'MUC 1 THAP')) || 
                parseMoney3(getByKeyLoose(row, 'MUC 1 THAP')) || 0;
  const muc2 = parseMoney3(getByKeyLoose(row, 'MUC 2 CAO')) || 
                parseMoney3(getByKeyLoose(row, 'MUC 2 CAO')) || 0;
  
  console.log('calculateThuongMDRT - TRACKING DATA:', {
    requiredFYP: need,
    level1Reward: muc1,
    level2Reward: muc2
  });
  
  // 6. T√çNH K·∫æT QU·∫¢ CU·ªêI C√ôNG
  let thuong = 0; 
  if(need > 0 && progress > 0){
    const tl = progress / need; 
    console.log('calculateThuongMDRT - progress ratio:', tl);
    
    if(tl >= 1) thuong = muc2; 
    else if(tl >= 0.9) thuong = muc1;
  }
  
  console.log('calculateThuongMDRT - FINAL RESULT:', {
    progressRatio: progress / need,
    finalReward: thuong
  });
  
  // 7. HI·ªÇN TH·ªä THEO ƒê·ªäNH D·∫†NG Y√äU C·∫¶U
  document.getElementById("thuong-mdrt").value = formatMoney3(thuong);
}

/* ===== SPECIAL LOGIN FUNCTIONS ===== */
function performSpecialLogin(specialUser) {
  // Hi·ªÉn th·ªã loading screen
  showLoadingScreen();
  
  // ·∫®n mobile agent info khi ƒëƒÉng nh·∫≠p
  hideMobileAgentInfo();
  
  // Hi·ªÉn th·ªã banner ch√†o m·ª´ng sau 1 gi√¢y
  setTimeout(() => {
    hideLoadingScreen();
    
    // C·∫≠p nh·∫≠t t√™n trong banner
    const welcomeName = document.getElementById('welcomeName');
    if (welcomeName) {
      const fullName = specialUser.fullname || specialUser.name;
      const chucDanh = specialUser.chucDanh || specialUser.role || '';
      
      // Ch·ªâ hi·ªÉn th·ªã CHUC DANH + TEN DAI LY tr√™n mobile
      if (window.innerWidth <= 1023) {
        welcomeName.textContent = `${chucDanh} ${fullName}`.trim();
      } else {
        welcomeName.textContent = fullName;
      }
    }
    
    // Hi·ªÉn th·ªã banner
    const welcomeBanner = document.getElementById('welcomeBanner');
    if (welcomeBanner) {
      welcomeBanner.style.display = 'block';
    }
    
  // Hi·ªÉn th·ªã mobile container
  const mobileContainer = document.getElementById('mobileContainer');
  if (mobileContainer) {
    mobileContainer.style.display = 'block';
    const mobileUpdateDateText = document.getElementById('mobileUpdateDateText');
    if (mobileUpdateDateText) {
      // Fallback: L·∫•y ng√†y cu·ªëi c√πng c·ªßa th√°ng li·ªÅn tr∆∞·ªõc
      const now = new Date();
      let lastMonthYear = now.getFullYear();
      let lastMonthMonth = now.getMonth() - 1;
      
      if (lastMonthMonth < 0) {
        lastMonthMonth = 11;
        lastMonthYear = now.getFullYear() - 1;
      }
      
      const lastDayOfLastMonth = new Date(lastMonthYear, lastMonthMonth + 1, 0);
      mobileUpdateDateText.textContent = lastDayOfLastMonth.toLocaleDateString('vi-VN');
    }
  }
  
  // ·∫®n l·ª±a ch·ªçn "T√≠nh thu nh·∫≠p cho" khi d√πng m√£ ƒë·∫∑c bi·ªát
  hideIncomeTargetChoice();
    
    // Kh√¥ng c·∫ßn hi·ªÉn th·ªã update date n·ªØa
    
    // ƒê·ª£i d·ªØ li·ªáu load xong r·ªìi m·ªõi hi·ªÉn th·ªã √¥ t√¨m ki·∫øm
    if (isDataReady && data && data.length > 0) {
      showAgentSearchBox();
    } else {
      // N·∫øu d·ªØ li·ªáu ch∆∞a s·∫µn s√†ng, th·ª≠ load l·∫°i
      loadData().then(() => {
        if (isDataReady && data && data.length > 0) {
          showAgentSearchBox();
        } else {
          alert('Kh√¥ng th·ªÉ load d·ªØ li·ªáu. Vui l√≤ng refresh trang.');
        }
      });
    }
    
  }, 1000);
  
  isLoggedIn = true;
  // B·∫≠t giao di·ªán sau ƒëƒÉng nh·∫≠p
  document.body.classList.remove('logged-out');
  document.body.classList.add('logged-in');
  applySidebarMode();
  buildMobileTOC();
  
  // ·∫®n n√∫t gi·ªØa TOC cho ng∆∞·ªùi d√πng ƒë·∫∑c bi·ªát tr√™n mobile
  const mobileCalculateOtherBtn = document.getElementById('mobileCalculateOtherBtn');
  if (mobileCalculateOtherBtn) {
    mobileCalculateOtherBtn.style.display = 'none';
  }
  
  showSection('sec-daily');
  setLayoutVars();
}

function showAgentSearchBox() {
  console.log('showAgentSearchBox called');
  
  // Ki·ªÉm tra xem container ƒë√£ t·ªìn t·∫°i ch∆∞a
  let searchContainer = document.getElementById('agentSearchContainer');
  
  if (!searchContainer) {
    // T·∫°o container t√¨m ki·∫øm ƒë·∫°i l√Ω m·ªõi
    searchContainer = document.createElement('div');
    searchContainer.id = 'agentSearchContainer';
  
  searchContainer.innerHTML = `
    <div style="display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 12px; align-items: center; max-width: 100%; margin: 0 auto; padding: 12px 16px;">
      <input 
        type="text" 
        id="agentSearchInput" 
        placeholder="MSƒêL/T√™n ƒêL" 
        onkeydown="if(event.key==='Enter'){console.log('Enter pressed in search input'); event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); testInput(); return false;}"
        style="height: 44px; padding: 0 12px; border: 1px solid #b7e7ce; border-radius: 8px; font-size: 12px; width: 100%;"
      />
      <button 
        id="searchAgentBtn" 
        type="button"
        onclick="testInput(); return false;"
        style="height: 44px; padding: 0 12px; background: #059669; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 10.5px;"
      >
        T√¨m ki·∫øm
      </button>
      <button 
        id="manualInputBtn" 
        type="button"
        onclick="enableManualInputMode(); return false;"
        style="height: 44px; padding: 0 12px; background: #f59e0b; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 10.5px; width: 100%; line-height: 1.2;"
      >
        T√≠nh cho ƒë·∫°i l√Ω<br>ch∆∞a c√≥ code
      </button>
    </div>
    <div id="agentSearchResults" style="margin-top: 0;"></div>
  `;
  }
  
  // ·∫®n n√∫t n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô th·ªß c√¥ng
  const manualInputBtn = document.getElementById('manualInputBtn');
  if (manualInputBtn && currentCalculatingAgent && currentCalculatingAgent.isManualMode) {
    manualInputBtn.style.display = 'none';
  }
  
  // Th√™m v√†o contentWrap n·∫øu ch∆∞a c√≥
  if (!searchContainer.parentNode) {
    const contentWrap = document.getElementById('contentWrap');
    if (contentWrap) {
      contentWrap.insertBefore(searchContainer, contentWrap.firstChild);
      console.log('Search container added to contentWrap');
    } else {
      console.log('contentWrap not found');
    }
  }
  
  // Hi·ªÉn th·ªã container t√¨m ki·∫øm
  searchContainer.style.display = 'block';
  console.log('Search container displayed');
  
  // Th√™m class ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠ mobile agent info
  document.body.classList.add('showing-agent-search');
  
  // ·∫®n n·ªôi dung ch√≠nh khi hi·ªÉn th·ªã √¥ t√¨m ki·∫øm
  hideMainContent();
  
  // Event listeners ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω tr·ª±c ti·∫øp trong HTML
  console.log('Search container ready with inline event handlers');
}

function hideMainContent() {
  console.log('hideMainContent called');
  
  // ·∫®n t·∫•t c·∫£ c√°c section n·ªôi dung
  const sections = document.querySelectorAll('.app-section');
  console.log('Found sections:', sections.length);
  sections.forEach((section, index) => {
    console.log(`Hiding section ${index}:`, section.id);
    section.style.display = 'none';
  });
  
  // ·∫®n mobile TOC
  const mobileTOC = document.getElementById('mobileTOC');
  if (mobileTOC) {
    console.log('Hiding mobile TOC');
    mobileTOC.style.display = 'none';
  }
  
  // ·∫®n c√°c element kh√°c c√≥ th·ªÉ hi·ªÉn th·ªã n·ªôi dung
  const contentElements = document.querySelectorAll('#contentWrap > *:not(#agentSearchContainer)');
  contentElements.forEach(el => {
    if (el.classList.contains('app-section') || el.id === 'mobileTOC') {
      // ƒê√£ x·ª≠ l√Ω ·ªü tr√™n
    } else {
      console.log('Hiding other content element:', el);
      el.style.display = 'none';
    }
  });
}

function showMainContent() {
  console.log('showMainContent called');
  
  // Hi·ªÉn th·ªã l·∫°i c√°c section n·ªôi dung
  const sections = document.querySelectorAll('.app-section');
  console.log('Found sections:', sections.length);
  sections.forEach(section => {
    section.style.display = 'block';
    console.log('Showing section:', section.id);
  });
  
  // Hi·ªÉn th·ªã l·∫°i mobile TOC
  const mobileTOC = document.getElementById('mobileTOC');
  if (mobileTOC) {
    mobileTOC.style.display = 'block';
    console.log('Showing mobile TOC');
  }
  
  // Hi·ªÉn th·ªã l·∫°i contentWrap
  const contentWrap = document.getElementById('contentWrap');
  if (contentWrap) {
    contentWrap.style.display = 'block';
    console.log('Showing contentWrap');
  }
  
  // Hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£ c√°c element con c·ªßa contentWrap
  const contentElements = document.querySelectorAll('#contentWrap > *');
  contentElements.forEach(el => {
    if (el.id !== 'agentSearchContainer') {
      el.style.display = '';
      console.log('Showing content element:', el.id || el.className);
    }
  });
}

function searchForAgent() {
  console.log('searchForAgent called');
  
  // L·∫•y input element
  const inputElement = document.getElementById('agentSearchInput');
  console.log('Input element:', inputElement);
  
  if (!inputElement) {
    console.log('Input element not found');
    alert('Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu');
    return;
  }
  
  // L·∫•y gi√° tr·ªã input
  let searchTerm = inputElement.value;
  console.log('Raw searchTerm from input:', searchTerm);
  console.log('Raw searchTerm type:', typeof searchTerm);
  
  if (searchTerm) {
    searchTerm = searchTerm.trim();
  }
  
  console.log('Trimmed searchTerm:', searchTerm);
  console.log('searchTerm length:', searchTerm ? searchTerm.length : 0);
  
  if (!searchTerm) {
    console.log('Search term is empty after trim');
    alert('Vui l√≤ng nh·∫≠p m√£ ƒë·∫°i l√Ω ho·∫∑c t√™n ƒë·∫°i l√Ω');
    return;
  }
  
  // Debug: Ki·ªÉm tra d·ªØ li·ªáu
  console.log('searchForAgent - searchTerm:', searchTerm);
  console.log('searchForAgent - data length:', data.length);
  console.log('searchForAgent - isDataReady:', isDataReady);
  
  if (!isDataReady) {
    document.getElementById('agentSearchResults').innerHTML = `
      <div style="color: #dc2626; font-weight: 600; text-align: center; padding: 20px;">
        D·ªØ li·ªáu ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.
      </div>
    `;
    return;
  }
  
  if (!data || data.length === 0) {
    document.getElementById('agentSearchResults').innerHTML = `
      <div style="color: #0ea5e9; font-weight: 600; text-align: center; padding: 20px;">
        Vui l√≤ng nh·∫≠p th√¥ng tin t√¨m ki·∫øm v√† th·ª±c hi·ªán t√¨m ki·∫øm.
      </div>
    `;
    return;
  }
  
  // B∆∞·ªõc 1: T√¨m ki·∫øm theo MA DAI LY tr∆∞·ªõc
  let foundAgents = data.filter(agent => {
    const agentMSDL = agent["MA DAI LY"];
    return agentMSDL && agentMSDL.toString().toLowerCase() === searchTerm.toLowerCase();
  });
  
  console.log('searchForAgent - found by MA DAI LY:', foundAgents.length);
  
  // B∆∞·ªõc 2: N·∫øu kh√¥ng t√¨m th·∫•y theo m√£, t√¨m ki·∫øm theo t√™n trong c·ªôt TEN DAI LY
  if (foundAgents.length === 0) {
    foundAgents = data.filter(agent => {
      const agentName = agent["TEN DAI LY"] || "";
      return agentName.toLowerCase().includes(searchTerm.toLowerCase());
    });
    console.log('searchForAgent - found by TEN DAI LY:', foundAgents.length);
  }
  
  if (foundAgents.length === 0) {
    document.getElementById('agentSearchResults').innerHTML = `
      <div style="color: #dc2626; font-weight: 600; text-align: center; padding: 20px;">
        Kh√¥ng t√¨m th·∫•y ƒë·∫°i l√Ω v·ªõi t·ª´ kh√≥a: ${searchTerm}
      </div>
    `;
    return;
  }
  
  // L·ªçc theo quy·ªÅn truy c·∫≠p
  const accessibleAgents = foundAgents.filter(agent => {
    const agentRegion = agent["KHU VUC"];
    return hasRegionAccess(agentRegion, currentSpecialUser.regions);
  });
  
  if (accessibleAgents.length === 0) {
    document.getElementById('agentSearchResults').innerHTML = `
      <div style="color: #dc2626; font-weight: 600; text-align: center; padding: 20px;">
        B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p th√¥ng tin ƒë·∫°i l√Ω v·ªõi t·ª´ kh√≥a: ${searchTerm}
      </div>
    `;
    return;
  }
  
  // Hi·ªÉn th·ªã danh s√°ch k·∫øt qu·∫£ v·ªõi kh·∫£ nƒÉng cu·ªôn
  let resultsHTML = `
    <div style="
      margin-top: 0px; 
      max-height: none; 
      overflow-y: visible; 
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: #0ea5e9 #f1f5f9;
    ">
      <style>
        .agent-results::-webkit-scrollbar {
          width: 6px;
        }
        .agent-results::-webkit-scrollbar-track {
          background: #f1f5f9;
          border-radius: 3px;
        }
        .agent-results::-webkit-scrollbar-thumb {
          background: #0ea5e9;
          border-radius: 3px;
        }
        .agent-results::-webkit-scrollbar-thumb:hover {
          background: #0284c7;
        }
      </style>
  `;
  
  accessibleAgents.forEach((agent, index) => {
    const agentId = agent["MA DAI LY"];
    const agentName = agent["fullname"] || agent["FULLNAME"] || agent["TEN DAI LY"] || "ƒê·∫°i l√Ω";
    const agentRegion = agent["KHU VUC"];
    const agentGroup = agent["NHOM DAI LY"] || "";
    
    resultsHTML += `
      <div style="display: flex; justify-content: center; margin-bottom: 8px; padding: 0 8px;">
        <button 
          id="agentNameClickable_${index}" 
          data-agent-id="${agentId}"
          style="
            width: 98%; 
            background: #f0f9ff; 
            border: 1px solid #0ea5e9; 
            border-radius: 8px; 
            padding: 12px 16px; 
            cursor: pointer; 
            transition: all 0.2s ease;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 2px;
          "
          onmouseover="this.style.backgroundColor='#e0f2fe'; this.style.borderColor='#0284c7'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(14, 165, 233, 0.2)'"
          onmouseout="this.style.backgroundColor='#f0f9ff'; this.style.borderColor='#0ea5e9'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
        >
          <div style="font-weight: 700; color: #0b3d2c; font-size: 16px; line-height: 1.1;">
            ${agentName}
          </div>
          <div style="color: #059669; font-size: 12px; font-weight: 600;">
            Khu v·ª±c: ${agentRegion} | ${agentGroup}
          </div>
        </button>
      </div>
    `;
  });
  
  resultsHTML += '</div>';
  document.getElementById('agentSearchResults').innerHTML = resultsHTML;
  
  // Event listeners cho t·∫•t c·∫£ c√°c button
  accessibleAgents.forEach((agent, index) => {
    const agentButton = document.getElementById(`agentNameClickable_${index}`);
    if (agentButton) {
      agentButton.addEventListener('click', () => calculateForAgent(agent["MA DAI LY"], agent));
    }
  });
}

function calculateForAgent(agentId, agentData) {
  currentCalculatingAgent = { id: agentId, data: agentData };
  
  // ·∫®n mobile agent info khi ƒëƒÉng nh·∫≠p
  hideMobileAgentInfo();
  
  // C·∫≠p nh·∫≠t t√™n trong banner t·ª´ income.json
  const welcomeName = document.getElementById('welcomeName');
  if (welcomeName) {
    const fullName = agentData["TEN DAI LY"] || '';
    const chucDanh = agentData["CHUC DANH"] || '';
    
    // Ch·ªâ hi·ªÉn th·ªã CHUC DANH + TEN DAI LY tr√™n mobile
    console.log('Debug calculateForAgent banner:', { chucDanh, fullName, windowWidth: window.innerWidth });
    if (window.innerWidth <= 1023) {
      welcomeName.textContent = `${chucDanh} ${fullName}`.trim();
      console.log('Mobile banner set to:', welcomeName.textContent);
    } else {
    welcomeName.textContent = fullName;
      console.log('Desktop banner set to:', welcomeName.textContent);
    }
  }
  
  // C·∫≠p nh·∫≠t th√¥ng tin ƒë·∫°i l√Ω trong form (s·ª≠ d·ª•ng tr·ª±c ti·∫øp t·ª´ income.json)
  document.getElementById("ho-ten").value = agentData["TEN DAI LY"] || '';
  document.getElementById("khu-vuc").value = agentData["KHU VUC"] || '';
  document.getElementById("thang-lam-viec").value = parseActiveValue(agentData["SO THANG LAM VIEC"]);
  // C·∫≠p nh·∫≠t tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω (c√≥ th·ªÉ l√† input ho·∫∑c dropdown)
  const nhomDaiLyValue = agentData["NHOM DAI LY"] || '';
  const manualDropdown = document.getElementById('nhom-dai-ly-dropdown');
  if (manualDropdown) {
    // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô th·ªß c√¥ng v·ªõi dropdown
    manualDropdown.value = nhomDaiLyValue;
  } else {
    // N·∫øu l√† input th√¥ng th∆∞·ªùng
    const inputField = document.getElementById('nhom-dai-ly');
    if (inputField) {
      inputField.value = nhomDaiLyValue;
    }
  }
  const p13 = parseActiveValue(agentData["TLDTHD CA NHAN"] ?? agentData["P13 CA NHAN"]);
  document.getElementById("p13-ca-nhan").value = Number.isFinite(p13) && p13 !== 0 ? p13 : '';
  document.getElementById("he-so-thuong").value = getHeSoThuong(p13);
  document.getElementById("mdrt-fyp").value = formatMoney3(parseActiveValue(agentData["MDRT-FYP TOI HIEN TAI"]));
  const fycT1 = parseActiveValue(agentData["FYC THANG T-1"]);
  const fycT2 = parseActiveValue(agentData["FYC THANG T-2"]);
  document.getElementById("tong-fyc").value = formatMoney3(fycT1 + fycT2);
  document.getElementById("tong-fyc-quy").value = formatMoney3(parseActiveValue(agentData["TONG FYC TRONG QUY HIEN TAI"]));
  
  // T√≠nh s·ªë th√°ng c√≥ ho·∫°t ƒë·ªông (s·ª≠ d·ª•ng tr·ª±c ti·∫øp t·ª´ income.json)
  const currentMonth = new Date().getMonth() + 1;
  let month1, month2, month3;
  
  if (currentMonth >= 1 && currentMonth <= 3) {
    month1 = 1; month2 = 2; month3 = 3;
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    month1 = 4; month2 = 5; month3 = 6;
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    month1 = 7; month2 = 8; month3 = 9;
  } else {
    month1 = 10; month2 = 11; month3 = 12;
  }
  
  let activeT, activeT1, activeT2;
  
  if (currentMonth === month1) {
    activeT = agentData["HOAT DONG THANG T"];
    activeT1 = 0; activeT2 = 0;
  } else if (currentMonth === month2) {
    activeT = agentData["HOAT DONG THANG T"];
    activeT1 = agentData["HOAT DONG THANG T-1"];
    activeT2 = 0;
  } else {
    activeT = agentData["HOAT DONG THANG T"];
    activeT1 = agentData["HOAT DONG THANG T-1"];
    activeT2 = agentData["HOAT DONG THANG T-2"];
  }
  
  const activeTNum = parseActiveValue(activeT);
  const activeT1Num = parseActiveValue(activeT1);
  const activeT2Num = parseActiveValue(activeT2);
  
  let activeMonthsCount = 0;
  if (activeTNum > 0) activeMonthsCount++;
  if (activeT1Num > 0) activeMonthsCount++;
  if (activeT2Num > 0) activeMonthsCount++;
  
  document.getElementById("active-months").value = activeMonthsCount.toString();
  
  // Reset c√°c tr∆∞·ªùng nh·∫≠p li·ªáu
  ["sohd-gd1", "sohd-gd2", "sohd-gd3", "fypchinh-gd1", "fypchinh-gd2", "fypchinh-gd3", "fypkem-gd1", "fypkem-gd2", "fypkem-gd3"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  sanitizeAllNumericInputs();
  updateTongHop();
  calculateTongThuNhap();
  syncReadonlyTitles();
  
  // ·∫®n √¥ t√¨m ki·∫øm v√† hi·ªÉn th·ªã th√¥ng tin ƒë·∫°i l√Ω trong sidebar
  hideAgentSearchBox();
  showCalculatingAgentInfo();
  
  // Hi·ªÉn th·ªã mobile agent info cho ng∆∞·ªùi d√πng ƒë·∫∑c bi·ªát
  if (currentSpecialUser) {
    showMobileCalculatingAgentInfo();
  }
  
  // Hi·ªÉn th·ªã l·∫°i n·ªôi dung ch√≠nh
  showMainContent();
  
  // Chuy·ªÉn ƒë·∫øn section th√¥ng tin ƒë·∫°i l√Ω
  showSection('sec-daily');
}

function hideAgentSearchBox() {
  // ·∫®n to√†n b·ªô container t√¨m ki·∫øm ƒë·∫°i l√Ω
  const agentSearchContainer = document.getElementById('agentSearchContainer');
  if (agentSearchContainer) {
    agentSearchContainer.style.display = 'none';
    console.log('Hidden agentSearchContainer');
  }
  
  // X√≥a class ƒë·ªÉ reset v·ªã tr√≠ mobile agent info
  document.body.classList.remove('showing-agent-search');
  
  // ·∫®n mobile agent info khi ·∫©n search box
  hideMobileAgentInfo();
}

function showAgentSearchBoxAgain() {
  console.log('showAgentSearchBoxAgain called');
  
  // X√≥a t·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i
  clearAllFields();
  
  // ·∫®n mobile agent info
  hideMobileAgentInfo();
  
  // ·∫®n container ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng
  hideNormalLoginContainer();
  
  // X√≥a class after-calculate-other ƒë·ªÉ reset v·ªã tr√≠ mobile agent info
  document.body.classList.remove('after-calculate-other');
  
  // ƒê·∫£m b·∫£o container search agent t·ªìn t·∫°i v√† hi·ªÉn th·ªã ƒë√∫ng
  let searchContainer = document.getElementById('agentSearchContainer');
  if (!searchContainer) {
  showAgentSearchBox();
  } else {
    // ƒê·∫£m b·∫£o container ƒë∆∞·ª£c hi·ªÉn th·ªã
    searchContainer.style.display = 'block';
    searchContainer.style.visibility = 'visible';
  }
  
  // ·∫®n n√∫t gi·ªØa TOC cho ng∆∞·ªùi d√πng ƒë·∫∑c bi·ªát khi quay v·ªÅ ch·∫ø ƒë·ªô t√¨m ki·∫øm
  if (currentSpecialUser) {
    const mobileCalculateOtherBtn = document.getElementById('mobileCalculateOtherBtn');
    if (mobileCalculateOtherBtn) {
      mobileCalculateOtherBtn.style.display = 'none';
    }
  }
  
  // Reset tr·∫°ng th√°i
  currentCalculatingAgent = null;
  // Kh√¥ng reset isDataReady ƒë·ªÉ tr√°nh l·ªói "d·ªØ li·ªáu ch∆∞a s·∫µn s√†ng"
  // isDataReady = false;
  
  // ƒê·∫£m b·∫£o d·ªØ li·ªáu s·∫µn s√†ng khi chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô t√¨m ki·∫øm
  if (!isDataReady || !data || data.length === 0) {
    console.log('Reloading data for search mode...');
    loadData().then(() => {
      console.log('Data reloaded for search mode');
    });
  }
  
  // Hi·ªÉn th·ªã l·∫°i n√∫t m√†u cam v√† ƒë·ªïi v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
  setTimeout(() => {
    const manualInputBtn = document.getElementById('manualInputBtn');
    if (manualInputBtn) {
      manualInputBtn.style.display = 'block';
      manualInputBtn.innerHTML = 'T√≠nh cho ƒë·∫°i l√Ω<br>ch∆∞a c√≥ code';
      manualInputBtn.onclick = () => {
        enableManualInputMode();
        return false;
      };
    }
  }, 100);
  
  // ƒê·ªïi l·∫°i t·∫•t c·∫£ text v·ªÅ "T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ code"
  updateAllAgentButtonsText('T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ code');
  
  // Hi·ªÉn th·ªã l·∫°i tr∆∞·ªùng "Khu v·ª±c" khi quay v·ªÅ ch·∫ø ƒë·ªô t√¨m ki·∫øm
  const khuVucField = document.getElementById('khu-vuc');
  const khuVucContainer = khuVucField ? khuVucField.closest('.field') : null;
  
  if (khuVucContainer) {
    khuVucContainer.style.display = 'block';
    console.log('Shown khu-vuc field in search mode');
  }
  
  // Kh√¥i ph·ª•c tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω v·ªÅ d·∫°ng input khi quay v·ªÅ ch·∫ø ƒë·ªô t√¨m ki·∫øm
  restoreAgentGroupField();
  
  // Kh√¥i ph·ª•c thu·ªôc t√≠nh readonly cho c√°c tr∆∞·ªùng
  restoreReadonlyFields();
  
  // Hi·ªÉn th·ªã l·∫°i n√∫t normalLoginManualButton v√† container n·∫øu c·∫ßn
  const normalLoginManualButton = document.getElementById('normalLoginManualButton');
  const normalLoginContainer = document.getElementById('normalLoginContainer');
  
  if (normalLoginManualButton) {
    normalLoginManualButton.style.display = 'block';
  }
  
  if (normalLoginContainer) {
    normalLoginContainer.style.display = 'block';
    normalLoginContainer.style.visibility = 'visible';
  }
  
  // ƒê·∫£m b·∫£o n√∫t ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng trong showAgentSearchBox
  setTimeout(() => {
    showAgentSearchBox();
  }, 200);
  
  console.log('Agent search box shown again');
}

function clearAllFields() {
  console.log('Clearing all fields');
  
  // Danh s√°ch t·∫•t c·∫£ c√°c tr∆∞·ªùng c·∫ßn x√≥a
  const fieldsToClear = [
    // Th√¥ng tin ƒë·∫°i l√Ω
    'ho-ten', 'tham-nien', 'thang-lam-viec', 'p13-ca-nhan',
    'fyp-mdrt', 'fyc-t1-t2', 'fyc-quy-hien-tai', 'so-thang-hoat-dong',
    'nhom-dai-ly', 'he-so-thuong', 'active-months',
    
    // FYP v√† FYC
    'tong-fyp', 'fyp-chinh', 'fyp-kem', 'mdrt-fyp', 'tong-fyc', 'tong-fyc-quy',
    
    // C√°c kho·∫£n thu nh·∫≠p
    'fyc-chinh', 'fyc-kem', 'thuong-kem', 'fyc-thuong',
    'thuong-nspro', 'thuong-nst', 'thuong-nsq', 'thuong-memo', 'thuong-mdrt',
    
    // T·ªïng thu nh·∫≠p
    'tong-thu-nhap', 'ty-le-thu-nhap',
    
    // H·ª£p ƒë·ªìng giao d·ªãch
    'sohd-gd1', 'sohd-gd2', 'sohd-gd3',
    'fypchinh-gd1', 'fypchinh-gd2', 'fypchinh-gd3',
    'fypkem-gd1', 'fypkem-gd2', 'fypkem-gd3',
    
    // Thu nh·∫≠p tuy·ªÉn d·ª•ng v√† qu·∫£n l√Ω
    'thu-nhap-tuyen-dung', 'thu-nhap-quan-ly',
    
    // T·ªïng h·ª£p
    'tong-A', 'tong-B', 'tong-C', 'tong-ABC'
  ];
  
  // X√≥a t·∫•t c·∫£ c√°c tr∆∞·ªùng
  fieldsToClear.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.value = '';
    }
  });
  
  // X√≥a dropdown ph√¢n nh√≥m ƒë·∫°i l√Ω trong ch·∫ø ƒë·ªô th·ªß c√¥ng
  const manualDropdown = document.getElementById('nhom-dai-ly-dropdown');
  if (manualDropdown) {
    manualDropdown.selectedIndex = 0; // Ch·ªçn option m·∫∑c ƒë·ªãnh
  }
  
  // Reset c√°c t√≠nh to√°n
  sanitizeAllNumericInputs();
  updateTongHop();
  calculateTongThuNhap();
  syncReadonlyTitles();
  
  console.log('All fields cleared');
}

function restoreOriginalAgentData() {
  console.log('Restoring original agent data');
  
  if (!originalAgentData) {
    console.log('No original agent data to restore');
    return;
  }
  
  // Kh√¥i ph·ª•c d·ªØ li·ªáu ƒë·∫°i l√Ω g·ªëc
  calculateForAgent(originalAgentData.id, originalAgentData.data);
  
  // Hi·ªÉn th·ªã l·∫°i th√¥ng tin ƒë·∫°i l√Ω trong sidebar v·ªõi n√∫t "T√≠nh cho ƒë·∫°i l√Ω kh√°c"
  showCalculatingAgentInfo();
  
  // ·∫®n mobile agent info
  hideMobileAgentInfo();
  
  // C·∫≠p nh·∫≠t l·∫°i onclick cho n√∫t TOC mobile sau khi restore
  const mobileCalculateOtherBtn = document.getElementById('mobileCalculateOtherBtn');
  if (mobileCalculateOtherBtn) {
    // ƒê·∫£m b·∫£o n√∫t hi·ªÉn th·ªã v√† c√≥ text ƒë√∫ng
    mobileCalculateOtherBtn.style.display = 'block';
    mobileCalculateOtherBtn.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
    mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn';
    mobileCalculateOtherBtn.style.background = '#f59e0b';
    mobileCalculateOtherBtn.style.borderColor = '#f59e0b';
    
    // C·∫≠p nh·∫≠t onclick ƒë·ªÉ g·ªçi search container
    mobileCalculateOtherBtn.onclick = () => {
      // Ki·ªÉm tra xem c√≥ ph·∫£i ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng kh√¥ng
      const isNormalLogin = !currentSpecialUser && originalAgentData && originalAgentData.data;
      
      if (isNormalLogin) {
        // ƒêƒÉng nh·∫≠p b√¨nh th∆∞·ªùng: g·ªçi c·ª•m t√¨m ki·∫øm v√† thay ƒë·ªïi n√∫t
        hideMainContent();
        showAgentSearchBoxAgain();
        
        // Thay ƒë·ªïi n√∫t trong TOC th√†nh "T√≠nh cho t√¥i" m√†u xanh l√°
        mobileCalculateOtherBtn.textContent = 'T√≠nh cho t√¥i';
        mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn normal-login';
        mobileCalculateOtherBtn.style.background = '#059669';
        mobileCalculateOtherBtn.style.borderColor = '#059669';
        
        // Thay ƒë·ªïi ch·ª©c nƒÉng n√∫t
        mobileCalculateOtherBtn.onclick = () => {
          restoreOriginalAgentData();
          console.log('Mobile: Restored to original agent data from TOC button');
          return false;
        };
        
        console.log('Mobile: Called showAgentSearchBoxAgain and changed button to "T√≠nh cho t√¥i"');
      } else {
        // Code ƒë·∫∑c bi·ªát: g·ªçi c·ª•m t√¨m ki·∫øm b√¨nh th∆∞·ªùng
        hideMainContent();
        showAgentSearchBoxAgain();
        console.log('Mobile: Called showAgentSearchBoxAgain from mobile TOC button');
      }
      
      return false;
    };
  }
  
  console.log('Original agent data restored');
}

function enableManualInputMode() {
  console.log('enableManualInputMode called');
  
  // X√≥a t·∫•t c·∫£ d·ªØ li·ªáu trong c√°c tr∆∞·ªùng
  clearAllFields();
  
  // ·∫®n c·ª•m t√¨m ki·∫øm
  hideAgentSearchBox();
  
  // ·∫®n container ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng
  hideNormalLoginContainer();
  
  // ƒê·∫£m b·∫£o n√∫t normalLoginManualButton c≈©ng b·ªã ·∫©n
  const normalLoginManualButton = document.getElementById('normalLoginManualButton');
  if (normalLoginManualButton) {
    normalLoginManualButton.style.display = 'none';
  }
  
  // ƒê·∫£m b·∫£o normalLoginContainer b·ªã ·∫©n ho√†n to√†n
  const normalLoginContainer = document.getElementById('normalLoginContainer');
  if (normalLoginContainer) {
    normalLoginContainer.style.display = 'none';
    normalLoginContainer.style.visibility = 'hidden';
  }
  
  // ƒê·∫∑t ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
  currentCalculatingAgent = { 
    id: 'MANUAL_INPUT', 
    data: null,
    isManualMode: true 
  };
  
  // Hi·ªÉn th·ªã ngay sidebar th√¥ng tin cho ch·∫ø ƒë·ªô th·ªß c√¥ng
  showManualModeInfo();
  
  // Hi·ªÉn th·ªã n√∫t gi·ªØa TOC cho ng∆∞·ªùi d√πng ƒë·∫∑c bi·ªát khi chuy·ªÉn sang ch·∫ø ƒë·ªô th·ªß c√¥ng
  if (currentSpecialUser) {
    const mobileCalculateOtherBtn = document.getElementById('mobileCalculateOtherBtn');
    if (mobileCalculateOtherBtn) {
      mobileCalculateOtherBtn.style.display = 'block';
      mobileCalculateOtherBtn.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
      mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn';
      mobileCalculateOtherBtn.style.background = '#f59e0b';
      mobileCalculateOtherBtn.style.borderColor = '#f59e0b';
    }
  }
  
  // ƒê·∫£m b·∫£o sidebar hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
  setTimeout(() => {
    const currentViewInfo = document.getElementById('currentViewInfo');
    if (currentViewInfo) {
      currentViewInfo.style.display = 'block';
      currentViewInfo.style.visibility = 'visible';
      currentViewInfo.style.opacity = '1';
    }
  }, 100);
  
  // Hi·ªÉn th·ªã l·∫°i n·ªôi dung ch√≠nh
  showMainContent();
  
  // Chuy·ªÉn ƒë·∫øn section th√¥ng tin ƒë·∫°i l√Ω
  showSection('sec-daily');
  
  // B·∫≠t ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng cho c√°c tr∆∞·ªùng th√¥ng tin
  enableManualInputFields();
  
  // Hi·ªÉn th·ªã update date nh∆∞ b√¨nh th∆∞·ªùng
  showUpdateDateForManualMode();
  
  // ·∫®n n√∫t m√†u cam trong ch·∫ø ƒë·ªô th·ªß c√¥ng
  const manualInputBtn = document.getElementById('manualInputBtn');
  if (manualInputBtn) {
    manualInputBtn.style.display = 'none';
  }
  
  // C·∫≠p nh·∫≠t t·∫•t c·∫£ text "T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ code" th√†nh "T√≠nh cho ƒë·∫°i l√Ω kh√°c"
  updateAllAgentButtonsText('T√≠nh cho ƒë·∫°i l√Ω kh√°c');
  
  console.log('Manual input mode enabled');
}

function updateAllAgentButtonsText(newText) {
  // C·∫≠p nh·∫≠t normalLoginManualButton
  const normalLoginManualButton = document.getElementById('normalLoginManualButton');
  if (normalLoginManualButton) {
    normalLoginManualButton.textContent = newText;
  }
  
  // C·∫≠p nh·∫≠t mobileAgentInfoButton
  const mobileAgentInfoButton = document.getElementById('mobileAgentInfoButton');
  if (mobileAgentInfoButton) {
    mobileAgentInfoButton.textContent = newText;
  }
  
  // C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c n√∫t c√≥ text "T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ code" ho·∫∑c "T√≠nh cho ƒë·∫°i l√Ω kh√°c"
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(button => {
    const text = button.textContent || button.innerHTML;
    if (text.includes('T√≠nh cho ƒë·∫°i l√Ω') && (text.includes('ch∆∞a c√≥ code') || text.includes('kh√°c'))) {
      if (button.innerHTML.includes('<br>')) {
        button.innerHTML = newText.replace(' ', '<br>');
      } else {
        button.textContent = newText;
      }
    }
  });
  
  // C·∫≠p nh·∫≠t c√°c n√∫t trong HTML ƒë·ªông
  const calculateOtherAgentBtn = document.getElementById('calculateOtherAgentBtn');
  if (calculateOtherAgentBtn) {
    calculateOtherAgentBtn.textContent = newText;
  }
}

function enableManualInputFields() {
  console.log('enableManualInputFields called');
  
  // Danh s√°ch t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin ƒë·∫°i l√Ω c·∫ßn cho ph√©p nh·∫≠p th·ªß c√¥ng
  const manualFields = [
    'ho-ten', 'tham-nien', 'thang-lam-viec', 'p13-ca-nhan',
    'fyp-mdrt', 'fyc-t1-t2', 'fyc-quy-hien-tai', 'so-thang-hoat-dong', 
    'tong-fyp', 'fyp-chinh', 'fyp-kem', 'active-months',
    'mdrt-fyp', 'tong-fyc', 'tong-fyc-quy'
  ];
  
  // ·∫®n tr∆∞·ªùng "Khu v·ª±c" trong ch·∫ø ƒë·ªô th·ªß c√¥ng
  const khuVucField = document.getElementById('khu-vuc');
  const khuVucContainer = khuVucField ? khuVucField.closest('.field') : null;
  
  if (khuVucContainer) {
    khuVucContainer.style.display = 'none';
    console.log('Hidden khu-vuc field in manual mode');
  }
  
  // T·∫°o dropdown cho tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω trong ch·∫ø ƒë·ªô th·ªß c√¥ng
  createAgentGroupDropdownForManualMode();
  
  // B·ªè readonly v√† cho ph√©p nh·∫≠p th·ªß c√¥ng
  manualFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.removeAttribute('readonly');
      field.style.backgroundColor = '#ffffff';
      field.style.borderColor = '#059669';
      console.log('Enabled manual input for field:', fieldId);
    }
  });
  
  // T·∫°o dropdown cho nh√≥m ƒë·∫°i l√Ω
  createAgentGroupDropdown();
  
  // Th√™m event listener cho P13 ƒë·ªÉ t·ª± ƒë·ªông t√≠nh h·ªá s·ªë th∆∞·ªüng
  setupP13BonusCalculation();
  
  // B·ªè notification trong ch·∫ø ƒë·ªô th·ªß c√¥ng
  // showManualModeNotification();
  
  // ·∫®n l·ª±a ch·ªçn "T√≠nh thu nh·∫≠p cho" khi d√πng m√£ ƒë·∫∑c bi·ªát
  hideIncomeTargetChoice();
}

// B·ªè notification trong ch·∫ø ƒë·ªô th·ªß c√¥ng
// function showManualModeNotification() {
//   // T·∫°o th√¥ng b√°o ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
//   const notification = document.createElement('div');
//   notification.id = 'manualModeNotification';
//   notification.style.cssText = `
//     background: #fef3c7;
//     border: 2px solid #f59e0b;
//     border-radius: 8px;
//     padding: 12px 16px;
//     margin: 16px var(--pad);
//     color: #92400e;
//     font-weight: 600;
//     text-align: center;
//   `;
//   notification.innerHTML = `
//     <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
//       <span>üìù</span>
//       <span>Ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng - Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·∫°i l√Ω m·ªõi</span>
//     </div>
//   `;
//   
//   // Th√™m v√†o ƒë·∫ßu section th√¥ng tin ƒë·∫°i l√Ω
//   const secDaily = document.getElementById('sec-daily');
//   if (secDaily) {
//     secDaily.insertBefore(notification, secDaily.firstChild);
//   }
// }

function hideIncomeTargetChoice() {
  // Function kh√¥ng c√≤n c·∫ßn thi·∫øt v√¨ ƒë√£ x√≥a fieldset
  return;
}

function showIncomeTargetChoice() {
  // Function kh√¥ng c√≤n c·∫ßn thi·∫øt v√¨ ƒë√£ x√≥a fieldset
  return;
}

function createAgentGroupDropdown() {
  // T√¨m tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω
  const phanNhomField = document.getElementById('phan-nhom-dai-ly');
  if (!phanNhomField) return;
  
  // L·∫•y danh s√°ch nh√≥m ƒë·∫°i l√Ω t·ª´ data
  const agentGroups = new Set();
  if (data && data.length > 0) {
    data.forEach(agent => {
      const nhom = agent["NHOM DAI LY"] || agent["nhom dai ly"];
      if (nhom) {
        agentGroups.add(nhom);
      }
    });
  }
  
  // T·∫°o dropdown
  const dropdown = document.createElement('select');
  dropdown.id = 'phan-nhom-dai-ly-dropdown';
  dropdown.style.cssText = `
    width: 100%;
    height: 44px;
    padding: 0 12px;
    border: 1px solid #059669;
    border-radius: 8px;
    font-size: 16px;
    background: #ffffff;
    color: #0b3d2c;
  `;
  
  // Th√™m option m·∫∑c ƒë·ªãnh
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = 'Ch·ªçn nh√≥m ƒë·∫°i l√Ω...';
  dropdown.appendChild(defaultOption);
  
  // Th√™m c√°c option t·ª´ danh s√°ch
  Array.from(agentGroups).sort().forEach(group => {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    dropdown.appendChild(option);
  });
  
  // Thay th·∫ø input b·∫±ng dropdown
  phanNhomField.parentNode.replaceChild(dropdown, phanNhomField);
  
  console.log('Created agent group dropdown with', agentGroups.size, 'options');
}

function createAgentGroupDropdownForManualMode() {
  // T√¨m tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω (nhom-dai-ly)
  const nhomDaiLyField = document.getElementById('nhom-dai-ly');
  if (!nhomDaiLyField) return;
  
  // Danh s√°ch c√°c nh√≥m ƒë·∫°i l√Ω duy nh·∫•t t·ª´ income.json
  const agentGroups = [
    'M0',
    'M1-3', 
    'M13+',
    'M4-6',
    'M7-12',
    'Manulife Pro B·∫°c',
    'Manulife Pro B·∫°ch Kim', 
    'Manulife Pro V√†ng',
    'SA'
  ];
  
  // T·∫°o dropdown
  const dropdown = document.createElement('select');
  dropdown.id = 'nhom-dai-ly-dropdown';
  dropdown.style.cssText = `
    width: 100%;
    height: 44px;
    padding: 0 12px;
    border: 1px solid #059669;
    border-radius: 8px;
    font-size: 14px;
    background-color: #ffffff;
    color: #1f2937;
    cursor: pointer;
  `;
  
  // Th√™m option m·∫∑c ƒë·ªãnh
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = 'Ch·ªçn ph√¢n nh√≥m ƒë·∫°i l√Ω...';
  defaultOption.disabled = true;
  defaultOption.selected = true;
  dropdown.appendChild(defaultOption);
  
  // Th√™m c√°c option t·ª´ danh s√°ch nh√≥m
  agentGroups.forEach(group => {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    dropdown.appendChild(option);
  });
  
  // Thay th·∫ø input b·∫±ng dropdown
  nhomDaiLyField.parentNode.replaceChild(dropdown, nhomDaiLyField);
  
  // Th√™m event listener ƒë·ªÉ c·∫≠p nh·∫≠t gi√° tr·ªã
  dropdown.addEventListener('change', function() {
    console.log('Selected agent group in manual mode:', this.value);
  });
  
  console.log('Created agent group dropdown for manual mode with', agentGroups.length, 'options');
}

// H√†m kh√¥i ph·ª•c thu·ªôc t√≠nh readonly cho c√°c tr∆∞·ªùng khi chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô t√¨m ki·∫øm
function restoreReadonlyFields() {
  console.log('Restoring readonly fields for search mode');
  
  // Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn kh√¥i ph·ª•c readonly
  const readonlyFields = [
    'ho-ten', 'tham-nien', 'thang-lam-viec', 'p13-ca-nhan',
    'fyp-mdrt', 'fyc-t1-t2', 'fyc-quy-hien-tai', 'so-thang-hoat-dong', 
    'tong-fyp', 'fyp-chinh', 'fyp-kem', 'active-months',
    'mdrt-fyp', 'tong-fyc', 'tong-fyc-quy'
  ];
  
  // Kh√¥i ph·ª•c readonly cho c√°c tr∆∞·ªùng
  readonlyFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.setAttribute('readonly', 'readonly');
      field.style.backgroundColor = '#f9fafb';
      field.style.borderColor = '#e5e7eb';
      field.style.color = '#6b7280';
      console.log('Restored readonly for field:', fieldId);
    }
  });
  
  // Kh√¥i ph·ª•c tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω v·ªÅ readonly (n·∫øu l√† input)
  const nhomDaiLyField = document.getElementById('nhom-dai-ly');
  if (nhomDaiLyField && nhomDaiLyField.tagName === 'INPUT') {
    nhomDaiLyField.setAttribute('readonly', 'readonly');
    nhomDaiLyField.style.backgroundColor = '#f9fafb';
    nhomDaiLyField.style.borderColor = '#e5e7eb';
    nhomDaiLyField.style.color = '#6b7280';
    console.log('Restored readonly for nhom-dai-ly field');
  }
  
  console.log('All readonly fields restored');
}

// H√†m helper ƒë·ªÉ l·∫•y gi√° tr·ªã t·ª´ tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω (c√≥ th·ªÉ l√† input ho·∫∑c dropdown)
function getAgentGroupValue() {
  // Ki·ªÉm tra xem c√≥ dropdown trong ch·∫ø ƒë·ªô th·ªß c√¥ng kh√¥ng
  const manualDropdown = document.getElementById('nhom-dai-ly-dropdown');
  if (manualDropdown) {
    return manualDropdown.value || '';
  }
  
  // N·∫øu kh√¥ng c√≥ dropdown, l·∫•y t·ª´ input th√¥ng th∆∞·ªùng
  const inputField = document.getElementById('nhom-dai-ly');
  if (inputField) {
    return inputField.value || '';
  }
  
  return '';
}

function setupP13BonusCalculation() {
  // Th√™m event listener cho P13 ƒë·ªÉ t·ª± ƒë·ªông t√≠nh h·ªá s·ªë th∆∞·ªüng
  const p13Field = document.getElementById('p13-ca-nhan');
  const heSoField = document.getElementById('he-so-tinh-thuong');
  
  if (p13Field && heSoField) {
    p13Field.addEventListener('input', () => {
      const p13Value = parseFloat(p13Field.value) || 0;
      const heSo = getHeSoThuong(p13Value);
      heSoField.value = heSo;
      console.log('Auto-calculated bonus coefficient:', heSo, 'for P13:', p13Value);
    });
    
    // T√≠nh h·ªá s·ªë ban ƒë·∫ßu n·∫øu P13 ƒë√£ c√≥ gi√° tr·ªã
    if (p13Field.value) {
      const p13Value = parseFloat(p13Field.value) || 0;
      const heSo = getHeSoThuong(p13Value);
      heSoField.value = heSo;
    }
  }
}

function restoreAgentGroupField() {
  // Kh√¥i ph·ª•c tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω v·ªÅ d·∫°ng input
  const dropdown = document.getElementById('phan-nhom-dai-ly-dropdown');
  if (dropdown) {
    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'phan-nhom-dai-ly';
    input.setAttribute('readonly', 'readonly');
    input.style.cssText = `
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      background: #f9fafb;
      color: #6b7280;
    `;
    
    dropdown.parentNode.replaceChild(input, dropdown);
    console.log('Restored agent group field to readonly input');
  }
  
  // Kh√¥i ph·ª•c tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω trong ch·∫ø ƒë·ªô th·ªß c√¥ng v·ªÅ d·∫°ng input
  const manualDropdown = document.getElementById('nhom-dai-ly-dropdown');
  if (manualDropdown) {
    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'nhom-dai-ly';
    input.setAttribute('readonly', 'readonly');
    input.style.cssText = `
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      background: #f9fafb;
      color: #6b7280;
    `;
    
    manualDropdown.parentNode.replaceChild(input, manualDropdown);
    console.log('Restored manual mode agent group field to readonly input');
  }
}

function getCurrentUpdateDate() {
  // L·∫•y ng√†y c·∫≠p nh·∫≠t hi·ªán t·∫°i
  const now = new Date();
  return now.toLocaleDateString('vi-VN');
}

function getUpdateDateFromData(agentData) {
  // L·∫•y ng√†y c·∫≠p nh·∫≠t t·ª´ d·ªØ li·ªáu th·ª±c t·∫ø
  if (!agentData) return getCurrentUpdateDate();
  
  // L·∫•y t·ª´ c·ªôt "NGAY CHOT DU LIEU" - c·ªôt ch√≠nh x√°c trong income.json
  const ngayChot = agentData["NGAY CHOT DU LIEU"];
  
  if (ngayChot) {
    return ngayChot;
  }
  
  // Fallback: L·∫•y ng√†y cu·ªëi c√πng c·ªßa th√°ng li·ªÅn tr∆∞·ªõc
  const now = new Date();
  let lastMonthYear = now.getFullYear();
  let lastMonthMonth = now.getMonth() - 1;
  
  if (lastMonthMonth < 0) {
    lastMonthMonth = 11;
    lastMonthYear = now.getFullYear() - 1;
  }
  
  const lastDayOfLastMonth = new Date(lastMonthYear, lastMonthMonth + 1, 0);
  return lastDayOfLastMonth.toLocaleDateString('vi-VN');
}

function updateBannerForMobile() {
  // C·∫≠p nh·∫≠t banner khi resize window
  const welcomeName = document.getElementById('welcomeName');
  if (!welcomeName || !currentCalculatingAgent || !currentCalculatingAgent.data) return;
  
  const fullName = currentCalculatingAgent.data["TEN DAI LY"] || '';
  const chucDanh = currentCalculatingAgent.data["CHUC DANH"] || '';
  
  // Ch·ªâ hi·ªÉn th·ªã CHUC DANH + TEN DAI LY tr√™n mobile
  if (window.innerWidth <= 1023) {
    welcomeName.textContent = `${chucDanh} ${fullName}`.trim();
  } else {
    welcomeName.textContent = fullName;
  }
}

function showUpdateDateForManualMode() {
  // Hi·ªÉn th·ªã mobile container cho ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
  const mobileContainer = document.getElementById('mobileContainer');
  if (mobileContainer) {
    mobileContainer.style.display = 'block';
    
    // C·∫≠p nh·∫≠t mobile container v·ªõi layout m·ªõi
    mobileContainer.innerHTML = `
      <div class="mobile-container-content">
        <div class="mobile-update-date">
          D·ªØ li·ªáu ch·ªët ng√†y: <span id="mobileUpdateDateText"></span>
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-top: 12px;">
          <div style="display: flex; align-items: center; font-weight: 700; color: #0b3d2c; font-size: 14px;">
            ƒêang t√≠nh thu nh·∫≠p cho<br><span id="currentAgentName"></span>
          </div>
          <button 
            id="calculateOtherAgentBtn" 
            onclick="showAgentSearchBoxAgain(); return false;"
            style="height: 44px; padding: 0 12px; background: #059669; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 12px; line-height: 1.2;"
          >
            T√≠nh thu nh·∫≠p<br>ƒë·∫°i l√Ω kh√°c
          </button>
        </div>
      </div>
    `;
    
    // C·∫≠p nh·∫≠t ng√†y ch·ªët d·ªØ li·ªáu t·ª´ income.json
    const mobileUpdateDateText = document.getElementById('mobileUpdateDateText');
    if (mobileUpdateDateText && data.length > 0) {
      const updateDate = data[0]["NGAY CHOT DU LIEU"] || data[0]["NGAY CHOT DATA"];
      mobileUpdateDateText.textContent = updateDate || new Date().toLocaleDateString('vi-VN');
    }
    
    // C·∫≠p nh·∫≠t t√™n ƒë·∫°i l√Ω hi·ªán t·∫°i
    const currentAgentName = document.getElementById('currentAgentName');
    if (currentAgentName && originalAgentData && originalAgentData.data) {
      const fullname = originalAgentData.data['fullname'] || originalAgentData.data['TEN DAI LY'] || originalAgentData.data['AGEN NAME'] || 'ƒê·∫°i l√Ω';
      currentAgentName.textContent = fullname;
    }
  }
  
  // Hi·ªÉn th·ªã update date desktop cho ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
  const desktopUpdateDate = document.querySelector('.desktop-update-date');
  if (desktopUpdateDate) {
    desktopUpdateDate.style.display = 'block';
    // C·∫≠p nh·∫≠t text ƒë·ªÉ ph√π h·ª£p v·ªõi ch·∫ø ƒë·ªô th·ªß c√¥ng
    desktopUpdateDate.innerHTML = 'Ng√†y th·ª±c hi·ªán t√≠nh: <span id="desktopUpdateDateText"></span>';
    const desktopUpdateDateText = desktopUpdateDate.querySelector('span');
    if (desktopUpdateDateText) {
      const now = new Date();
      desktopUpdateDateText.textContent = now.toLocaleDateString('vi-VN');
    }
  }
}

function showMobileAgentInfo() {
  // Hi·ªÉn th·ªã th√¥ng tin ƒë·∫°i l√Ω tr√™n mobile
  const mobileAgentInfo = document.getElementById('mobileAgentInfo');
  const mobileAgentInfoText = document.getElementById('mobileAgentInfoText');
  const mobileAgentInfoButton = document.getElementById('mobileAgentInfoButton');
  
  if (!mobileAgentInfo || !mobileAgentInfoText || !mobileAgentInfoButton) return;
  
  // Ki·ªÉm tra xem c√≥ ph·∫£i ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng kh√¥ng (kh√¥ng ph·∫£i m√£ ƒë·∫∑c bi·ªát)
  const isNormalLogin = !currentSpecialUser && originalAgentData && originalAgentData.data;
  
  if (isNormalLogin) {
    // ƒêƒÉng nh·∫≠p b√¨nh th∆∞·ªùng - hi·ªÉn th·ªã n√∫t "T√≠nh cho ƒë·∫°i l√Ω kh√°c" (m√†u cam)
    mobileAgentInfoText.innerHTML = `
      <div>B·∫°n ƒëang t√≠nh thu nh·∫≠p cho<br>ƒê·∫°i l√Ω ch∆∞a c·∫•p code</div>
      <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
        Ng√†y: ${getCurrentUpdateDate()}
      </div>
    `;
    mobileAgentInfoButton.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
    mobileAgentInfoButton.className = 'mobile-agent-info-button special-login';
    
    // Event listener - g·ªçi l·∫°i √¥ t√¨m ki·∫øm
    mobileAgentInfoButton.onclick = () => {
      hideMainContent();
      showAgentSearchBoxAgain();
      console.log('Mobile: Called showAgentSearchBoxAgain from mobile agent info');
      return false;
    };
  } else {
    // ƒêƒÉng nh·∫≠p ƒë·∫∑c bi·ªát - hi·ªÉn th·ªã n√∫t "T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ Code" (m√†u cam)
    mobileAgentInfoText.innerHTML = `
      <div>B·∫°n ƒëang t√≠nh thu nh·∫≠p cho<br>ƒê·∫°i l√Ω ch∆∞a c·∫•p code</div>
      <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
        Ng√†y: ${getCurrentUpdateDate()}
      </div>
    `;
    mobileAgentInfoButton.textContent = 'T√≠nh cho ƒë·∫°i l√Ω ch∆∞a c√≥ Code';
    mobileAgentInfoButton.className = 'mobile-agent-info-button special-login';
    
    // Event listener - s·ª≠ d·ª•ng logic desktop
    mobileAgentInfoButton.onclick = () => {
      enableManualInputMode();
      console.log('Mobile: Called enableManualInputMode from mobile button');
      return false;
    };
  }
  
  // Hi·ªÉn th·ªã mobile agent info
  mobileAgentInfo.style.display = 'block';
  document.body.classList.add('has-agent-info');
}

function showMobileCalculatingAgentInfo() {
  // Hi·ªÉn th·ªã th√¥ng tin ƒë·∫°i l√Ω ƒëang t√≠nh tr√™n mobile
  const mobileAgentInfo = document.getElementById('mobileAgentInfo');
  const mobileAgentInfoText = document.getElementById('mobileAgentInfoText');
  const mobileAgentInfoButton = document.getElementById('mobileAgentInfoButton');
  
  if (!mobileAgentInfo || !mobileAgentInfoText || !mobileAgentInfoButton || !currentCalculatingAgent) return;
  
  // X·ª≠ l√Ω ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng - s·ª≠ d·ª•ng logic desktop
  if (currentCalculatingAgent.isManualMode) {
    showMobileManualModeInfo();
    return;
  }
  
  const agentName = currentCalculatingAgent.data["TEN DAI LY"];
  const agentId = currentCalculatingAgent.id;
  const updateDate = getUpdateDateFromData(currentCalculatingAgent.data);
  
  // Ch·ªâ hi·ªÉn th·ªã th√¥ng tin m√£ v√† c·∫≠p nh·∫≠t cho code ƒë·∫∑c bi·ªát
  const isSpecialCode = currentCalculatingAgent.isSpecialCode || currentSpecialUser;
  
  mobileAgentInfoText.innerHTML = `
    <div><strong>${agentName}</strong></div>
    ${isSpecialCode ? `<div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
      M√£: ${agentId} | C·∫≠p nh·∫≠t: ${updateDate}
    </div>` : ''}
  `;
  mobileAgentInfoButton.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
  mobileAgentInfoButton.className = 'mobile-agent-info-button special-login';
  
  // Event listener - s·ª≠ d·ª•ng logic desktop
  mobileAgentInfoButton.onclick = () => {
    hideMainContent();
    showAgentSearchBoxAgain();
    console.log('Mobile: Called showAgentSearchBoxAgain from mobile button');
    return false;
  };
  
  // Hi·ªÉn th·ªã mobile agent info
  mobileAgentInfo.style.display = 'block';
  document.body.classList.add('has-agent-info');
}

function showMobileManualModeInfo() {
  // Hi·ªÉn th·ªã th√¥ng tin ch·∫ø ƒë·ªô th·ªß c√¥ng tr√™n mobile
  const mobileAgentInfo = document.getElementById('mobileAgentInfo');
  const mobileAgentInfoText = document.getElementById('mobileAgentInfoText');
  const mobileAgentInfoButton = document.getElementById('mobileAgentInfoButton');
  
  if (!mobileAgentInfo || !mobileAgentInfoText || !mobileAgentInfoButton) return;
  
  // Ki·ªÉm tra xem c√≥ ph·∫£i ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng kh√¥ng (kh√¥ng ph·∫£i m√£ ƒë·∫∑c bi·ªát)
  const isNormalLogin = !currentSpecialUser && originalAgentData && originalAgentData.data;
  
  if (isNormalLogin) {
    // ƒêƒÉng nh·∫≠p b√¨nh th∆∞·ªùng - hi·ªÉn th·ªã n√∫t "T√≠nh to√°n cho t√¥i" (m√†u xanh)
    mobileAgentInfoText.innerHTML = `
      <div>B·∫°n ƒëang t√≠nh thu nh·∫≠p cho<br>ƒê·∫°i l√Ω ch∆∞a c·∫•p code</div>
      <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
        Ng√†y: ${getCurrentUpdateDate()}
      </div>
    `;
    mobileAgentInfoButton.textContent = 'T√≠nh to√°n cho t√¥i';
    mobileAgentInfoButton.className = 'mobile-agent-info-button normal-login';
    
    // Event listener - s·ª≠ d·ª•ng logic desktop
    mobileAgentInfoButton.onclick = () => {
      restoreOriginalAgentData();
      console.log('Mobile: Restored to original agent data from manual mode');
      return false;
    };
  } else {
    // ƒêƒÉng nh·∫≠p ƒë·∫∑c bi·ªát - hi·ªÉn th·ªã n√∫t "T√≠nh cho ƒë·∫°i l√Ω kh√°c" (m√†u cam)
    mobileAgentInfoText.innerHTML = `
      <div>B·∫°n ƒëang t√≠nh thu nh·∫≠p cho<br>ƒê·∫°i l√Ω ch∆∞a c·∫•p code</div>
      <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
        Ng√†y: ${getCurrentUpdateDate()}
      </div>
    `;
    mobileAgentInfoButton.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
    mobileAgentInfoButton.className = 'mobile-agent-info-button special-login';
    
    // Event listener - g·ªçi l·∫°i c·ª•m t√¨m ki·∫øm
    mobileAgentInfoButton.onclick = () => {
      hideMainContent();
      showAgentSearchBoxAgain();
      console.log('Mobile: Called showAgentSearchBoxAgain from manual mode special user');
      return false;
    };
  }
  
  // Hi·ªÉn th·ªã mobile agent info
  mobileAgentInfo.style.display = 'block';
  document.body.classList.add('has-agent-info');
}

function hideMobileAgentInfo() {
  const mobileAgentInfo = document.getElementById('mobileAgentInfo');
  if (mobileAgentInfo) {
    mobileAgentInfo.style.display = 'none';
    document.body.classList.remove('has-agent-info');
  }
}

function showNormalLoginContainer() {
  // Kh√¥ng hi·ªÉn th·ªã normalLoginContainer n·ªØa
  return;
}

function hideNormalLoginContainer() {
  const normalLoginContainer = document.getElementById('normalLoginContainer');
  if (normalLoginContainer) {
    normalLoginContainer.style.display = 'none';
    document.body.classList.remove('has-normal-login-container');
  }
}

function showManualModeInfo() {
  // C·∫≠p nh·∫≠t th√¥ng tin ƒëang xem trong sidebar cho ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
  const currentViewInfo = document.getElementById('currentViewInfo');
  const currentViewText = document.getElementById('currentViewText');
  
  if (currentViewInfo && currentViewText) {
    currentViewInfo.style.display = 'block';
    // ƒê·∫£m b·∫£o sidebar hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
    currentViewInfo.style.visibility = 'visible';
    currentViewInfo.style.opacity = '1';
    currentViewText.style.cssText = `
      background: #f0f9ff;
      color: #0b3d2c;
      border-left-color: #0ea5e9;
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
    `;
    // Ki·ªÉm tra xem c√≥ ph·∫£i ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng kh√¥ng (kh√¥ng ph·∫£i m√£ ƒë·∫∑c bi·ªát)
    const isNormalLogin = !currentSpecialUser && originalAgentData && originalAgentData.data;
    
    let buttonHtml, buttonHandler;
    
    if (isNormalLogin) {
      // ƒêƒÉng nh·∫≠p b√¨nh th∆∞·ªùng - hi·ªÉn th·ªã n√∫t "T√≠nh to√°n cho t√¥i" (m√†u xanh)
      buttonHtml = `
        <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
          Ng√†y th·ª±c hi·ªán t√≠nh: <span id="sidebarUpdateDateManual">${getCurrentUpdateDate()}</span>
        </div>
        <div style="margin-top: 8px;">
          <button 
            id="calculateOtherAgentBtn" 
            onclick="restoreOriginalAgentData(); console.log('Restored to original agent data from manual mode'); return false;"
            style="width: 100%; height: 32px; background: #059669; color: #fff; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 12px;"
          >
            T√≠nh to√°n cho t√¥i
          </button>
        </div>
      `;
      
      buttonHandler = () => {
        // Quay v·ªÅ ch·∫ø ƒë·ªô ban ƒë·∫ßu (kh√¥i ph·ª•c d·ªØ li·ªáu ƒë·∫°i l√Ω g·ªëc)
        restoreOriginalAgentData();
        console.log('Restored to original agent data from manual mode');
      };
    } else {
      // ƒêƒÉng nh·∫≠p ƒë·∫∑c bi·ªát - hi·ªÉn th·ªã n√∫t "T√≠nh cho ƒë·∫°i l√Ω kh√°c" (m√†u cam)
      buttonHtml = `
        <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
          Ng√†y th·ª±c hi·ªán t√≠nh: <span id="sidebarUpdateDateManual">${getCurrentUpdateDate()}</span>
        </div>
        <div style="margin-top: 8px;">
          <button 
            id="calculateOtherAgentBtn" 
            onclick="hideMainContent(); showAgentSearchBoxAgain(); console.log('Called showAgentSearchBoxAgain from manual mode special user'); return false;"
            style="width: 100%; height: 32px; background: #f59e0b; color: #fff; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 12px;"
          >
            T√≠nh cho ƒë·∫°i l√Ω kh√°c
          </button>
        </div>
      `;
      
      buttonHandler = () => {
        // G·ªçi l·∫°i c·ª•m t√¨m ki·∫øm
        hideMainContent();
        showAgentSearchBoxAgain();
        console.log('Called showAgentSearchBoxAgain from manual mode special user');
      };
    }
    
    currentViewText.innerHTML = buttonHtml;
  }
  
  // ·∫®n th√¥ng tin tr√™n mobile khi m·ªõi ƒëƒÉng nh·∫≠p
  hideMobileAgentInfo();
}

function showCalculatingAgentInfo() {
  if (!currentCalculatingAgent) return;
  
  // X·ª≠ l√Ω ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
  if (currentCalculatingAgent.isManualMode) {
    showManualModeInfo();
    return;
  }
  
  const agentName = currentCalculatingAgent.data["TEN DAI LY"];
  const agentId = currentCalculatingAgent.id;
  
  // C·∫≠p nh·∫≠t th√¥ng tin ƒëang xem trong sidebar
  const currentViewInfo = document.getElementById('currentViewInfo');
  const currentViewText = document.getElementById('currentViewText');
  
  if (currentViewInfo && currentViewText) {
    currentViewInfo.style.display = 'block';
    currentViewInfo.style.cssText = `
      background: #fef3c7;
      color: #92400e;
      border-left-color: #f59e0b;
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
    `;
    // L·∫•y ng√†y c·∫≠p nh·∫≠t t·ª´ d·ªØ li·ªáu th·ª±c t·∫ø
    const updateDate = getUpdateDateFromData(currentCalculatingAgent.data);
    
    // Ch·ªâ hi·ªÉn th·ªã th√¥ng tin m√£ v√† c·∫≠p nh·∫≠t cho code ƒë·∫∑c bi·ªát
    const isSpecialCode = currentCalculatingAgent.isSpecialCode || currentSpecialUser;
    
    currentViewText.innerHTML = `
      B·∫°n ƒëang t√≠nh thu nh·∫≠p cho<br>
      <strong>${agentName}</strong><br>
      ${isSpecialCode ? `<small>M√£: ${agentId}</small>
      <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
        D·ªØ li·ªáu c·∫≠p nh·∫≠t ƒë·∫øn ng√†y: <span id="sidebarUpdateDate">${updateDate}</span>
      </div>` : ''}
      <div style="margin-top: 8px;">
        <button 
          id="calculateOtherAgentBtn" 
          onclick="hideMainContent(); showAgentSearchBoxAgain(); console.log('Called showAgentSearchBoxAgain from sidebar button'); return false;"
          style="width: 100%; height: 32px; background: #f59e0b; color: #fff; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 12px;"
        >
          T√≠nh cho ƒë·∫°i l√Ω kh√°c
        </button>
      </div>
    `;
  }
  
  // ·∫®n th√¥ng tin tr√™n mobile khi m·ªõi ƒëƒÉng nh·∫≠p
  hideMobileAgentInfo();
}

/* ===== TOTAL (A) & D (A+B+C) ===== */
function calculateTongThuNhap(){
  const v=id=>parseMoney3(document.getElementById(id).value);
  const sum=v("fyc-chinh")+v("fyc-kem")+v("thuong-kem")+v("fyc-thuong")+v("thuong-nspro")+v("thuong-nst")+v("thuong-nsq")+v("thuong-memo")+v("thuong-mdrt");
  document.getElementById("tong-thu-nhap").value=formatMoney3(sum);
  const tongFYP=parseMoney3(document.getElementById("tong-fyp").value);
  document.getElementById("ty-le-thu-nhap").value=tongFYP>0?((sum/tongFYP)*100).toFixed(2)+" %":"";
  updateCombinedTotals(); reformatMoneyOutputs(); syncReadonlyTitles();
}
function updateCombinedTotals(){
  const A = parseMoney3(document.getElementById("tong-thu-nhap").value);
  const B = parseMoney3(document.getElementById("thu-nhap-tuyen-dung")?document.getElementById("thu-nhap-tuyen-dung").value:0);
  const C = parseMoney3(document.getElementById("thu-nhap-quan-ly")?document.getElementById("thu-nhap-quan-ly").value:0);
  const elA=document.getElementById("tong-A"); if(elA) elA.value=formatMoney3(A);
  const elB=document.getElementById("tong-B"); if(elB) elB.value=formatMoney3(B);
  const elC=document.getElementById("tong-C"); if(elC) elC.value=formatMoney3(C);
  const elABC=document.getElementById("tong-ABC"); if(elABC) elABC.value=formatMoney3(A+B+C);

  // ‚úÖ T√≠nh "Th∆∞·ªüng th√™m kh√°c"
  computeExtraRewards();
}

// ‚úÖ T√≠nh "Th∆∞·ªüng th√™m kh√°c" trong t·ªïng h·ª£p
function computeExtraRewards() {
  const rewards = [];

  // ‚úÖ 5.1 V√© tham d·ª± Ng√†y Doanh nh√¢n 13/10
  // Ch·ªâ hi·ªÉn th·ªã c√¢u th√¥ng b√°o ƒëi·ªÅu ki·ªán
  rewards.push({ 
    label: 'V√© tham d·ª± Ng√†y Doanh nh√¢n 13/10', 
    value: 'ƒê·∫°t v√© n·∫øu th√°ng n√†y b·∫°n c√≥ √≠t nh·∫•t 1 NRA v·ªõi ‚â• 16 tri·ªáu FYP' 
  });

  // ‚úÖ 5.2 B·ªô l·ªãch 2026 (ch·ªâ khi Gƒê1 ch·ªçn C√≥)
  const has16FYP_1to8Sep = document.getElementById('p1_has_16fyp_1to8Sep_yes').checked;
  const expectedCCCount = parseInt(document.getElementById('expectedCCCount').value) || 0;
  if (has16FYP_1to8Sep && expectedCCCount >= 1) {
    rewards.push({
      label: 'Th∆∞·ªüng B·ªô l·ªãch 2026',
      value: expectedCCCount,
    });
  }

  // ‚úÖ 5.3 V√© b·ªëc thƒÉm iPhone 17
  // S·ªë phi·∫øu thƒÉm = min(s·ªë Hƒê ng∆∞·ªùi nh·∫≠p, s·ªë Hƒê t·ªëi ƒëa c√≥ th·ªÉ t√≠nh th∆∞·ªüng)
  function countRewardableContracts(giaiDoan) {
    // L·∫•y s·ªë Hƒê t·ª´ input c·ªßa giai ƒëo·∫°n t∆∞∆°ng ·ª©ng
    let soHDNhap = 0;
    let tongFYP = 0;
    
    if (giaiDoan === 'gd1') {
      soHDNhap = parseInt(document.getElementById('sohd-gd1').value) || 0;
      tongFYP = parseMoney3(document.getElementById('fyp-gd1').value) || 0;
    } else if (giaiDoan === 'gd2') {
      soHDNhap = parseInt(document.getElementById('sohd-gd2').value) || 0;
      tongFYP = parseMoney3(document.getElementById('fyp-gd2').value) || 0;
    } else if (giaiDoan === 'gd3') {
      soHDNhap = parseInt(document.getElementById('sohd-gd3').value) || 0;
      tongFYP = parseMoney3(document.getElementById('fyp-gd3').value) || 0;
    }
    
    // T√≠nh s·ªë Hƒê t·ªëi ƒëa c√≥ th·ªÉ t√≠nh th∆∞·ªüng
    let m1, t1, m2, t2;
    if (giaiDoan === 'gd1') {
      m1 = 25000; t1 = 2500; m2 = 16000; t2 = 1500;
    } else if (giaiDoan === 'gd2') {
      m1 = 25000; t1 = 2000; m2 = 16000; t2 = 1000;
    } else {
      m1 = 25000; t1 = 1500; m2 = 16000; t2 = 750;
    }
    
    const optU = optimizeMemo(tongFYP, Infinity, m1, t1, m2, t2);
    const soHDToiDa = optU.used;
    
    // L·∫•y min(s·ªë nh·∫≠p, s·ªë t·ªëi ƒëa)
    return Math.min(soHDNhap, soHDToiDa);
  }
  
  const iphoneTickets =
    countRewardableContracts('gd1') +
    countRewardableContracts('gd2') +
    countRewardableContracts('gd3');
    
  if (iphoneTickets > 0) {
    rewards.push({ label: 'Th∆∞·ªüng v√© b·ªëc thƒÉm iPhone 17', value: iphoneTickets });
  }

  // ‚úÖ L∆∞u v√†o global variable ƒë·ªÉ s·ª≠ d·ª•ng trong render
  window.extraRewards = rewards;
  
  // ‚úÖ Render "Th∆∞·ªüng th√™m kh√°c" v·ªõi th·ª© t·ª± hi·ªÉn th·ªã
  renderExtraRewards(rewards);
}

// ‚úÖ Render "Th∆∞·ªüng th√™m kh√°c" v√† th·ª© t·ª± hi·ªÉn th·ªã
function renderExtraRewards(rewards) {
  // Render cho t·∫•t c·∫£ 3 section: A2, A3, D
  const sections = [
    { section: 'extraRewardsSectionA2', list: 'extraRewardsListA2' },
    { section: 'extraRewardsSectionA3', list: 'extraRewardsListA3' },
    { section: 'extraRewardsSection', list: 'extraRewardsList' }
  ];
  
  sections.forEach(({ section, list }) => {
    const extraRewardsSection = document.getElementById(section);
    const extraRewardsList = document.getElementById(list);
    
    if (!extraRewardsSection || !extraRewardsList) return;
    
    if (!rewards || rewards.length === 0) {
      extraRewardsSection.style.display = 'none';
      return;
    }
    
    // ƒê·∫£m b·∫£o th·ª© t·ª±: Doanh nh√¢n ‚Üí L·ªãch 2026 ‚Üí iPhone 17
    const sortedRewards = [
      ...rewards.filter(r => r.label.includes('Ng√†y Doanh nh√¢n')),
      ...rewards.filter(r => r.label.includes('B·ªô l·ªãch 2026')),
      ...rewards.filter(r => r.label.includes('iPhone 17')),
    ];
    
    extraRewardsList.innerHTML = '';
    sortedRewards.forEach((r, idx) => {
      const li = document.createElement('li');
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.padding = '12px 16px';
      li.style.marginBottom = '8px';
      li.style.background = '#f8fafc';
      li.style.border = '1px solid #e2e8f0';
      li.style.borderRadius = '8px';
      li.style.fontSize = '16px';
      
      const labelSpan = document.createElement('span');
      labelSpan.textContent = r.label;
      labelSpan.style.color = '#0b3d2c';
      labelSpan.style.fontWeight = '600';
      
      const valueSpan = document.createElement('span');
      valueSpan.textContent = r.value;
      valueSpan.style.fontWeight = '700';
      valueSpan.style.color = '#059669';
      valueSpan.style.fontSize = '16px';
      
      li.appendChild(labelSpan);
      li.appendChild(valueSpan);
      extraRewardsList.appendChild(li);
    });
    
    extraRewardsSection.style.display = 'block';
  });
}

// ‚úÖ Setup form validation v√† event listeners
function setupFormValidation() {
  // Event listeners cho radio buttons ƒë√£ ƒë∆∞·ª£c x√≥a
  
  // Event listeners cho radio buttons "C√≥ h·ª£p ƒë·ªìng 16tr FYP"
  const has16FYPYes = document.getElementById('p1_has_16fyp_1to8Sep_yes');
  const has16FYPNo = document.getElementById('p1_has_16fyp_1to8Sep_no');
  const expectedCCContainer = document.getElementById('expectedCCContainer');
  const expectedCCCount = document.getElementById('expectedCCCount');
  
  if (has16FYPYes && has16FYPNo && expectedCCContainer && expectedCCCount) {
    has16FYPYes.addEventListener('change', () => {
      if (has16FYPYes.checked) {
        expectedCCContainer.style.display = 'block';
        expectedCCCount.required = true;
        // ‚úÖ C·∫≠p nh·∫≠t th∆∞·ªüng th√™m kh√°c
        computeExtraRewards();
      }
    });
    
    has16FYPNo.addEventListener('change', () => {
      if (has16FYPNo.checked) {
        expectedCCContainer.style.display = 'none';
        expectedCCCount.required = false;
        expectedCCCount.value = '';
        // ‚úÖ C·∫≠p nh·∫≠t th∆∞·ªüng th√™m kh√°c
        computeExtraRewards();
      }
    });
    
    // Validation cho expectedCCCount
    expectedCCCount.addEventListener('input', () => {
      validateExpectedCCCount();
      // ‚úÖ C·∫≠p nh·∫≠t th∆∞·ªüng th√™m kh√°c khi thay ƒë·ªïi s·ªë l∆∞·ª£ng CC
      computeExtraRewards();
    });
    
    expectedCCCount.addEventListener('blur', () => {
      validateExpectedCCCount();
      // ‚úÖ C·∫≠p nh·∫≠t th∆∞·ªüng th√™m kh√°c khi thay ƒë·ªïi s·ªë l∆∞·ª£ng CC
      computeExtraRewards();
    });
    
    // ‚úÖ C·∫≠p nh·∫≠t c·∫£nh b√°o khi thay ƒë·ªïi s·ªë Hƒê Gƒê1
    const sohdGd1 = document.getElementById('sohd-gd1');
    if (sohdGd1) {
      sohdGd1.addEventListener('input', () => {
        validateExpectedCCCount();
      });
      sohdGd1.addEventListener('blur', () => {
        validateExpectedCCCount();
      });
    }
  }
}

// ‚úÖ Validate form Gƒê1 "S·ªë l∆∞·ª£ng CC d·ª± ki·∫øn"
function validateExpectedCCCount() {
  const has16FYPYes = document.getElementById('p1_has_16fyp_1to8Sep_yes');
  const expectedCCCount = document.getElementById('expectedCCCount');
  const sohdGd1 = document.getElementById('sohd-gd1');
  const expectedCCWarning = document.getElementById('expectedCCWarning');
  
  if (!has16FYPYes || !expectedCCCount || !sohdGd1 || !expectedCCWarning) return;
  
  if (has16FYPYes.checked) {
    const cc = parseInt(expectedCCCount.value) || 0;
    const totalP1 = parseInt(sohdGd1.value) || 0;
    
    // Hi·ªÉn th·ªã c·∫£nh b√°o ngay khi nh·∫≠p n·∫øu l·ªõn h∆°n t·ªïng Gƒê1
    if (totalP1 > 0 && cc > totalP1) {
      expectedCCCount.setCustomValidity('');
      expectedCCCount.style.borderColor = '#dc2626';
      expectedCCWarning.textContent = `B·∫°n ch·ªâ ƒë∆∞·ª£c nh·∫≠p t·ªëi ƒëa ${totalP1} CC`;
      expectedCCWarning.style.display = 'block';
    } else if (cc < 1 && cc > 0) {
      expectedCCCount.setCustomValidity('Ph·∫£i ‚â• 1');
      expectedCCCount.style.borderColor = '#dc2626';
      expectedCCWarning.style.display = 'none';
    } else {
      expectedCCCount.setCustomValidity('');
      expectedCCCount.style.borderColor = '#b7e7ce';
      expectedCCWarning.style.display = 'none';
    }
  }
}

// ‚úÖ Validate to√†n b·ªô form
function validateForm() {
  const errors = {};
  
  // Validate Phase 1
  const has16FYPYes = document.getElementById('p1_has_16fyp_1to8Sep_yes');
  const expectedCCCount = document.getElementById('expectedCCCount');
  const sohdGd1 = document.getElementById('sohd-gd1');
  
  if (has16FYPYes && has16FYPYes.checked) {
    const cc = parseInt(expectedCCCount.value) || 0;
    const totalP1 = parseInt(sohdGd1.value) || 0;
    
    if (!(cc >= 1 && cc <= totalP1)) {
      errors.p1 = errors.p1 || {};
      errors.p1.expectedCCCount = 'Ph·∫£i ‚â• 1 v√† ‚â§ t·ªïng s·ªë Hƒê c·ªßa Gƒê1';
    }
  }
  
  return errors;
}

// üß™ Test function ƒë·ªÉ xem "Th∆∞·ªüng th√™m kh√°c" ho·∫°t ƒë·ªông
function testExtraRewards() {
  const testRewards = [
    { label: 'V√© tham d·ª± Ng√†y Doanh nh√¢n 13/10', value: 'ƒê·∫°t' },
    { label: 'Th∆∞·ªüng B·ªô l·ªãch 2026', value: 3 },
    { label: 'Th∆∞·ªüng v√© b·ªëc thƒÉm 17 iPhone 17', value: 2 }
  ];
  
  // L∆∞u v√†o global variable
  window.extraRewards = testRewards;
  
  // Render
  renderExtraRewards(testRewards);
  
  console.log('üß™ Test Extra Rewards:', testRewards);
}

/* ===== INPUT MODES ===== */
function autoFormatInputs(){
  MONEY_INPUT_IDS_EDITABLE.forEach(id=>{const el=document.getElementById(id); if(!el)return;
    el.addEventListener('input',()=>{el.value=el.value.replace(/[^\d\.,]/g,'')});
    el.addEventListener('blur',()=>{const n=parseMoney3(el.value); el.value=n?formatMoney3(n):''; updateTongHop(); calculateIncome();});
  });
  COUNT_INPUT_IDS_EDITABLE.forEach(id=>{const el=document.getElementById(id); if(!el)return;
    el.addEventListener('input',()=>{el.value=el.value.replace(/[^\d]/g,'')});
    el.addEventListener('blur',()=>{el.value=el.value?String(parseInt(el.value,10)):''; updateTongHop(); calculateIncome();});
  });
}
function sanitizeAllNumericInputs(){ALL_MONEY_IDS.forEach(id=>{const el=document.getElementById(id); if(el)el.setAttribute('type','text')});}
function reformatMoneyOutputs(){for(const id of MONEY_OUTPUT_IDS){const el=document.getElementById(id); if(!el)continue; const n=parseMoney3(el.value); el.value=formatMoney3(n||0)}}
function syncReadonlyTitles(){document.querySelectorAll('input[readonly]').forEach(el=>el.title=el.value||'');}

/* ===== NAV + SECTION HI·ªÇN TH·ªä ===== */
function getOffsets(){
  const head=document.getElementById('pageHeader');
  const toc=document.getElementById('tocMobile');
  const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
  let t = 0;
  if(toc && getComputedStyle(toc).display!=='none'){
    t = Math.ceil(toc.getBoundingClientRect().height);
  }
  return {h,t};
}
function showSection(id){
  // 1) ·∫®n/hi·ªán section
  document.querySelectorAll('.app-section').forEach(s=>s.style.display='none');
  const target=document.getElementById(id);
  if(target) target.style.display='block';

  // 2) Active tr√™n sidebar (desktop)
  document.querySelectorAll('#sidebar .menu-item').forEach(a=>a.classList.remove('active'));
  const a=document.querySelector(`#sidebar .menu-item[data-target="${id}"]`); if(a) a.classList.add('active');

  // 3) ƒê·ªìng b·ªô dropdown mobile
  const sel=document.getElementById('tocSelect');
  if(sel){ for(const o of sel.options){ if(o.value===id){ sel.value=id; break; } } }

  // 4) C·∫≠p nh·∫≠t chi·ªÅu cao header/toc ƒë·ªÉ t√≠nh offset
  setLayoutVars();

  // 5) CU·ªòN: lu√¥n ƒë∆∞a v·ªÅ ƒë·∫ßu trang khi chuy·ªÉn menu
  if(target){
    window.scrollTo({ top: 0, behavior:'smooth' });
  }
}
function bindSidebar(){
  document.querySelectorAll('#sidebar .menu-item[data-target]').forEach(a=>{
    a.addEventListener('click',e=>{e.preventDefault(); const id=a.getAttribute('data-target'); if(id) showSection(id);});
  });
}
function buildMobileTOC(){
  const sel=document.getElementById('tocSelect'); if(!sel) return;
  sel.innerHTML='';
  document.querySelectorAll('#sidebar .menu-item[data-target]').forEach(a=>{
    const id=a.getAttribute('data-target'), text=a.textContent.trim();
    const op=document.createElement('option'); op.value=id; op.textContent=text; sel.appendChild(op);
  });
  sel.addEventListener('change',()=>{ showSection(sel.value); });
}

/* ===== TEST FUNCTIONS ===== */
function testSearch() {
  console.log('testSearch called');
  searchForAgent();
}

function testInput() {
  console.log('testInput called - triggered by:', event ? event.type : 'unknown');
  
  // Ki·ªÉm tra quy·ªÅn CHUC DANH cho code th∆∞·ªùng
  if (!currentSpecialUser && originalAgentData && originalAgentData.data) {
    const chucDanh = originalAgentData.data["CHUC DANH"];
    console.log('Checking CHUC DANH:', chucDanh);
    
    if (chucDanh !== "FA") {
      alert('Ch·ª©c nƒÉng d√†nh cho qu·∫£n l√Ω s·∫Ω s·ªõm ƒë∆∞·ª£c c·∫≠p nh·∫≠t.');
      return;
    } else {
      alert('B·∫°n ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn ƒë·ªÉ d√πng ch·ª©c nƒÉng n√†y.');
      return;
    }
  }
  
  const inputElement = document.getElementById('agentSearchInput');
  console.log('Input element found:', !!inputElement);
  
  if (inputElement) {
    console.log('Input value:', inputElement.value);
    
    // N·∫øu input tr·ªëng, hi·ªÉn th·ªã th√¥ng b√°o y√™u c·∫ßu nh·∫≠p th√¥ng tin
    if (!inputElement.value || inputElement.value.trim() === '') {
      alert('Vui l√≤ng nh·∫≠p th√¥ng tin t√¨m ki·∫øm');
      inputElement.focus();
      return;
    }
    
    // G·ªçi searchForAgent v·ªõi gi√° tr·ªã hi·ªán t·∫°i
    searchForAgent();
  } else {
    console.log('Input element not found');
    alert('Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu');
  }
}

function testDirectSearch() {
  console.log('testDirectSearch called');
  const inputElement = document.getElementById('agentSearchInput');
  if (inputElement && inputElement.value) {
    console.log('Input has value:', inputElement.value);
    searchForAgent();
  } else {
    console.log('Input is empty or not found');
    alert('Input tr·ªëng ho·∫∑c kh√¥ng t√¨m th·∫•y!');
  }
}

function testEnter() {
  console.log('testEnter called - simulating Enter key');
  const inputElement = document.getElementById('agentSearchInput');
  if (inputElement) {
    // Simulate Enter key press
    const event = new KeyboardEvent('keydown', {
      key: 'Enter',
      code: 'Enter',
      keyCode: 13,
      which: 13,
      bubbles: true,
      cancelable: true
    });
    inputElement.dispatchEvent(event);
  }
}

// Make functions global for testing
window.testSearch = testSearch;
window.searchForAgent = searchForAgent;
window.testInput = testInput;
window.testDirectSearch = testDirectSearch;
window.testEnter = testEnter;
window.hideMainContent = hideMainContent;
window.showAgentSearchBoxAgain = showAgentSearchBoxAgain;
window.enableManualInputMode = enableManualInputMode;
window.restoreOriginalAgentData = restoreOriginalAgentData;
window.showMobileAgentInfo = showMobileAgentInfo;
window.showMobileCalculatingAgentInfo = showMobileCalculatingAgentInfo;
window.showMobileManualModeInfo = showMobileManualModeInfo;

/* ===== SPECIAL LOGIN & PERMISSIONS ===== */
function checkSpecialPermission(agentId) {
  const permission = SPECIAL_PERMISSIONS[agentId];
  if (!permission) return null;
  
  return {
    ...permission,
    agentId: agentId
  };
}

function hasRegionAccess(agentRegion, userRegions) {
  if (userRegions === 'ALL') return true;
  if (!Array.isArray(userRegions)) return false;
  
  return userRegions.some(region => 
    region.toLowerCase() === agentRegion.toLowerCase()
  );
}

function findAgentInIncome(agentId) {
  console.log('findAgentInIncome - agentId:', agentId);
  console.log('findAgentInIncome - data length:', data.length);
  
  if (!data || data.length === 0) {
    console.log('findAgentInIncome - data is empty or not loaded');
    return null;
  }
  
  // Debug: Ki·ªÉm tra record ƒë·∫ßu ti√™n
  if (data.length > 0) {
    console.log('First record keys:', Object.keys(data[0]));
    console.log('First record MA DAI LY:', data[0]["MA DAI LY"]);
    console.log('getByKeyLoose result:', getByKeyLoose(data[0], "MA DAI LY"));
  }
  
  // Th·ª≠ t√¨m ki·∫øm tr·ª±c ti·∫øp tr∆∞·ªõc
  const directSearch = data.find(r => {
    const maDaiLy = r["MA DAI LY"];
    const isMatch = eqAgent(maDaiLy, agentId);
    if (isMatch) {
      console.log('Direct search found match:', r);
    }
    return isMatch;
  });
  
  if (directSearch) {
    console.log('Direct search success:', directSearch);
    return directSearch;
  }
  
  // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ v·ªõi getByKeyLoose
  const found = data.find((r, index) => {
    const maDaiLy = getByKeyLoose(r, "MA DAI LY");
    const isMatch = eqAgent(maDaiLy, agentId);
    
    if (index < 5) { // Debug 5 record ƒë·∫ßu
      console.log(`Record ${index}:`, {
        originalKey: r["MA DAI LY"],
        getByKeyLoose: maDaiLy,
        agentId: agentId,
        isMatch: isMatch
      });
    }
    
    if (isMatch) {
      console.log('findAgentInIncome - found match at index:', index, r);
    }
    return isMatch;
  });
  
  console.log('findAgentInIncome - result:', found);
  return found;
}

function findAgentInSM(agentId) {
  return smData.find(r => eqAgent(getByKeyLoose(r, "MSDL"), agentId));
}

/* ===== SEARCH / LOGIN ===== */
function searchAgent(){
  const idRaw=(document.getElementById("agent-id").value||'').trim();
  const ngayRaw=(document.getElementById("ngay-gia-nhap").value||'').trim();
  if(!isDataReady){alert("D·ªØ li·ªáu ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.");return}
  if(!idRaw){alert("Vui l√≤ng nh·∫≠p M√£ s·ªë ƒë·∫°i l√Ω");return}
  if(!ngayRaw){alert("Vui l√≤ng nh·∫≠p Ng√†y gia nh·∫≠p");return}
  
  // Ki·ªÉm tra ng√†y gia nh·∫≠p tr∆∞·ªõc (√°p d·ª•ng cho c·∫£ code th∆∞·ªùng v√† ƒë·∫∑c bi·ªát)
  const ngayKey=normalizeDateForCompare(ngayRaw); if(!ngayKey){alert("Ng√†y gia nh·∫≠p kh√¥ng h·ª£p l·ªá.");return}
  
  // Ki·ªÉm tra m√£ ƒë·∫∑c bi·ªát
  const specialPermission = checkSpecialPermission(idRaw);
  if (specialPermission) {
    // ƒêƒÉng nh·∫≠p v·ªõi m√£ ƒë·∫∑c bi·ªát - v·∫´n c·∫ßn ki·ªÉm tra JOIN DATE trong sm.json
    const smAgent = findAgentInSM(idRaw);
    if (!smAgent) {
      alert("M√£ s·ªë ƒë·∫°i l√Ω kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng");
      return;
    }
    
    // Ki·ªÉm tra JOIN DATE c√≥ kh·ªõp kh√¥ng
    const smJoinDate = getByKeyLoose(smAgent, "JOIN DATE");
    if (!datesEqual(smJoinDate, ngayRaw)) {
      alert("Ng√†y gia nh·∫≠p kh√¥ng kh·ªõp v·ªõi d·ªØ li·ªáu h·ªá th·ªëng");
      return;
    }
    
    currentSpecialUser = specialPermission;
    performSpecialLogin(specialPermission);
    return;
  }
  
  // ƒêƒÉng nh·∫≠p th√¥ng th∆∞·ªùng
  if(/^\d{8}$/.test(ngayRaw)){const d=ngayRaw.slice(0,2),m=ngayRaw.slice(2,4),y=ngayRaw.slice(4,8); document.getElementById("ngay-gia-nhap").value=`${d}/${m}/${y}`;}
  const same=data.filter(r=>eqAgent(getByKeyLoose(r,"MA DAI LY"), idRaw));
  const found=same.find(r=>datesEqual(getByKeyLoose(r,"NGAY HIEU LUC HDDL"), ngayRaw));
  if(!found){alert("ƒê·∫°i l√Ω kh√¥ng thu·ªôc h·ªá th·ªëng");return}

  // Hi·ªÉn th·ªã loading screen
  showLoadingScreen();
  
  // Hi·ªÉn th·ªã banner ch√†o m·ª´ng sau 1 gi√¢y
  setTimeout(() => {
    hideLoadingScreen();
    
    // C·∫≠p nh·∫≠t t√™n trong banner
    const welcomeName = document.getElementById('welcomeName');
    if (welcomeName) {
      const hoTen = getByKeyLoose(found, "TEN DAI LY") || '';
      const chucDanh = getByKeyLoose(found, "CHUC DANH") || '';
      
      // Ch·ªâ hi·ªÉn th·ªã CHUC DANH + TEN DAI LY tr√™n mobile v·ªõi code th∆∞·ªùng
      console.log('Debug banner:', { chucDanh, hoTen, windowWidth: window.innerWidth });
      if (window.innerWidth <= 1023) {
        welcomeName.textContent = `${chucDanh} ${hoTen}`.trim();
        console.log('Mobile banner set to:', welcomeName.textContent);
      } else {
      welcomeName.textContent = hoTen;
        console.log('Desktop banner set to:', welcomeName.textContent);
      }
    }
    
    // Hi·ªÉn th·ªã banner
    const welcomeBanner = document.getElementById('welcomeBanner');
    if (welcomeBanner) {
      welcomeBanner.style.display = 'block';
    }
    
    // Hi·ªÉn th·ªã mobile container
    const mobileContainer = document.getElementById('mobileContainer');
    if (mobileContainer) {
      mobileContainer.style.display = 'block';
      const mobileUpdateDateText = document.getElementById('mobileUpdateDateText');
      if (mobileUpdateDateText) {
        // L·∫•y ng√†y ch·ªët t·ª´ c·ªôt "NGAY CHOT DU LIEU" trong income.json
        const ngayChot = found["NGAY CHOT DU LIEU"];
        
        if (ngayChot) {
          // Hi·ªÉn th·ªã ng√†y ch·ªët t·ª´ d·ªØ li·ªáu th·ª±c t·∫ø
          mobileUpdateDateText.textContent = ngayChot;
        } else {
          // Fallback: L·∫•y ng√†y cu·ªëi c√πng c·ªßa th√°ng li·ªÅn tr∆∞·ªõc (th·ª±c t·∫ø)
          const now = new Date();
          // T√≠nh th√°ng li·ªÅn tr∆∞·ªõc (th√°ng hi·ªán t·∫°i - 1)
          let lastMonthYear = now.getFullYear();
          let lastMonthMonth = now.getMonth() - 1;
          
          // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p th√°ng 1 (th√°ng 0)
          if (lastMonthMonth < 0) {
            lastMonthMonth = 11; // Th√°ng 12
            lastMonthYear = now.getFullYear() - 1; // NƒÉm tr∆∞·ªõc
          }
          
          // L·∫•y ng√†y cu·ªëi c√πng c·ªßa th√°ng li·ªÅn tr∆∞·ªõc
          const lastDayOfLastMonth = new Date(lastMonthYear, lastMonthMonth + 1, 0);
          mobileUpdateDateText.textContent = lastDayOfLastMonth.toLocaleDateString('vi-VN');
        }
      }
    }
    
    // Hi·ªÉn th·ªã update date desktop
    // Kh√¥ng c·∫ßn hi·ªÉn th·ªã update date n·ªØa
  }, 1000);

  document.getElementById("ho-ten").value=getByKeyLoose(found,"TEN DAI LY")||'';
  document.getElementById("khu-vuc").value=getByKeyLoose(found,"KHU VUC")||'';
  document.getElementById("thang-lam-viec").value=parseActiveValue(getByKeyLoose(found,"SO THANG LAM VIEC"));
  // C·∫≠p nh·∫≠t tr∆∞·ªùng ph√¢n nh√≥m ƒë·∫°i l√Ω (c√≥ th·ªÉ l√† input ho·∫∑c dropdown)
  const nhomDaiLyValue = getByKeyLoose(found,"NHOM DAI LY")||'';
  const manualDropdown = document.getElementById('nhom-dai-ly-dropdown');
  if (manualDropdown) {
    // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô th·ªß c√¥ng v·ªõi dropdown
    manualDropdown.value = nhomDaiLyValue;
  } else {
    // N·∫øu l√† input th√¥ng th∆∞·ªùng
    const inputField = document.getElementById('nhom-dai-ly');
    if (inputField) {
      inputField.value = nhomDaiLyValue;
    }
  }
  const p13=parseActiveValue(getByKeyLoose(found,"TLDTHD CA NHAN") ?? getByKeyLoose(found,"P13 CA NHAN"));
  document.getElementById("p13-ca-nhan").value=Number.isFinite(p13)&&p13!==0?p13:'';
  document.getElementById("he-so-thuong").value=getHeSoThuong(p13);
  document.getElementById("mdrt-fyp").value=formatMoney3(parseActiveValue(getByKeyLoose(found,"MDRT-FYP TOI HIEN TAI")));
  const fycT1=parseActiveValue(getByKeyLoose(found,"FYC THANG T-1"));
  const fycT2=parseActiveValue(getByKeyLoose(found,"FYC THANG T-2"));
  document.getElementById("tong-fyc").value=formatMoney3(fycT1+fycT2);
  document.getElementById("tong-fyc-quy").value=formatMoney3(parseActiveValue(getByKeyLoose(found,"TONG FYC TRONG QUY HIEN TAI")));
  // T√≠nh s·ªë th√°ng c√≥ ho·∫°t ƒë·ªông trong qu√Ω d·ª±a tr√™n th√°ng hi·ªán t·∫°i
  // Logic: T l√† th√°ng hi·ªán t·∫°i, suy ra T-1 v√† T-2 theo qu√Ω
  const currentMonth = new Date().getMonth() + 1; // Th√°ng hi·ªán t·∫°i (1-12)
  
  // X√°c ƒë·ªãnh qu√Ω hi·ªán t·∫°i v√† c√°c th√°ng c·∫ßn x√©t
  let month1, month2, month3;
  
  if (currentMonth >= 1 && currentMonth <= 3) {
    // Qu√Ω 1: th√°ng 1, 2, 3
    month1 = 1; month2 = 2; month3 = 3;
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    // Qu√Ω 2: th√°ng 4, 5, 6
    month1 = 4; month2 = 5; month3 = 6;
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    // Qu√Ω 3: th√°ng 7, 8, 9
    month1 = 7; month2 = 8; month3 = 9;
  } else {
    // Qu√Ω 4: th√°ng 10, 11, 12
    month1 = 10; month2 = 11; month3 = 12;
  }
  
  // G√°n gi√° tr·ªã cho Active T, T-1, T-2 d·ª±a tr√™n th√°ng hi·ªán t·∫°i
  let activeT, activeT1, activeT2;
  
  if (currentMonth === month1) {
    // Th√°ng ƒë·∫ßu qu√Ω: ch·ªâ x√©t th√°ng hi·ªán t·∫°i
    activeT = getByKeyLoose(found, "HOAT DONG THANG T");
    activeT1 = 0; activeT2 = 0;
  } else if (currentMonth === month2) {
    // Th√°ng gi·ªØa qu√Ω: x√©t 2 th√°ng ƒë·∫ßu qu√Ω
    activeT = getByKeyLoose(found, "HOAT DONG THANG T");
    activeT1 = getByKeyLoose(found, "HOAT DONG THANG T-1");
    activeT2 = 0;
  } else {
    // Th√°ng cu·ªëi qu√Ω: x√©t c·∫£ 3 th√°ng c·ªßa qu√Ω
    activeT = getByKeyLoose(found, "HOAT DONG THANG T");
    activeT1 = getByKeyLoose(found, "HOAT DONG THANG T-1");
    activeT2 = getByKeyLoose(found, "HOAT DONG THANG T-2");
  }
  

  
  const activeTNum = parseActiveValue(activeT);
  const activeT1Num = parseActiveValue(activeT1);
  const activeT2Num = parseActiveValue(activeT2);
  
  // ƒê·∫øm s·ªë th√°ng c√≥ ho·∫°t ƒë·ªông (gi√° tr·ªã > 0)
  let activeMonthsCount = 0;
  if (activeTNum > 0) activeMonthsCount++;
  if (activeT1Num > 0) activeMonthsCount++;
  if (activeT2Num > 0) activeMonthsCount++;
  
  document.getElementById("active-months").value = activeMonthsCount.toString();

  ["sohd-gd1","sohd-gd2","sohd-gd3","fypchinh-gd1","fypchinh-gd2","fypchinh-gd3","fypkem-gd1","fypkem-gd2","fypkem-gd3"].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  sanitizeAllNumericInputs(); 
  updateTongHop(); // updateTongHop() ƒë√£ bao g·ªìm t·∫•t c·∫£ c√°c h√†m t√≠nh th∆∞·ªüng
  calculateTongThuNhap(); // T√≠nh t·ªïng thu nh·∫≠p cu·ªëi c√πng
  syncReadonlyTitles();

  // L∆∞u th√¥ng tin ƒë·∫°i l√Ω g·ªëc ƒë·ªÉ c√≥ th·ªÉ kh√¥i ph·ª•c sau n√†y
  originalAgentData = { id: idRaw, data: found };
  
  // Thi·∫øt l·∫≠p th√¥ng tin ƒë·∫°i l√Ω ƒëang t√≠nh
  currentCalculatingAgent = { id: idRaw, data: found };
  
  // Hi·ªÉn th·ªã container cho ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng
  showNormalLoginContainer();
  
  // Hi·ªÉn th·ªã th√¥ng tin ƒë·∫°i l√Ω trong sidebar
  showCalculatingAgentInfo();

  isLoggedIn=true;
  // B·∫≠t giao di·ªán sau ƒëƒÉng nh·∫≠p
  document.body.classList.remove('logged-out');
  document.body.classList.add('logged-in');
  applySidebarMode(); // ch·ªâ b·∫≠t sidebar tr√™n desktop
  buildMobileTOC();
  showSection('sec-daily');
  setLayoutVars();          // c·∫≠p nh·∫≠t header/toc/footer height ƒë·ªÉ ƒë·∫©y n·ªôi dung xu·ªëng d∆∞·ªõi ƒë√∫ng chu·∫©n
}

/* ===== ENTER TO CALC ===== */
function enableEnterToCalc(){
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    if(!isLoggedIn) return;
    const ae=document.activeElement;
    if(ae && (ae.id==='agent-id' || ae.id==='ngay-gia-nhap')) return;
    e.preventDefault();
    const btn=document.getElementById('calc-btn');
    if(btn) btn.click();
  });
}

/* ===== LAYOUT VARS ===== */
function setLayoutVars(){
  const head=document.getElementById('pageHeader');
  const footer=document.getElementById('pageFooter');
  const toc=document.getElementById('tocMobile');
  const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
  const f = footer ? Math.ceil(footer.getBoundingClientRect().height) : 66;
  let t = 0;
  if(toc && getComputedStyle(toc).display!=='none'){
    t = Math.ceil(toc.getBoundingClientRect().height);
  }
  document.documentElement.style.setProperty('--header-h', h+'px');
  document.documentElement.style.setProperty('--footer-h', f+'px');
  document.documentElement.style.setProperty('--toc-h', t+'px');
}
function applySidebarMode(){
  if(!document.body.classList.contains('logged-in')) return;
  if(window.matchMedia('(min-width:1024px)').matches){
    document.body.classList.add('sidebar-open');
  }else{
    document.body.classList.remove('sidebar-open');
  }
}

/* ===== G·ªòP T√çNH THU NH·∫¨P ===== */
function calculateIncome(){
  console.log('=== calculateIncome START ===');
  
  // Ki·ªÉm tra ch·∫ø ƒë·ªô nh·∫≠p th·ªß c√¥ng
  if (currentCalculatingAgent && currentCalculatingAgent.isManualMode) {
    console.log('Manual input mode - calculations based on manual input');
  }
  
  // 1. CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU V·ªÄ S·ªê TR∆Ø·ªöC KHI T√çNH
  const tongFYP = parseMoney3(document.getElementById('tong-fyp').value) || 0;
  const chinh = parseMoney3(document.getElementById('fyp-chinh').value) || 0;
  const kem = parseMoney3(document.getElementById('fyp-kem').value) || 0;

  console.log('calculateIncome - INPUT VALUES:', {
    tongFYP: tongFYP,
    chinh: chinh,
    kem: kem
  });

  // 2. TH·ª∞C HI·ªÜN LOGIC T√çNH TO√ÅN V·ªöI S·ªê
  const fycChinh = chinh * 0.3;
  const fycKem = kem * 0.2;
  const thuongKem = kem * 0.2;
  const fycThuong = fycChinh + fycKem + thuongKem;

  console.log('calculateIncome - CALCULATED VALUES:', {
    fycChinh: fycChinh,
    fycKem: fycKem,
    thuongKem: thuongKem,
    fycThuong: fycThuong
  });

  // 3. HI·ªÇN TH·ªä K·∫æT QU·∫¢ THEO ƒê·ªäNH D·∫†NG Y√äU C·∫¶U
  document.getElementById('fyc-chinh').value = formatMoney3(fycChinh);
  document.getElementById('fyc-kem').value = formatMoney3(fycKem);
  document.getElementById('thuong-kem').value = formatMoney3(thuongKem);
  document.getElementById('fyc-thuong').value = formatMoney3(fycThuong);

  // 4. G·ªåI C√ÅC H√ÄM T√çNH TH∆Ø·ªûNG KH√ÅC
  console.log('calculateIncome - calling calculateNSPro()');
  calculateNSPro();
  
  console.log('calculateIncome - calling calculateNST()');
  calculateNST();
  
  console.log('calculateIncome - calling calculateNSQ()');
  calculateNSQ();
  
  console.log('calculateIncome - calling calculateThuongMDRT()');
  calculateThuongMDRT();
  
  console.log('calculateIncome - calling calculateTongThuNhap()');
  calculateTongThuNhap();
  
  console.log('=== calculateIncome END ===');
}

/* ===== LOADING SCREEN FUNCTIONS ===== */
function showLoadingScreen() {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'flex';
  }
}

function hideLoadingScreen() {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'none';
  }
}

/* ===== TEST FUNCTIONS ===== */
function testCalculations() {
  console.log('=== TESTING CALCULATIONS ===');
  
  // Ki·ªÉm tra d·ªØ li·ªáu ƒë√£ load
  console.log('Data status:', {
    income: data.length,
    nspro: nspro.length,
    nst6: nst6.length,
    nst7: nst7.length,
    nsq6: nsq6.length,
    nsq7: nsq7.length,
    hsdt: hsdt.length,
    trackingMDRT: trackingMDRT.length
  });
  
  // Test parseMoney3
  console.log('parseMoney3 test:', {
    '1000': parseMoney3('1000'),
    '1,000': parseMoney3('1,000'),
    '1.000': parseMoney3('1.000'),
    'empty': parseMoney3(''),
    'null': parseMoney3(null),
    'undefined': parseMoney3(undefined)
  });
  
  // Test getByKeyLoose
  if(nst6.length > 0) {
    const testRow = nst6[0];
    console.log('getByKeyLoose test with nst6[0]:', {
      original: testRow,
      'FYC TRONG 3 THANG GAN NHAT': getByKeyLoose(testRow, 'FYC TRONG 3 THANG GAN NHAT'),
      '% TY LE THUONG NANG SUAT THANG': getByKeyLoose(testRow, '% TY LE THUONG NANG SUAT THANG')
    });
  } else {
    console.log('nst6 is empty or not loaded');
  }
  
  // Test normKeyMap
  if(nst6.length > 0) {
    const testRow = nst6[0];
    const keys = normKeyMap(testRow);
    console.log('normKeyMap test:', {
      original: Object.keys(testRow),
      normalized: Object.keys(keys)
    });
  }
  
  // Test v·ªõi d·ªØ li·ªáu th·ª±c t·∫ø
  console.log('Testing with real data...');
  if(data.length > 0) {
    console.log('Sample income data:', data[0]);
  }
}

/* ===== INIT ===== */
window.addEventListener('load', async ()=>{
  await loadData();
  
  // Test c√°c h√†m sau khi load d·ªØ li·ªáu
  setTimeout(() => {
    testCalculations();
  }, 1000);
  
  populateMonthSelect(); sanitizeAllNumericInputs(); autoFormatInputs();
  enableEnterToCalc(); setLayoutVars(); applySidebarMode();
  window.addEventListener('resize', ()=>{ setLayoutVars(); applySidebarMode(); updateBannerForMobile(); });

  // Chu·∫©n ho√° nh·∫≠p ng√†y
  const ngay=document.getElementById("ngay-gia-nhap");
  if(ngay){
    ngay.addEventListener('blur',()=>{const v=ngay.value.trim(); if(/^\d{8}$/.test(v)) ngay.value=standardizeDate(v);});
    document.getElementById("agent-id").addEventListener("keydown",e=>{if(e.key==="Enter")searchAgent()});
    ngay.addEventListener("keydown",e=>{if(e.key==="Enter")searchAgent()});
  }

  // Form submit event
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      searchAgent();
    });
  }
  
  // Th√™m class mobile cho body n·∫øu c·∫ßn
  if (window.matchMedia('(max-width: 1023px)').matches) {
    document.body.classList.add('mobile');
  }
  
  // Mobile menu event listeners
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileCalculateOtherBtn = document.getElementById('mobileCalculateOtherBtn');
  const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
  const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');
  
  if (mobileMenuBtn) {
    mobileMenuBtn.onclick = () => {
      mobileMenuDropdown.style.display = mobileMenuDropdown.style.display === 'none' ? 'block' : 'none';
      return false;
    };
  }
  if (mobileCalculateOtherBtn) {
    mobileCalculateOtherBtn.onclick = () => {
      // Ki·ªÉm tra xem c√≥ ph·∫£i ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng kh√¥ng
      const isNormalLogin = !currentSpecialUser && originalAgentData && originalAgentData.data;
      
      if (isNormalLogin) {
        // ƒêƒÉng nh·∫≠p b√¨nh th∆∞·ªùng: g·ªçi c·ª•m t√¨m ki·∫øm v√† thay ƒë·ªïi n√∫t
        hideMainContent();
        showAgentSearchBoxAgain();
        
        // Thay ƒë·ªïi n√∫t trong TOC th√†nh "T√≠nh cho t√¥i" m√†u xanh l√°
        mobileCalculateOtherBtn.textContent = 'T√≠nh cho t√¥i';
        mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn normal-login';
        mobileCalculateOtherBtn.style.background = '#059669';
        mobileCalculateOtherBtn.style.borderColor = '#059669';
        
        // Thay ƒë·ªïi ch·ª©c nƒÉng n√∫t
        mobileCalculateOtherBtn.onclick = () => {
          restoreOriginalAgentData();
          
          // Thay ƒë·ªïi n√∫t tr·ªü l·∫°i "T√≠nh cho ƒë·∫°i l√Ω kh√°c" sau khi restore
          mobileCalculateOtherBtn.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
          mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn';
          mobileCalculateOtherBtn.style.background = '#f59e0b';
          mobileCalculateOtherBtn.style.borderColor = '#f59e0b';
          
          // Thay ƒë·ªïi ch·ª©c nƒÉng n√∫t tr·ªü l·∫°i g·ªçi search
          mobileCalculateOtherBtn.onclick = () => {
            // Ki·ªÉm tra xem c√≥ ph·∫£i ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng kh√¥ng
            const isNormalLogin = !currentSpecialUser && originalAgentData && originalAgentData.data;
            
            if (isNormalLogin) {
              // ƒêƒÉng nh·∫≠p b√¨nh th∆∞·ªùng: g·ªçi c·ª•m t√¨m ki·∫øm v√† thay ƒë·ªïi n√∫t
              hideMainContent();
              showAgentSearchBoxAgain();
              
              // Thay ƒë·ªïi n√∫t trong TOC th√†nh "T√≠nh cho t√¥i" m√†u xanh l√°
              mobileCalculateOtherBtn.textContent = 'T√≠nh cho t√¥i';
              mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn normal-login';
              mobileCalculateOtherBtn.style.background = '#059669';
              mobileCalculateOtherBtn.style.borderColor = '#059669';
              
              // Thay ƒë·ªïi ch·ª©c nƒÉng n√∫t
              mobileCalculateOtherBtn.onclick = () => {
                restoreOriginalAgentData();
                
                // Thay ƒë·ªïi n√∫t tr·ªü l·∫°i "T√≠nh cho ƒë·∫°i l√Ω kh√°c" sau khi restore
                mobileCalculateOtherBtn.textContent = 'T√≠nh cho ƒë·∫°i l√Ω kh√°c';
                mobileCalculateOtherBtn.className = 'mobile-calculate-other-btn';
                mobileCalculateOtherBtn.style.background = '#f59e0b';
                mobileCalculateOtherBtn.style.borderColor = '#f59e0b';
                
                console.log('Mobile: Restored to original agent data from TOC button');
                return false;
              };
              
              console.log('Mobile: Called showAgentSearchBoxAgain and changed button to "T√≠nh cho t√¥i"');
            } else {
              // Code ƒë·∫∑c bi·ªát: g·ªçi c·ª•m t√¨m ki·∫øm b√¨nh th∆∞·ªùng
              hideMainContent();
              showAgentSearchBoxAgain();
              console.log('Mobile: Called showAgentSearchBoxAgain from mobile TOC button');
            }
            
            return false;
          };
          
          console.log('Mobile: Restored to original agent data from TOC button');
          return false;
        };
        
        console.log('Mobile: Called showAgentSearchBoxAgain and changed button to "T√≠nh cho t√¥i"');
      } else {
        // Code ƒë·∫∑c bi·ªát: g·ªçi c·ª•m t√¨m ki·∫øm b√¨nh th∆∞·ªùng
        hideMainContent();
        showAgentSearchBoxAgain();
        console.log('Mobile: Called showAgentSearchBoxAgain from mobile TOC button');
      }
      
      return false;
    };
  }
  
  if (mobileLogoutBtn) {
    mobileLogoutBtn.onclick = () => {
      location.reload();
      return false;
    };
  }
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!mobileMenuBtn?.contains(e.target) && !mobileMenuDropdown?.contains(e.target)) {
      if (mobileMenuDropdown) {
        mobileMenuDropdown.style.display = 'none';
      }
    }
  });
  
  // Function ƒë·ªÉ hi·ªÉn th·ªã l·∫°i container t√¨m ki·∫øm ƒë·∫°i l√Ω
  window.showAgentSearchAgain = function() {
    console.log('showAgentSearchAgain called');
    
    // ·∫®n mobile container
    const mobileContainer = document.getElementById('mobileContainer');
    if (mobileContainer) {
      mobileContainer.style.display = 'none';
    }
    
    // Hi·ªÉn th·ªã l·∫°i agent search container
    showAgentSearchBox();
    
    // ·∫®n n·ªôi dung ch√≠nh
    hideMainContent();
  };
  
  // Mobile menu item click handlers
  document.querySelectorAll('.mobile-menu-item').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const target = item.getAttribute('data-target');
      if (target) {
        showSection(target);
        if (mobileMenuDropdown) {
          mobileMenuDropdown.style.display = 'none';
        }
      }
    });
  });

  // Sidebar click
  bindSidebar();

  // ‚úÖ Event listeners cho radio buttons v√† validation
  setupFormValidation();

  // M·∫∑c ƒë·ªãnh ·∫©n t·∫•t c·∫£ section khi ch∆∞a login
  document.querySelectorAll('.app-section').forEach(s=>s.style.display='none');
});
  </script>
</body>
</html>
