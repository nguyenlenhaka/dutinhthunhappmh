<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DỰ TÍNH THU NHẬP – Vùng Hằng Lâm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Font của dự án -->
  <link rel="stylesheet" href="fonts/fonts.css" />
  <!-- Tailwind (chỉ dùng utility nhỏ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --sidebar-width: 360px;
      --header-h: 64px;
      --footer-h: 66px;
      --toc-h: 0px;          /* chiều cao dropdown mobile (tự tính bằng JS) */
      --brand:#0051c1; 
      --accent:#00a758;
    }
    /* đảm bảo không tràn ngang trên mọi thiết bị */
    html,body{height:100%;margin:0;background:#f3f4f6;overflow-x:hidden}
    *{box-sizing:border-box;min-width:0}

    /* ===== HEADER (FIXED) ===== */
    .app-header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#e8fff3; border-bottom:1px solid #d9f7e6;
      padding-top:env(safe-area-inset-top,0px);
    }
    /* header chia 2 khu: brand (logo+tên) và login */
    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:center; gap:12px; padding:10px 12px;
    }
    .brand-row{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo-d{ height:48px; width:auto; display:block; flex:0 0 auto; }

    /* Tiêu đề: cho phép xuống dòng, không cắt dấu */
    .title-wrap{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title-top,.title-main{
      font-family:'Manulife JH Sans','ManulifeJHSans',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:#059669; font-weight:800;
      white-space:normal; overflow:visible; text-overflow:clip;
      word-break:keep-all; line-height:1.25; padding-block:2px;
    }
    .title-top{  font-size:clamp(14px, 1vw + 10px, 22px); }
    .title-main{ font-size:clamp(18px, 1.8vw + 12px, 34px); }

    /* ===== LOGIN / LOGOUT ===== */
    .login-cluster{
      display:grid; gap:.5rem; align-items:center;
      grid-template-columns: 1fr; /* MỖI DÒNG 1 TRƯỜNG TRÊN MOBILE */
      width:min(560px, 100%);
      justify-self:end;
    }
    .login-cluster input{
      height:44px; padding:0 12px; font-size:16px; border:1.3px solid #b7e7ce; border-radius:10px;
      background:#effaf3; font-weight:600; color:#0d7233; outline:none; width:100%;
    }
    .login-btn{
      height:44px; padding:0 18px; background:#008a53; color:#fff; border:none; border-radius:10px;
      font-weight:800; cursor:pointer; touch-action:manipulation;
    }
    .login-btn:hover{ background:#066a42; }
    .logout-only{ display:none !important; }
    body.logged-in .login-only{ display:none !important; }
    body.logged-in .logout-only{ display:block !important; }

    /* ===== SIDEBAR (DESKTOP) ===== */
    #sidebar{
      position:fixed; left:0; top:var(--header-h); bottom:var(--footer-h);
      width:var(--sidebar-width); background:#fff; border-right:1px solid #e5e7eb; z-index:900;
      overflow-y:auto; overflow-x:hidden; display:none;
    }
    .sidebar-inner{ padding:12px; }
    .menu-title{ font-weight:900; color:#065f46; margin:6px 8px 8px; white-space:normal; line-height:1.25; }
    .menu-group{ margin:12px 0 6px 8px; font-weight:900; color:#0b3d2c; white-space:normal; line-height:1.25; }
    .menu-item{
      display:block; padding:.55rem .75rem; border-radius:.55rem; font-weight:800; color:#0b3d2c;
      white-space:normal; overflow-wrap:anywhere; word-break:break-word; line-height:1.25; font-size:0.96rem;
    }
    .menu-item:hover{ background:#e5f7ee; }
    .menu-item.active{ background:#0ea35b; color:#fff; }
    .submenu{ margin:.25rem 0 .5rem .75rem; }
    .submenu .menu-item{ padding:.45rem .6rem; }

    /* ===== MOBILE TOC (DANH MỤC DROPDOWN) =====
       Luôn treo dưới header -> fixed + top = --header-h */
    #tocMobile{
      position:fixed; top:var(--header-h); left:0; right:0; z-index:880;
      background:#fff; padding:10px 10px 6px;
      border-bottom:1px solid #e5e7eb; display:none;
      will-change:top;
    }
    #tocMobile .row{ display:flex; gap:8px; }
    #tocSelect{
      flex:1 1 auto; height:44px; border:1px solid #c7d5e6; border-radius:10px; padding:0 10px; font-weight:800; color:#00519c; background:#eff5ff;
      font-size:16px;
    }
    #supportMobile{ flex:0 0 auto; display:inline-flex; align-items:center; justify-content:center; height:44px;
      padding:0 14px; background:#00a758; color:#fff; border-radius:10px; text-decoration:none; font-weight:900; white-space:nowrap; }

    /* ===== CONTENT ===== */
    /* chừa chỗ dưới header + dropdown mobile (nếu có) */
    body{ padding-top: calc(var(--header-h) + var(--toc-h) + 8px); }
    /* chừa chỗ cho footer */
    body{ padding-bottom: calc(2.25 * var(--footer-h) + env(safe-area-inset-bottom,0px)); }

    #contentWrap{ margin-left:0; }
    body.sidebar-open #contentWrap{ margin-left:var(--sidebar-width); }
    main{ max-width:1200px; margin:0 auto; padding:14px; }

    /* Ẩn toàn bộ phần ngoài header khi chưa login */
    body.logged-out #sidebar,
    body.logged-out #tocMobile,
    body.logged-out #contentWrap,
    body.logged-out #supportDesk { display:none !important; }

    .section-title{
      background:#fff; padding:12px 16px; border-left:6px solid #0ea35b; border-radius:8px;
      font-weight:900; color:#0b3d2c; margin:6px 0 14px;
    }

    :root{ --pad:18px; }
    .top-fields,.top-fields-2{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;align-items:end;margin:10px var(--pad)}
    .top-fields-2{margin-bottom:8px}
    .field{grid-column:span 4;display:flex;flex-direction:column;min-width:0}
    .field label{font-size:1.05rem;font-weight:800;color:#24364a;margin:0 0 6px 2px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .field input,.field select{
      height:46px;padding:0 12px;font-size:16px;border:1.3px solid #c7d5e6;border-radius:8px;background-color:#effaf3;
      font-weight:800;color:var(--brand);text-align:center
    }
    .field input[readonly]{background:#f5fffb;color:#0b8a62;border-color:#bfc7d1}
    .gd-stage>b{display:block;margin:6px var(--pad);font-weight:900;}
    .summary-row{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;align-items:end;margin:16px var(--pad) 8px}
    .summary-block{grid-column:span 6;text-align:center;min-width:0}
    .summary-block label{color:#0051c1;font-weight:900;letter-spacing:.02em;display:block;margin-bottom:6px;text-transform:uppercase;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .summary-block input{background:#f5fffb;color:#048f60;border:2px solid #00a578;border-radius:10px;font-size:16px;font-weight:900;height:56px;text-align:center;width:100%}
    .calc-wrap{display:flex;align-items:center;gap:10px}
    #calc-btn{background:#0d72b5;color:#fff;border:none;border-radius:12px;padding:14px 24px;font-size:18px;font-weight:800;box-shadow:0 6px 18px rgba(13,114,181,.25);white-space:nowrap;cursor:pointer;touch-action:manipulation}
    #calc-btn:hover{background:#085a93}

    /* ===== MOBILE: MỖI DÒNG 1 TRƯỜNG ===== */
    @media (max-width:1023px){
      /* BRAND & LOGIN: brand (logo + tên) cùng 1 dòng; login mỗi thành phần 1 dòng */
      .header-grid{ grid-template-columns:1fr; }
      .brand-row{ justify-content:flex-start; }
      .login-cluster{ width:100%; justify-self:stretch; grid-template-columns:1fr; }
      .logo-d{ height:44px; }
      .title-top{ font-size:clamp(13px, 1.6vw + 10px, 18px); }
      .title-main{ font-size:clamp(16px, 3vw + 10px, 24px); }

      .top-fields,.top-fields-2{grid-template-columns:1fr;gap:10px}
      .field{grid-column:1/-1}

      /* TẤT CẢ CÁC KHỐI TÓM TẮT cũng 1 cột */
      .summary-row{grid-template-columns:1fr}
      .summary-block{grid-column:1/-1}

      body.sidebar-open #contentWrap{ margin-left:0 } /* mobile không chừa chỗ sidebar */
      body.logged-in #tocMobile{ display:block; }     /* dropdown luôn hiện khi đã đăng nhập */
    }
    @media (min-width:1024px){
      body.logged-in #sidebar{ display:block; }
      body.logged-in.sidebar-open #supportDesk{ display:inline-flex; }
    }

    /* ===== FOOTER ===== */
    #pageFooter{
      position:fixed; left:0; right:0; bottom:0;
      min-height:var(--footer-h);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      background:#f4f6f8; color:#0b3a2a; border-top:1px solid #e3e7eb; z-index:950;
      padding:8px 10px 10px; text-align:center; font-weight:800;
    }
    #pageFooter img{ height:22px; width:auto; display:block; }
    #contentWrap::after{ content:""; display:block; height: calc(0.75 * var(--footer-h) + 24px); }

    /* Hỗ trợ desktop */
    #supportDesk{
      position:fixed; right:18px; bottom:calc(var(--footer-h) + 14px);
      background:#00a758;color:#fff;padding:12px 16px;border-radius:28px;font-weight:900;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,.18); z-index:940; display:none;
    }
  </style>
</head>
<body class="logged-out">
  <!-- ===== HEADER ===== -->
  <header id="pageHeader" class="app-header">
    <div class="header-grid">
      <!-- Hàng brand: logo & tên trang cùng 1 dòng -->
      <div class="brand-row">
        <img src="/logo.webp" alt="logo" class="logo-d" />
        <div class="title-wrap">
          <div class="title-top">CỔNG THÔNG TIN VÙNG HẰNG LÂM</div>
          <div class="title-main">DỰ TÍNH THU NHẬP</div>
        </div>
      </div>
      <!-- Cụm đăng nhập: LUÔN theo từng dòng trên mobile; desktop gọn gàng bên phải -->
      <div class="login-cluster">
        <input class="login-only" type="text" id="agent-id" placeholder="Nhập MSĐL" />
        <input class="login-only" type="text" id="ngay-gia-nhap" placeholder="Ngày gia nhập (dd/mm/yyyy hoặc ddmmyyyy)" />
        <button class="login-btn login-only" type="button" onclick="searchAgent()"><b>Đăng nhập</b></button>
        <button id="logoutBtn" class="login-btn logout-only" type="button" onclick="location.reload()">Đăng xuất</button>
      </div>
    </div>
  </header>

  <!-- ===== MOBILE TOC (treo dưới header) ===== -->
  <div id="tocMobile">
    <div class="row">
      <select id="tocSelect" aria-label="Chọn mục"></select>
      <a id="supportMobile" href="http://zalo.me/0376763390" target="_blank" rel="noopener">Hỗ trợ</a>
    </div>
  </div>

  <!-- ===== SIDEBAR (desktop) ===== -->
  <aside id="sidebar">
    <div class="sidebar-inner">
      <div class="menu-title">Danh mục</div>

      <a href="#" class="menu-item active" data-target="sec-daily">THÔNG TIN ĐẠI LÝ</a>

      <div class="menu-group">A. THU NHẬP TỪ BÁN HÀNG CÁ NHÂN</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sec-muctieu">1. Mục tiêu tháng</a>
        <a href="#" class="menu-item" data-target="sec-khoanthu">2. Các khoản thu nhập</a>
        <a href="#" class="menu-item" data-target="sec-ban-hang">3. Thu nhập</a>
      </div>

      <div class="menu-group">B. THU NHẬP TỪ HOẠT ĐỘNG TUYỂN DỤNG</div>
      <a href="#" class="menu-item" data-target="sec-tuyendung">Coming Soon</a>

      <div class="menu-group">C. THU NHẬP TỪ HOẠT ĐỘNG QUẢN LÝ</div>
      <a href="#" class="menu-item" data-target="sec-quan-ly">Coming Soon</a>

      <a href="#" class="menu-item" data-target="sec-tong">D. TỔNG THU NHẬP</a>
    </div>
  </aside>

  <!-- ===== CONTENT ===== -->
  <a id="supportDesk" href="http://zalo.me/0376763390" target="_blank" rel="noopener">Hỗ trợ</a>

  <div id="contentWrap">
    <main>
      <!-- 1) THÔNG TIN ĐẠI LÝ -->
      <section id="sec-daily" class="app-section">
        <div class="section-title">THÔNG TIN ĐẠI LÝ</div>
        <div class="top-fields">
          <div class="field" style="flex:6">
            <label for="ho-ten"><b>Họ và tên</b></label>
            <input type="text" id="ho-ten" readonly />
          </div>
          <div class="field" style="flex:2">
            <label for="khu-vuc"><b>Khu vực</b></label>
            <input type="text" id="khu-vuc" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1.5">
            <label for="thang-lam-viec"><b>Thâm niên (tháng)</b></label>
            <input type="text" id="thang-lam-viec" readonly />
          </div>
          <div class="field" style="flex:4">
            <label for="nhom-dai-ly"><b>Phân nhóm đại lý</b></label>
            <input type="text" id="nhom-dai-ly" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1">
            <label for="p13-ca-nhan"><b>P13 cá nhân</b></label>
            <input type="text" id="p13-ca-nhan" readonly />
          </div>
          <div class="field" style="flex:1">
            <label for="he-so-thuong"><b>Hệ số tính thưởng</b></label>
            <input type="text" id="he-so-thuong" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1">
            <label for="mdrt-fyp"><b>∑ FYP DH MDRT</b></label>
            <input type="text" id="mdrt-fyp" readonly />
          </div>
          <div class="field" style="flex:1">
            <label for="tong-fyc"><b>∑ FYC T-1 và T-2</b></label>
            <input type="text" id="tong-fyc" readonly />
          </div>
          <div class="field" style="flex:1">
            <label for="tong-fyc-quy"><b>∑ FYC Quý hiện tại</b></label>
            <input type="text" id="tong-fyc-quy" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1">
            <label for="active-months"><b>Số tháng có hoạt động trong Quý</b></label>
            <input type="text" id="active-months" readonly />
          </div>
        </div>
      </section>

      <!-- 2) A.1 MỤC TIÊU THÁNG -->
      <section id="sec-muctieu" class="app-section" style="display:none">
        <div class="section-title">A.1 MỤC TIÊU THÁNG</div>
        <div class="top-fields" style="margin-bottom:10px">
          <div class="field">
            <label for="month-select"><b>Tháng dự tính</b></label>
            <select id="month-select"></select>
          </div>
        </div>

        <div id="memo-giai-doan">
          <div class="gd-stage">
            <b>Giai đoạn 1 (1-11/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd1"><b>FYP SP chính</b></label><input type="text" id="fypchinh-gd1"/></div>
              <div class="field"><label for="fypkem-gd1"><b>FYP SP gắn kèm</b></label><input type="text" id="fypkem-gd1"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd1"><b>Số HĐ</b></label><input type="text" id="sohd-gd1"/></div>
              <div class="field"><label for="fyp-gd1"><b>∑ FYP</b></label><input type="text" id="fyp-gd1" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd1"><b>Thưởng Memo Giai đoạn 1</b></label><input type="text" id="thuongmemo-gd1" readonly/><span id="alert-gd1" style="color:red;display:none"></span></div>
            </div>
          </div>

          <div class="gd-stage">
            <b>Giai đoạn 2 (12-25/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd2"><b>FYP SP chính</b></label><input type="text" id="fypchinh-gd2"/></div>
              <div class="field"><label for="fypkem-gd2"><b>FYP SP gắn kèm</b></label><input type="text" id="fypkem-gd2"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd2"><b>Số HĐ</b></label><input type="text" id="sohd-gd2"/></div>
              <div class="field"><label for="fyp-gd2"><b>∑ FYP</b></label><input type="text" id="fyp-gd2" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd2"><b>Thưởng Memo Giai đoạn 2</b></label><input type="text" id="thuongmemo-gd2" readonly/><span id="alert-gd2" style="color:red;display:none"></span></div>
            </div>
          </div>

          <div class="gd-stage">
            <b>Giai đoạn 3 (26-31/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd3"><b>FYP SP chính</b></label><input type="text" id="fypchinh-gd3"/></div>
              <div class="field"><label for="fypkem-gd3"><b>FYP SP gắn kèm</b></label><input type="text" id="fypkem-gd3"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd3"><b>Số HĐ</b></label><input type="text" id="sohd-gd3"/></div>
              <div class="field"><label for="fyp-gd3"><b>∑ FYP</b></label><input type="text" id="fyp-gd3" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd3"><b>Thưởng Memo Giai đoạn 3</b></label><input type="text" id="thuongmemo-gd3" readonly/><span id="alert-gd3" style="color:red;display:none"></span></div>
            </div>
          </div>

          <br/>
          <div>
            <b style="margin-left:var(--pad)">TỔNG HỢP</b>
            <div class="top-fields">
              <div class="field"><label for="tong-cc"><b>∑ Số lượng Hợp đồng</b></label><input type="text" id="tong-cc" readonly/></div>
              <div class="field"><label for="fyp-chinh"><b>∑ FYP SP chính</b></label><input type="text" id="fyp-chinh" readonly/></div>
              <div class="field"><label for="fyp-kem"><b>∑ FYP SP gắn kèm</b></label><input type="text" id="fyp-kem" readonly/></div>
            </div>
            <div class="top-fields" style="align-items:center">
              <div class="field" style="flex:3"><label for="tong-fyp"><b>∑ FYP Từ các HĐ</b></label><input type="text" id="tong-fyp" readonly/></div>
              <div class="field" style="flex:3;display:flex;align-items:flex-end">
                <div class="calc-wrap">
                  <button id="calc-btn" onclick="calculateIncome(); showSection('sec-khoanthu')">Tính thu nhập</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) A.2 CÁC KHOẢN THU NHẬP -->
      <section id="sec-khoanthu" class="app-section" style="display:none">
        <div class="section-title">A.2 CÁC KHOẢN THU NHẬP</div>
        <div class="top-fields">
          <div class="field"><label><b>FYC SP chính (30%)</b></label><input type="text" id="fyc-chinh" readonly/></div>
          <div class="field"><label><b>FYC SP gắn kèm (20%)</b></label><input type="text" id="fyc-kem" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><label><b>Thưởng thêm SP gắn kèm (20%)</b></label><input type="text" id="thuong-kem" readonly/></div>
          <div class="field"><label><b>FYC Tính chính sách</b></label><input type="text" id="fyc-thuong" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><label><b>Thưởng NSXS Manulife Pro</b></label><input type="text" id="thuong-nspro" readonly/></div>
          <div class="field"><label><b>Thưởng Năng suất hàng tháng</b></label><input type="text" id="thuong-nst" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><label><b>Thưởng Năng suất hàng Quý</b></label><input type="text" id="thuong-nsq" readonly/></div>
          <div class="field">
            <label><b>Thưởng Tiến độ MDRT</b></label>
            <input type="text" id="thuong-mdrt" readonly/>
            <span id="alert-mdrt" style="color:#d62929;display:none"></span>
          </div>
        </div>
        <div class="top-fields">
          <div class="field"><label for="thuong-memo" class="income-note"><b>0001M08/2025/ASBD</b></label><input type="text" id="thuong-memo" readonly/></div>
        </div>
      </section>

      <!-- 4) A.3 THU NHẬP BÁN HÀNG -->
      <section id="sec-ban-hang" class="app-section" style="display:none">
        <div class="section-title">A.3 THU NHẬP BÁN HÀNG</div>
        <div class="summary-row">
          <div class="summary-block"><label for="tong-thu-nhap">Tổng thu nhập bán hàng (A)</label><input type="text" id="tong-thu-nhap" readonly/></div>
          <div class="summary-block"><label for="ty-le-thu-nhap">Tỷ lệ thu nhập/doanh thu</label><input type="text" id="ty-le-thu-nhap" readonly/></div>
        </div>
        <hr><div class="section-title" style="position:static;border-left-color:#0d72b5">CHÚC BẠN SỞ HỮU TỐI ĐA THU NHẬP</div>
      </section>

      <!-- 5) B. TUYỂN DỤNG -->
      <section id="sec-tuyendung" class="app-section" style="display:none">
        <div class="section-title">B. THU NHẬP TỪ HOẠT ĐỘNG TUYỂN DỤNG</div>
        <div class="top-fields">
          <div class="field">
            <label><b>Thu nhập tuyển dụng (B)</b></label>
            <input type="text" id="thu-nhap-tuyen-dung" value="0" readonly />
          </div>
        </div>
        <div class="top-fields"><div class="field"><div style="color:#0ea35b;font-weight:900">Coming soon</div></div></div>
      </section>

      <!-- 6) C. QUẢN LÝ -->
      <section id="sec-quan-ly" class="app-section" style="display:none">
        <div class="section-title">C. THU NHẬP TỪ HOẠT ĐỘNG QUẢN LÝ</div>
        <div class="top-fields">
          <div class="field">
            <label><b>Thu nhập quản lý (C)</b></label>
            <input type="text" id="thu-nhap-quan-ly" value="0" readonly />
          </div>
        </div>
        <div class="top-fields"><div class="field"><div style="color:#0ea35b;font-weight:900">Coming soon</div></div></div>
      </section>

      <!-- 7) D. TỔNG THU NHẬP -->
      <section id="sec-tong" class="app-section" style="display:none">
        <div class="section-title">D. TỔNG THU NHẬP (A + B + C)</div>
        <div class="summary-row">
          <div class="summary-block"><label for="tong-A">A — Thu nhập bán hàng</label><input type="text" id="tong-A" readonly/></div>
          <div class="summary-block"><label for="tong-B">B — Thu nhập tuyển dụng</label><input type="text" id="tong-B" readonly/></div>
        </div>
        <div class="summary-row">
          <div class="summary-block"><label for="tong-C">C — Thu nhập quản lý</label><input type="text" id="tong-C" readonly/></div>
          <div class="summary-block"><label for="tong-ABC">D — TỔNG THU NHẬP (A + B + C)</label><input type="text" id="tong-ABC" readonly/></div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer id="pageFooter">
    <div>Bản quyền trang web thuộc về</div>
    <img src="/logo_textr.webp" alt="Logo" />
  </footer>

  <!-- ===== LOGIC (GIỮ NGUYÊN, CHỈ CHỈNH HÀNH VI CUỘN TRÊN MOBILE) ===== -->
  <script>
/* ===== GLOBAL VARS ===== */
let data=[],nspro=[],nst6=[],nst7=[],nsq6=[],nsq7=[],hsdt=[],trackingMDRT=[];
let isDataReady=false, isLoggedIn=false;

/* ===== MONEY HELPERS ===== */
const NF3=new Intl.NumberFormat('vi-VN',{minimumFractionDigits:3,maximumFractionDigits:3});
const formatMoney3=v=>Number.isFinite(+v)?NF3.format(+v):'';
function parseMoney3(s){ if(typeof s==='number')return s; if(!s)return 0; const n=parseFloat(String(s).replace(/\./g,'').replace(',','.')); return Number.isFinite(n)?n:0; }

/* ===== ID LISTS ===== */
const MONEY_INPUT_IDS_EDITABLE=['fypchinh-gd1','fypkem-gd1','fypchinh-gd2','fypkem-gd2','fypchinh-gd3','fypkem-gd3'];
const COUNT_INPUT_IDS_EDITABLE=['sohd-gd1','sohd-gd2','sohd-gd3'];
const MONEY_OUTPUT_IDS=['fyp-gd1','fyp-gd2','fyp-gd3','fyp-chinh','fyp-kem','tong-fyp','fyc-chinh','fyc-kem','thuong-kem','fyc-thuong','thuong-nspro','thuong-nst','thuong-nsq','thuong-mdrt','thuongmemo-gd1','thuongmemo-gd2','thuongmemo-gd3','thuong-memo','mdrt-fyp','tong-fyc','tong-fyc-quy','tong-thu-nhap'];
const ALL_MONEY_IDS=[...new Set([...MONEY_INPUT_IDS_EDITABLE,...MONEY_OUTPUT_IDS])];

/* ===== DATE/LOOKUP HELPERS ===== */
const rmAccent=s=>s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
function normKeyMap(o){const m={};for(const k of Object.keys(o))m[rmAccent(k).replace(/\s+/g,'').toUpperCase()]=k;return m;}
function getByKeyLoose(row,target){const map=normKeyMap(row);const w=rmAccent(target).replace(/\s+/g,'').toUpperCase();return map[w]?row[map[w]]:undefined;}
function eqAgent(a,b){const n=x=>(x??'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();return n(a)===n(b);}
function standardizeDate(input){let s=input.trim().replace(/[^0-9]/g,'');if(s.length!==8)return input;return [s.slice(0,2),s.slice(2,4),s.slice(4,8)].join('/');}
function normalizeDateForCompare(v){if(!v)return'';const s=String(v).trim();const d=s.replace(/[^0-9]/g,'');if(d.length===8){const dd=d.slice(0,2),mm=d.slice(2,4),yy=d.slice(4,8);return yy+mm+dd;}const p=s.split(/[^0-9]+/).filter(Boolean);if(p.length===3){let[dd,mm,yy]=p.map(String);if(yy.length===2)yy=(+yy>=70?'19':'20')+yy;if(dd.length===1)dd='0'+dd;if(mm.length===1)mm='0'+mm;return yy+mm+dd;}return'';}
const datesEqual=(a,b)=>normalizeDateForCompare(a)===normalizeDateForCompare(b);

/* ===== LOAD DATA ===== */
async function fetchFirstJson(list){for(const url of list){try{const r=await fetch(url,{cache:'no-store'});if(r.ok)return await r.json();}catch{}}return null;}
async function loadData(){
  const btn=document.querySelector('button[onclick="searchAgent()"]'); if(btn){btn.disabled=true;btn.textContent="Đang tải dữ liệu...";}
  try{const r=await fetch('/income.json',{cache:'no-store'}); if(!r.ok)throw new Error('HTTP '+r.status); data=await r.json();}catch(e){alert("Không tải được income.json."); data=[];}
  isDataReady=Array.isArray(data)&&data.length>0;
  nspro=await fetchFirstJson(['nspro.json','NSPRO.json','Nspro.json'])||[];
  nst6 =await fetchFirstJson(['6nst.json','6NST.json'])||[];
  nst7 =await fetchFirstJson(['7nst.json','7NST.json'])||[];
  nsq6 =await fetchFirstJson(['6NSQ.json','6nsq.json'])||[];
  nsq7 =await fetchFirstJson(['7NSQ.json','7nsq.json'])||[];
  hsdt =await fetchFirstJson(['hsdt.json','HSDT.json'])||[];
  trackingMDRT=await fetchFirstJson(['trackingmdrt.json','TRACKING MDRT.json','TRACKING%20MDRT.json'])||[];
  if(btn){btn.disabled=false;btn.textContent="Đăng nhập";}
}

/* ===== MONTH SELECT ===== */
function getCurrentMonth(){return new Date().getMonth()+1;}
function populateMonthSelect(){const sel=document.getElementById('month-select'); if(!sel)return; sel.innerHTML=''; const cur=getCurrentMonth(); for(let m=cur;m<=12;m++){const op=document.createElement('option');op.value=m;op.textContent=`Tháng ${m}`;sel.appendChild(op);}}

/* ===== THƯỞNG/MEMO/TỔNG HỢP ===== */
function getHeSoThuong(p13){const n=Number(p13);if(!isFinite(n))return 1;let best=1;for(const row of hsdt){const moc=row["P13 cá nhân"];const tl=row["TỶ LỆ"];if(moc===null){best=tl||best;continue}if(n>=Number(moc))best=Number(tl)||best}return best}
function optimizeMemo(fyp,ccLimit,m1,t1,m2,t2){const F=Math.max(0,+fyp||0);const limit=(ccLimit==null||ccLimit<=0)?Infinity:Math.max(0,Math.floor(ccLimit));let best=0,used=0;const max25=Math.floor(F/m1);const maxLoop=Math.min(max25,limit);for(let i=0;i<=maxLoop;i++){const rem=F-i*m1;const cap=(limit===Infinity)?Infinity:(limit-i);const j=Math.min(Math.floor(rem/m2),cap);const u=i+j;const r=i*t1+j*t2;if(r>best || (r===best && u<used)){best=r;used=u}}return{reward:best,used}}
function calcMemoStage(gd,sohd,tongFYP){let m1,t1,m2,t2;if(gd==='gd1'){m1=25000;t1=2500;m2=16000;t2=1500}else if(gd==='gd2'){m1=25000;t1=2000;m2=16000;t2=1000}else{m1=25000;t1=1500;m2=16000;t2=750}
  const optU=optimizeMemo(+tongFYP||0,Infinity,m1,t1,m2,t2);let res=optU,txt='';const cc=Math.max(0,+sohd||0);
  if(cc>0){if(cc<optU.used){res=optimizeMemo(+tongFYP||0,cc,m1,t1,m2,t2);txt=`Thưởng tối ưu từ ${optU.used} HĐ; bạn nhập ${cc} nên chỉ tính tối đa ${cc} HĐ.`}else if(cc>optU.used){txt=`Chỉ thưởng tối đa ${optU.used} hợp đồng!`}}
  document.getElementById('thuongmemo-'+gd).value=formatMoney3(res.reward);
  const el=document.getElementById('alert-'+gd); if(el){el.textContent=txt; el.style.display=txt?'block':'none'}
}
function updateTongHop(){
  const geti=id=>parseInt((document.getElementById(id).value||'').replace(/[^\d]/g,''),10)||0;
  const getn=id=>parseMoney3(document.getElementById(id).value);
  const cc1=geti('sohd-gd1'),cc2=geti('sohd-gd2'),cc3=geti('sohd-gd3');
  document.getElementById('tong-cc').value=cc1+cc2+cc3;
  const f1=getn('fypchinh-gd1'),f2=getn('fypchinh-gd2'),f3=getn('fypchinh-gd3');
  const k1=getn('fypkem-gd1'),k2=getn('fypkem-gd2'),k3=getn('fypkem-gd3');
  const sumC=f1+f2+f3, sumK=k1+k2+k3;
  document.getElementById('fyp-chinh').value=formatMoney3(sumC);
  document.getElementById('fyp-kem').value=formatMoney3(sumK);
  document.getElementById('fyp-gd1').value=formatMoney3(f1+k1);
  document.getElementById('fyp-gd2').value=formatMoney3(f2+k2);
  document.getElementById('fyp-gd3').value=formatMoney3(f3+k3);
  document.getElementById('tong-fyp').value=formatMoney3(sumC+sumK);
  calcMemoStage('gd1',cc1,f1+k1); calcMemoStage('gd2',cc2,f2+k2); calcMemoStage('gd3',cc3,f3+k3);
  const m1=parseMoney3(document.getElementById('thuongmemo-gd1').value);
  const m2=parseMoney3(document.getElementById('thuongmemo-gd2').value);
  const m3=parseMoney3(document.getElementById('thuongmemo-gd3').value);
  document.getElementById('thuong-memo').value=formatMoney3(m1+m2+m3);
}

/* ===== NS PRO / NST / NSQ / MDRT ===== */
function isProGroup(txt){return /manulife\s*pro/i.test(txt)||/\bpro\b/i.test(txt)}
function calculateNSPro(){
  const cc=parseInt(document.getElementById("tong-cc").value,10)||0;
  const tongFYP=parseMoney3(document.getElementById("tong-fyp").value);
  const nhom=(document.getElementById("nhom-dai-ly").value||'').trim(); const nA=rmAccent(nhom);
  if(!cc||!nspro.length||!tongFYP||!isProGroup(nA)){document.getElementById("thuong-nspro").value=formatMoney3(0);return}
  let base=0;
  for(const row of nspro){
    const need=parseMoney3(getByKeyLoose(row,"FYP của tháng xét thưởng"));
    if(tongFYP<need)continue;
    const keys=normKeyMap(row);
    let col=keys['MANULIFEPROBAC']||keys['MANULIFEPROVANG']||keys['MANULIFEPROBACHKIM'];
    if(/bach\s*kim/i.test(nA)) col=keys['MANULIFEPROBACHKIM'];
    else if(/vang/i.test(nA))  col=keys['MANULIFEPROVANG'];
    base=Math.max(base,parseMoney3(col?row[col]:0));
  }
  const heSo=parseFloat(document.getElementById("he-so-thuong").value)||1;
  document.getElementById("thuong-nspro").value=formatMoney3(base*heSo);
}
function calculateNST(){
  const th=parseInt(document.getElementById("thang-lam-viec").value,10)||0;
  const tongFYC=parseMoney3(document.getElementById("tong-fyc").value);
  const fycT=parseMoney3(document.getElementById("fyc-thuong").value);
  const sum=tongFYC+fycT;
  const table=th<=6?nst6:nst7; let rate=0;
  for(const row of table){const need=parseMoney3(getByKeyLoose(row,"FYC trong 3 tháng gần nhất")); const r=parseFloat(getByKeyLoose(row,"% Tỷ lệ thưởng năng suất tháng"))||0; if(sum>=need && r>=rate)rate=r;}
  const heSo=parseFloat(document.getElementById("he-so-thuong").value)||1;
  document.getElementById("thuong-nst").value=formatMoney3(fycT*rate*heSo);
}
function calculateNSQ(){
  const m=parseInt(document.getElementById("month-select").value,10)||0;
  if(![3,6,9,12].includes(m)){document.getElementById("thuong-nsq").value=formatMoney3(0);return}
  const th=parseInt(document.getElementById("thang-lam-viec").value,10)||0;
  const cur=parseMoney3(document.getElementById("tong-fyc-quy").value);
  const fycT=parseMoney3(document.getElementById("fyc-thuong").value);
  const sum=fycT+cur;
  const table=th<=6?nsq6:nsq7;
  const nh=(document.getElementById("nhom-dai-ly").value||"").trim(); const nA=rmAccent(nh);
  let tl=0;
  for(const row of table){
    const need=parseMoney3(getByKeyLoose(row,"FYC của quý xét thưởng"));
    if(sum>=need){
      const keys=normKeyMap(row);
      let val=(/manulife\s*pro/i.test(nA) || /manulife$/i.test(nA)) ? row[keys['MANULIFE']] : (row[keys['DLTHUONG']]||row[keys['DAILY']]);
      if(typeof val==='string') val=val.replace('%','');
      const r=(parseFloat(val)||0)/100;
      if(r>=tl) tl=r;
    }
  }
  const heSo=parseFloat(document.getElementById("he-so-thuong").value)||1;
  document.getElementById("thuong-nsq").value=formatMoney3(sum*tl*heSo);
}
function calculateThuongMDRT(){
  const alertEl=document.getElementById('alert-mdrt');
  const setAlert=msg=>{ if(alertEl){ alertEl.textContent=msg||''; alertEl.style.display=msg?'block':'none'; } };

  const m=parseInt(document.getElementById("month-select").value,10)||0;
  if(![3,6,9,12].includes(m)){ document.getElementById("thuong-mdrt").value=formatMoney3(0); setAlert(''); return; }

  const activeMonths=parseInt((document.getElementById("active-months").value||'').replace(/[^\d]/g,''),10)||0;
  const currentCC=parseInt((document.getElementById("tong-cc").value||'').replace(/[^\d]/g,''),10)||0;

  if(activeMonths < 2){ document.getElementById("thuong-mdrt").value = formatMoney3(0); setAlert('Không đủ tiêu chuẩn nhận thưởng tiến độ'); return; }
  if(currentCC < 1){ document.getElementById("thuong-mdrt").value = formatMoney3(0); setAlert('Chưa có hợp đồng trong tháng xét'); return; }
  setAlert('');

  const toDate=parseMoney3(document.getElementById("mdrt-fyp").value);
  const thisM=parseMoney3(document.getElementById("tong-fyp").value);
  const progress=toDate+thisM;
  const row=trackingMDRT.find(r=>parseInt(getByKeyLoose(r,'Tháng xét'),10)===m);
  if(!row){ document.getElementById("thuong-mdrt").value=formatMoney3(0); return; }
  const need=parseMoney3(getByKeyLoose(row,'FYP YÊU CẦU'));
  const muc1=parseMoney3(getByKeyLoose(row,'MỨC 1 THẤP'))||parseMoney3(getByKeyLoose(row,'MÚC 1 THẤP'))||parseMoney3(getByKeyLoose(row,'MUC 1 THAP'))||0;
  const muc2=parseMoney3(getByKeyLoose(row,'MỨC 2 CAO'))||parseMoney3(getByKeyLoose(row,'MUC 2 CAO'))||0;
  let thuong=0; if(need>0 && progress>0){const tl=progress/need; if(tl>=1)thuong=muc2; else if(tl>=0.9)thuong=muc1;}
  document.getElementById("thuong-mdrt").value = formatMoney3(thuong);
}

/* ===== TOTAL (A) & D (A+B+C) ===== */
function calculateTongThuNhap(){
  const v=id=>parseMoney3(document.getElementById(id).value);
  const sum=v("fyc-chinh")+v("fyc-kem")+v("thuong-kem")+v("fyc-thuong")+v("thuong-nspro")+v("thuong-nst")+v("thuong-nsq")+v("thuong-memo")+v("thuong-mdrt");
  document.getElementById("tong-thu-nhap").value=formatMoney3(sum);
  const tongFYP=parseMoney3(document.getElementById("tong-fyp").value);
  document.getElementById("ty-le-thu-nhap").value=tongFYP>0?((sum/tongFYP)*100).toFixed(2)+" %":"";
  updateCombinedTotals(); reformatMoneyOutputs(); syncReadonlyTitles();
}
function updateCombinedTotals(){
  const A = parseMoney3(document.getElementById("tong-thu-nhap").value);
  const B = parseMoney3(document.getElementById("thu-nhap-tuyen-dung")?document.getElementById("thu-nhap-tuyen-dung").value:0);
  const C = parseMoney3(document.getElementById("thu-nhap-quan-ly")?document.getElementById("thu-nhap-quan-ly").value:0);
  const elA=document.getElementById("tong-A"); if(elA) elA.value=formatMoney3(A);
  const elB=document.getElementById("tong-B"); if(elB) elB.value=formatMoney3(B);
  const elC=document.getElementById("tong-C"); if(elC) elC.value=formatMoney3(C);
  const elABC=document.getElementById("tong-ABC"); if(elABC) elABC.value=formatMoney3(A+B+C);
}

/* ===== INPUT MODES ===== */
function autoFormatInputs(){
  MONEY_INPUT_IDS_EDITABLE.forEach(id=>{const el=document.getElementById(id); if(!el)return;
    el.addEventListener('input',()=>{el.value=el.value.replace(/[^\d\.,]/g,'')});
    el.addEventListener('blur',()=>{const n=parseMoney3(el.value); el.value=n?formatMoney3(n):''; updateTongHop(); calculateIncome();});
  });
  COUNT_INPUT_IDS_EDITABLE.forEach(id=>{const el=document.getElementById(id); if(!el)return;
    el.addEventListener('input',()=>{el.value=el.value.replace(/[^\d]/g,'')});
    el.addEventListener('blur',()=>{el.value=el.value?String(parseInt(el.value,10)):''; updateTongHop(); calculateIncome();});
  });
}
function sanitizeAllNumericInputs(){ALL_MONEY_IDS.forEach(id=>{const el=document.getElementById(id); if(el)el.setAttribute('type','text')});}
function reformatMoneyOutputs(){for(const id of MONEY_OUTPUT_IDS){const el=document.getElementById(id); if(!el)continue; const n=parseMoney3(el.value); el.value=formatMoney3(n||0)}}
function syncReadonlyTitles(){document.querySelectorAll('input[readonly]').forEach(el=>el.title=el.value||'');}

/* ===== NAV + SECTION HIỂN THỊ ===== */
function getOffsets(){
  const head=document.getElementById('pageHeader');
  const toc=document.getElementById('tocMobile');
  const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
  let t = 0;
  if(toc && getComputedStyle(toc).display!=='none'){
    t = Math.ceil(toc.getBoundingClientRect().height);
  }
  return {h,t};
}
function showSection(id){
  // 1) Ẩn/hiện section
  document.querySelectorAll('.app-section').forEach(s=>s.style.display='none');
  const target=document.getElementById(id);
  if(target) target.style.display='block';

  // 2) Active trên sidebar (desktop)
  document.querySelectorAll('#sidebar .menu-item').forEach(a=>a.classList.remove('active'));
  const a=document.querySelector(`#sidebar .menu-item[data-target="${id}"]`); if(a) a.classList.add('active');

  // 3) Đồng bộ dropdown mobile
  const sel=document.getElementById('tocSelect');
  if(sel){ for(const o of sel.options){ if(o.value===id){ sel.value=id; break; } } }

  // 4) Cập nhật chiều cao header/toc để tính offset
  setLayoutVars();

  // 5) CUỘN: luôn đưa đầu mục lên ngay dưới header + dropdown (trên điện thoại)
  if(target){
    const {h,t}=getOffsets();
    const offset=h + t + 6; // 6px đệm
    const y = target.getBoundingClientRect().top + window.scrollY - offset;
    window.scrollTo({ top: Math.max(0,y), behavior:'smooth' });
  }
}
function bindSidebar(){
  document.querySelectorAll('#sidebar .menu-item[data-target]').forEach(a=>{
    a.addEventListener('click',e=>{e.preventDefault(); const id=a.getAttribute('data-target'); if(id) showSection(id);});
  });
}
function buildMobileTOC(){
  const sel=document.getElementById('tocSelect'); if(!sel) return;
  sel.innerHTML='';
  document.querySelectorAll('#sidebar .menu-item[data-target]').forEach(a=>{
    const id=a.getAttribute('data-target'), text=a.textContent.trim();
    const op=document.createElement('option'); op.value=id; op.textContent=text; sel.appendChild(op);
  });
  sel.addEventListener('change',()=>{ showSection(sel.value); });
}

/* ===== SEARCH / LOGIN ===== */
function searchAgent(){
  const idRaw=(document.getElementById("agent-id").value||'').trim();
  const ngayRaw=(document.getElementById("ngay-gia-nhap").value||'').trim();
  if(!isDataReady){alert("Không tải được dữ liệu (income.json).");return}
  if(!idRaw){alert("Vui lòng nhập Mã số đại lý");return}
  if(!ngayRaw){alert("Vui lòng nhập Ngày gia nhập");return}
  const ngayKey=normalizeDateForCompare(ngayRaw); if(!ngayKey){alert("Ngày gia nhập không hợp lệ.");return}
  if(/^\d{8}$/.test(ngayRaw)){const d=ngayRaw.slice(0,2),m=ngayRaw.slice(2,4),y=ngayRaw.slice(4,8); document.getElementById("ngay-gia-nhap").value=`${d}/${m}/${y}`;}
  const same=data.filter(r=>eqAgent(getByKeyLoose(r,"Mã Đại lý"), idRaw));
  const found=same.find(r=>datesEqual(getByKeyLoose(r,"Ngày gia nhập"), ngayRaw));
  if(!found){alert("Đại lý không thuộc hệ thống");return}

  document.getElementById("ho-ten").value=getByKeyLoose(found,"Tên Đại lý")||'';
  document.getElementById("khu-vuc").value=getByKeyLoose(found,"Khu vực")||'';
  document.getElementById("thang-lam-viec").value=Number(getByKeyLoose(found,"Số tháng làm việc")||0);
  document.getElementById("nhom-dai-ly").value=getByKeyLoose(found,"Nhóm Đại lý")||'';
  const p13=parseMoney3(getByKeyLoose(found,"TLDTHD cá nhân") ?? getByKeyLoose(found,"P13 cá nhân"));
  document.getElementById("p13-ca-nhan").value=Number.isFinite(p13)&&p13!==0?p13:'';
  document.getElementById("he-so-thuong").value=getHeSoThuong(p13);
  document.getElementById("mdrt-fyp").value=formatMoney3(parseMoney3(getByKeyLoose(found,"MDRT-FYP tới hiện tại")));
  const fycT1=parseMoney3(getByKeyLoose(found,"FYC tháng T-1"));
  const fycT2=parseMoney3(getByKeyLoose(found,"FYC tháng T-2"));
  document.getElementById("tong-fyc").value=formatMoney3(fycT1+fycT2);
  document.getElementById("tong-fyc-quy").value=formatMoney3(parseMoney3(getByKeyLoose(found,"Tổng FYC trong Qúy hiện tại")));
  document.getElementById("active-months").value=String(getByKeyLoose(found,"Active months")||'').toString().trim();

  ["sohd-gd1","sohd-gd2","sohd-gd3","fypchinh-gd1","fypchinh-gd2","fypchinh-gd3","fypkem-gd1","fypkem-gd2","fypkem-gd3"].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  sanitizeAllNumericInputs(); updateTongHop(); calculateNSPro(); calculateNST(); calculateNSQ(); calculateThuongMDRT(); calculateTongThuNhap();
  syncReadonlyTitles();

  isLoggedIn=true;
  // Bật giao diện sau đăng nhập
  document.body.classList.remove('logged-out');
  document.body.classList.add('logged-in');
  applySidebarMode(); // chỉ bật sidebar trên desktop
  buildMobileTOC();
  showSection('sec-daily');
  setLayoutVars();          // cập nhật header/toc/footer height để đẩy nội dung xuống dưới đúng chuẩn
}

/* ===== ENTER TO CALC ===== */
function enableEnterToCalc(){
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    if(!isLoggedIn) return;
    const ae=document.activeElement;
    if(ae && (ae.id==='agent-id' || ae.id==='ngay-gia-nhap')) return;
    e.preventDefault();
    const btn=document.getElementById('calc-btn');
    if(btn) btn.click();
  });
}

/* ===== LAYOUT VARS ===== */
function setLayoutVars(){
  const head=document.getElementById('pageHeader');
  const footer=document.getElementById('pageFooter');
  const toc=document.getElementById('tocMobile');
  const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
  const f = footer ? Math.ceil(footer.getBoundingClientRect().height) : 66;
  let t = 0;
  if(toc && getComputedStyle(toc).display!=='none'){
    t = Math.ceil(toc.getBoundingClientRect().height);
  }
  document.documentElement.style.setProperty('--header-h', h+'px');
  document.documentElement.style.setProperty('--footer-h', f+'px');
  document.documentElement.style.setProperty('--toc-h', t+'px');
}
function applySidebarMode(){
  if(!document.body.classList.contains('logged-in')) return;
  if(window.matchMedia('(min-width:1024px)').matches){
    document.body.classList.add('sidebar-open');
  }else{
    document.body.classList.remove('sidebar-open');
  }
}

/* ===== GỘP TÍNH THU NHẬP ===== */
function calculateIncome(){
  const tongFYP=parseMoney3(document.getElementById('tong-fyp').value);
  const chinh=parseMoney3(document.getElementById('fyp-chinh').value);
  const kem=parseMoney3(document.getElementById('fyp-kem').value);

  const fycChinh=chinh*0.3;
  const fycKem=kem*0.2;
  const thuongKem=kem*0.2;
  const fycThuong=fycChinh+fycKem+thuongKem;

  document.getElementById('fyc-chinh').value=formatMoney3(fycChinh);
  document.getElementById('fyc-kem').value=formatMoney3(fycKem);
  document.getElementById('thuong-kem').value=formatMoney3(thuongKem);
  document.getElementById('fyc-thuong').value=formatMoney3(fycThuong);

  calculateNSPro();
  calculateNST();
  calculateNSQ();
  calculateThuongMDRT();
  calculateTongThuNhap();
}

/* ===== INIT ===== */
window.addEventListener('load', async ()=>{
  await loadData();
  populateMonthSelect(); sanitizeAllNumericInputs(); autoFormatInputs();
  enableEnterToCalc(); setLayoutVars(); applySidebarMode();
  window.addEventListener('resize', ()=>{ setLayoutVars(); applySidebarMode(); });

  // Chuẩn hoá nhập ngày
  const ngay=document.getElementById("ngay-gia-nhap");
  if(ngay){
    ngay.addEventListener('blur',()=>{const v=ngay.value.trim(); if(/^\d{8}$/.test(v)) ngay.value=standardizeDate(v);});
    document.getElementById("agent-id").addEventListener("keydown",e=>{if(e.key==="Enter")searchAgent()});
    ngay.addEventListener("keydown",e=>{if(e.key==="Enter")searchAgent()});
  }

  // Sidebar click
  bindSidebar();

  // Mặc định ẩn tất cả section khi chưa login
  document.querySelectorAll('.app-section').forEach(s=>s.style.display='none');
});
  </script>
</body>
</html>
